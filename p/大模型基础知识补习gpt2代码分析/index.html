<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="ÂÆûÊìç‰∏Ä‰∏ãGPT2ÁöÑ‰ª£Á†ÅÔºåÊ∑±ÂàªÁêÜËß£transformerÊ®°ÂûãÁöÑÁªìÊûÑ">
<title>Â§ßÊ®°ÂûãÂü∫Á°ÄÁü•ËØÜË°•‰π†&amp;GPT2‰ª£Á†ÅÂàÜÊûê</title>

<link rel='canonical' href='https://JiangZhiyu-1024.github.io/p/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%A1%A5%E4%B9%A0gpt2%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/'>

<link rel="stylesheet" href="/scss/style.min.819ac8ff77246a79c226a136382b6bcbe7c291f9fd1e0641c81bcb97ac7e8f89.css"><meta property='og:title' content="Â§ßÊ®°ÂûãÂü∫Á°ÄÁü•ËØÜË°•‰π†&GPT2‰ª£Á†ÅÂàÜÊûê">
<meta property='og:description' content="ÂÆûÊìç‰∏Ä‰∏ãGPT2ÁöÑ‰ª£Á†ÅÔºåÊ∑±ÂàªÁêÜËß£transformerÊ®°ÂûãÁöÑÁªìÊûÑ">
<meta property='og:url' content='https://JiangZhiyu-1024.github.io/p/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%A1%A5%E4%B9%A0gpt2%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/'>
<meta property='og:site_name' content='Zion Blaze'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-01-10T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-01-10T00:00:00&#43;00:00'/><meta property='og:image' content='https://JiangZhiyu-1024.github.io/p/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%A1%A5%E4%B9%A0gpt2%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/tree-838666_1280.jpg' />
<meta name="twitter:title" content="Â§ßÊ®°ÂûãÂü∫Á°ÄÁü•ËØÜË°•‰π†&GPT2‰ª£Á†ÅÂàÜÊûê">
<meta name="twitter:description" content="ÂÆûÊìç‰∏Ä‰∏ãGPT2ÁöÑ‰ª£Á†ÅÔºåÊ∑±ÂàªÁêÜËß£transformerÊ®°ÂûãÁöÑÁªìÊûÑ"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://JiangZhiyu-1024.github.io/p/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%A1%A5%E4%B9%A0gpt2%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/tree-838666_1280.jpg' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/fireflies1_hu11714070595552142014.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Zion Blaze</a></h1>
            <h2 class="site-description">Welcome to my world!</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>ÂΩíÊ°£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>ÊêúÁ¥¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>ÂèãÊÉÖÈìæÊé•</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>ÊöóËâ≤Ê®°Âºè</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#model">model</a>
      <ol>
        <li><a href="#ËØçÊ±áË°®">ËØçÊ±áË°®</a>
          <ol>
            <li><a href="#ËØçÊ±áË°®ÁöÑ‰ΩúÁî®">ËØçÊ±áË°®ÁöÑ‰ΩúÁî®Ôºö</a></li>
            <li><a href="#ËØçÊ±áË°®ÁöÑÁªÑÊàê">ËØçÊ±áË°®ÁöÑÁªÑÊàêÔºö</a></li>
          </ol>
        </li>
        <li><a href="#ÂêëÈáèÁ©∫Èó¥vector-space">ÂêëÈáèÁ©∫Èó¥ÔºàVector SpaceÔºâ</a></li>
        <li><a href="#ÂµåÂÖ•embedding">ÂµåÂÖ•ÔºàEmbeddingÔºâ</a></li>
        <li><a href="#ÂêëÈáèvector">ÂêëÈáèÔºàVectorÔºâ</a></li>
        <li><a href="#‰∏∫‰ªÄ‰πàË¶Å‰ΩøÁî®ÂµåÂÖ•">‰∏∫‰ªÄ‰πàË¶Å‰ΩøÁî®ÂµåÂÖ•Ôºü</a></li>
        <li><a href="#ÂΩí‰∏ÄÂåñÊ≠•È™§">ÂΩí‰∏ÄÂåñÊ≠•È™§Ôºö</a></li>
        <li><a href="#‰ª£Á†ÅËß£Èáä">‰ª£Á†ÅËß£ÈáäÔºö</a></li>
        <li><a href="#ÊÄªÁªì">ÊÄªÁªìÔºö</a></li>
        <li><a href="#‰∏ªË¶ÅÁâπÁÇπ">‰∏ªË¶ÅÁâπÁÇπÔºö</a></li>
        <li><a href="#ÂáΩÊï∞Á≠æÂêç">ÂáΩÊï∞Á≠æÂêç</a>
          <ol>
            <li><a href="#ÂèÇÊï∞">ÂèÇÊï∞Ôºö</a></li>
            <li><a href="#ËøîÂõûÂÄº">ËøîÂõûÂÄºÔºö</a></li>
          </ol>
        </li>
        <li><a href="#Ê®°ÂûãÂÆûÁé∞">Ê®°ÂûãÂÆûÁé∞</a>
          <ol>
            <li><a href="#1-ÂÆö‰πâÂèòÈáè‰ΩúÁî®Âüü">1. ÂÆö‰πâÂèòÈáè‰ΩúÁî®Âüü</a></li>
            <li><a href="#2-ÂàùÂßãÂåñÂèòÈáè">2. ÂàùÂßãÂåñÂèòÈáè</a></li>
            <li><a href="#3-ÂÆö‰πâÂµåÂÖ•Áü©Èòµ">3. ÂÆö‰πâÂµåÂÖ•Áü©Èòµ</a></li>
            <li><a href="#4-ËÆ°ÁÆó‰ΩçÁΩÆÂÅèÁßª">4. ËÆ°ÁÆó‰ΩçÁΩÆÂÅèÁßª</a></li>
            <li><a href="#5-transformer-Â±ÇÁöÑÂâçÂêëËÆ°ÁÆó">5. Transformer Â±ÇÁöÑÂâçÂêëËÆ°ÁÆó</a></li>
            <li><a href="#6-ËæìÂá∫Â±ÇÂΩí‰∏ÄÂåñ">6. ËæìÂá∫Â±ÇÂΩí‰∏ÄÂåñ</a></li>
            <li><a href="#7-ËæìÂá∫Â±ÇËÆ°ÁÆó">7. ËæìÂá∫Â±ÇËÆ°ÁÆó</a></li>
          </ol>
        </li>
        <li><a href="#ÊÄªÁªì-1">ÊÄªÁªì</a></li>
      </ol>
    </li>
    <li><a href="#encoder">encoder</a>
      <ol>
        <li><a href="#def-bytes_to_unicode-‰∏ªË¶ÅÂäüËÉΩ">def bytes_to_unicode() <strong>‰∏ªË¶ÅÂäüËÉΩ</strong></a></li>
        <li><a href="#def-get_pairsword‰∏ªË¶ÅÂäüËÉΩ">def get_pairs(word):<strong>‰∏ªË¶ÅÂäüËÉΩ</strong></a>
          <ol>
            <li><a href="#bpe-ÁöÑÊù•Ê∫ê"><strong>BPE ÁöÑÊù•Ê∫ê</strong></a></li>
            <li><a href="#bpe-ÁöÑÂü∫Êú¨ÊÄùÊÉ≥"><strong>BPE ÁöÑÂü∫Êú¨ÊÄùÊÉ≥</strong></a></li>
            <li><a href="#bpe-ÁöÑ‰ºòÁÇπ"><strong>BPE ÁöÑ‰ºòÁÇπ</strong></a></li>
            <li><a href="#bpe-ÁöÑÁ§∫‰æã"><strong>BPE ÁöÑÁ§∫‰æã</strong></a></li>
            <li><a href="#ÂÆûÈôÖÁî®ÈÄî"><strong>ÂÆûÈôÖÁî®ÈÄî</strong></a></li>
          </ol>
        </li>
        <li><a href="#class-encoder">class Encoder:</a>
          <ol>
            <li><a href="#1-__init__-ÊñπÊ≥ïÂàùÂßãÂåñ"><strong>1. <code>__init__</code> ÊñπÊ≥ïÔºöÂàùÂßãÂåñ</strong></a></li>
            <li><a href="#2-bpe-ÊñπÊ≥ïÊ†∏ÂøÉÁöÑ-bpe-ÂàÜËØçÈÄªËæë"><strong>2. <code>bpe</code> ÊñπÊ≥ïÔºöÊ†∏ÂøÉÁöÑ BPE ÂàÜËØçÈÄªËæë</strong></a></li>
            <li><a href="#3-encode-ÊñπÊ≥ïÊñáÊú¨ÂàÜËØç"><strong>3. <code>encode</code> ÊñπÊ≥ïÔºöÊñáÊú¨ÂàÜËØç</strong></a></li>
            <li><a href="#4-decode-ÊñπÊ≥ïid-Ëß£Á†Å"><strong>4. <code>decode</code> ÊñπÊ≥ïÔºöID Ëß£Á†Å</strong></a></li>
          </ol>
        </li>
        <li><a href="#def-get_encodermodel_name-models_dir">def get_encoder(model_name, models_dir)</a>
          <ol>
            <li><a href="#1-ÂáΩÊï∞Á≠æÂêç"><strong>1. ÂáΩÊï∞Á≠æÂêç</strong></a></li>
            <li><a href="#2-Âä†ËΩΩ-encoderjson-Êñá‰ª∂"><strong>2. Âä†ËΩΩ <code>encoder.json</code> Êñá‰ª∂</strong></a></li>
            <li><a href="#3-Âä†ËΩΩ-vocabbpe-Êñá‰ª∂"><strong>3. Âä†ËΩΩ <code>vocab.bpe</code> Êñá‰ª∂</strong></a></li>
            <li><a href="#4-ÊèêÂèñÂêàÂπ∂ËßÑÂàô"><strong>4. ÊèêÂèñÂêàÂπ∂ËßÑÂàô</strong></a></li>
            <li><a href="#5-ÂàõÂª∫-encoder-ÂÆû‰æã"><strong>5. ÂàõÂª∫ <code>Encoder</code> ÂÆû‰æã</strong></a></li>
            <li><a href="#‰ª£Á†ÅÊï¥‰Ωì‰ΩúÁî®ÊÄªÁªì"><strong>‰ª£Á†ÅÊï¥‰Ωì‰ΩúÁî®ÊÄªÁªì</strong></a></li>
            <li><a href="#Â∫îÁî®Âú∫ÊôØ"><strong>Â∫îÁî®Âú∫ÊôØ</strong></a></li>
            <li><a href="#Á§∫‰æãË∞ÉÁî®"><strong>Á§∫‰æãË∞ÉÁî®</strong></a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#sample">sample</a>
      <ol>
        <li>
          <ol>
            <li><a href="#1-ÂáΩÊï∞Á≠æÂêç-1"><strong>1. ÂáΩÊï∞Á≠æÂêç</strong></a></li>
            <li><a href="#2-ÁâπÊÆäÊÉÖÂÜµk0"><strong>2. ÁâπÊÆäÊÉÖÂÜµÔºök=0</strong></a></li>
            <li><a href="#3-ÂÜÖÈÉ®ÂáΩÊï∞-_top_k"><strong>3. ÂÜÖÈÉ®ÂáΩÊï∞ <code>_top_k</code></strong></a></li>
            <li><a href="#step-1-Ëé∑Âèñ-top-k-ÂÄôÈÄâÈ°πÁöÑÂàÜÊï∞"><strong>Step 1: Ëé∑Âèñ Top-K ÂÄôÈÄâÈ°πÁöÑÂàÜÊï∞</strong></a></li>
            <li><a href="#step-2-Â±èËîΩ‰Ωé‰∫é-top-k-ÁöÑÂàÜÊï∞"><strong>Step 2: Â±èËîΩ‰Ωé‰∫é Top-K ÁöÑÂàÜÊï∞</strong></a></li>
            <li><a href="#4-Êù°‰ª∂ÊâßË°å"><strong>4. Êù°‰ª∂ÊâßË°å</strong></a></li>
            <li><a href="#5-Â∑•‰ΩúÂéüÁêÜÊÄªÁªì"><strong>5. Â∑•‰ΩúÂéüÁêÜÊÄªÁªì</strong></a></li>
            <li><a href="#‰ª£Á†ÅËøêË°åÁ§∫‰æã"><strong>‰ª£Á†ÅËøêË°åÁ§∫‰æã</strong></a></li>
            <li><a href="#Â∫îÁî®Âú∫ÊôØ-1"><strong>Â∫îÁî®Âú∫ÊôØ</strong></a></li>
            <li><a href="#1-ÂáΩÊï∞Á≠æÂêç-2"><strong>1. ÂáΩÊï∞Á≠æÂêç</strong></a></li>
            <li><a href="#2-Ëé∑ÂèñËæìÂÖ•Áª¥Â∫¶"><strong>2. Ëé∑ÂèñËæìÂÖ•Áª¥Â∫¶</strong></a></li>
            <li><a href="#3-ÂØπ-logits-ÊåâÂàÜÊï∞ÈôçÂ∫èÊéíÂ∫è"><strong>3. ÂØπ logits ÊåâÂàÜÊï∞ÈôçÂ∫èÊéíÂ∫è</strong></a></li>
            <li><a href="#4-ËÆ°ÁÆóÁ¥ØÁßØÊ¶ÇÁéá"><strong>4. ËÆ°ÁÆóÁ¥ØÁßØÊ¶ÇÁéá</strong></a></li>
            <li><a href="#5-ÊâæÂà∞Ë∂ÖËøáÈòàÂÄº-p-ÁöÑÊúÄÂ∞èÁ¥¢Âºï"><strong>5. ÊâæÂà∞Ë∂ÖËøáÈòàÂÄº <code>p</code> ÁöÑÊúÄÂ∞èÁ¥¢Âºï</strong></a></li>
            <li><a href="#ÂàÜÊ≠•Ëß£Èáä"><strong>ÂàÜÊ≠•Ëß£Èáä</strong>Ôºö</a></li>
            <li><a href="#6-ÊâæÂà∞Á¥ØÁßØÊ¶ÇÁéáÈòàÂÄºÂØπÂ∫îÁöÑÊúÄÂ∞èÂàÜÊï∞"><strong>6. ÊâæÂà∞Á¥ØÁßØÊ¶ÇÁéáÈòàÂÄºÂØπÂ∫îÁöÑÊúÄÂ∞èÂàÜÊï∞</strong></a></li>
            <li><a href="#7-Â±èËîΩÂàÜÊï∞‰Ωé‰∫éÈòàÂÄºÁöÑ-logits"><strong>7. Â±èËîΩÂàÜÊï∞‰Ωé‰∫éÈòàÂÄºÁöÑ logits</strong></a></li>
            <li><a href="#‰ª£Á†ÅÊÄªÁªì"><strong>‰ª£Á†ÅÊÄªÁªì</strong></a></li>
            <li><a href="#‰ª£Á†ÅËøêË°åÁ§∫‰æã-1"><strong>‰ª£Á†ÅËøêË°åÁ§∫‰æã</strong></a></li>
            <li><a href="#ÊâßË°åËøáÁ®ã"><strong>ÊâßË°åËøáÁ®ã</strong>Ôºö</a></li>
            <li><a href="#Â∫îÁî®Âú∫ÊôØ-2"><strong>Â∫îÁî®Âú∫ÊôØ</strong></a></li>
          </ol>
        </li>
        <li><a href="#def-sample_sequence">def sample_sequence</a>
          <ol>
            <li><a href="#1-ÂáΩÊï∞Á≠æÂêçÂíåËæìÂÖ•ÂèÇÊï∞"><strong>1. ÂáΩÊï∞Á≠æÂêçÂíåËæìÂÖ•ÂèÇÊï∞</strong></a></li>
            <li><a href="#2-ÂèÇÊï∞È™åËØÅÂíåÂàùÂßã‰∏ä‰∏ãÊñáËÆæÁΩÆ"><strong>2. ÂèÇÊï∞È™åËØÅÂíåÂàùÂßã‰∏ä‰∏ãÊñáËÆæÁΩÆ</strong></a></li>
            <li><a href="#3-ÂÆö‰πâÁîüÊàêÂçïÊ≠•ÁöÑÂáΩÊï∞-step"><strong>3. ÂÆö‰πâÁîüÊàêÂçïÊ≠•ÁöÑÂáΩÊï∞ <code>step</code></strong></a></li>
            <li><a href="#4-ÂÆö‰πâÁîüÊàêÂæ™ÁéØÁöÑ-body-ÂáΩÊï∞"><strong>4. ÂÆö‰πâÁîüÊàêÂæ™ÁéØÁöÑ <code>body</code> ÂáΩÊï∞</strong></a></li>
            <li><a href="#5-ÂàùÂßãÂåñÁ¨¨‰∏ÄÊ≠•"><strong>5. ÂàùÂßãÂåñÁ¨¨‰∏ÄÊ≠•</strong></a></li>
            <li><a href="#6-ÂÆö‰πâÂæ™ÁéØÊù°‰ª∂Âíå‰∏ª‰Ωì"><strong>6. ÂÆö‰πâÂæ™ÁéØÊù°‰ª∂Âíå‰∏ª‰Ωì</strong></a></li>
            <li><a href="#7-ËøîÂõûÁîüÊàêÁöÑÂ∫èÂàó"><strong>7. ËøîÂõûÁîüÊàêÁöÑÂ∫èÂàó</strong></a></li>
            <li><a href="#Â∑•‰ΩúÊµÅÁ®ãÊÄªÁªì"><strong>Â∑•‰ΩúÊµÅÁ®ãÊÄªÁªì</strong></a></li>
            <li><a href="#Â∫îÁî®Âú∫ÊôØ-3"><strong>Â∫îÁî®Âú∫ÊôØ</strong></a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#generate_unconditional_samples">generate_unconditional_samples</a>
      <ol>
        <li><a href="#1-Â§¥ÈÉ®‰ª£Á†Å">1. <strong>Â§¥ÈÉ®‰ª£Á†Å</strong></a></li>
        <li><a href="#2-ÂºïÂÖ•‰æùËµñÂ∫ì">2. <strong>ÂºïÂÖ•‰æùËµñÂ∫ì</strong></a></li>
        <li><a href="#3-sample_model-ÂáΩÊï∞">3. <strong><code>sample_model</code> ÂáΩÊï∞</strong></a>
          <ol>
            <li><a href="#ÂèÇÊï∞ËØ¥Êòé"><strong>ÂèÇÊï∞ËØ¥Êòé</strong></a></li>
          </ol>
        </li>
        <li><a href="#4-‰∏ªÂáΩÊï∞">4. <strong>‰∏ªÂáΩÊï∞</strong></a>
          <ol>
            <li><a href="#ËøêË°åÊñπÂºè"><strong>ËøêË°åÊñπÂºè</strong></a></li>
            <li><a href="#Ê†∏ÂøÉÊ®°Âùó"><strong>Ê†∏ÂøÉÊ®°Âùó</strong></a></li>
            <li><a href="#ÊÄªÁªì-2"><strong>ÊÄªÁªì</strong></a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#interactive_conditional_samples">interactive_conditional_samples</a>
      <ol>
        <li><a href="#1-Â§¥ÈÉ®ÈÉ®ÂàÜ"><strong>1. Â§¥ÈÉ®ÈÉ®ÂàÜ</strong></a></li>
        <li><a href="#2-interact_model-ÂáΩÊï∞"><strong>2. <code>interact_model</code> ÂáΩÊï∞</strong></a></li>
        <li><a href="#3-Ê†∏ÂøÉÈÄªËæë"><strong>3. Ê†∏ÂøÉÈÄªËæë</strong></a></li>
        <li><a href="#6-‰∏ªÂáΩÊï∞ÈÉ®ÂàÜ"><strong>6. ‰∏ªÂáΩÊï∞ÈÉ®ÂàÜ</strong></a>
          <ol>
            <li><a href="#ËøêË°åÊñπÂºè-1"><strong>ËøêË°åÊñπÂºè</strong></a></li>
          </ol>
        </li>
        <li><a href="#ÊÄªÁªì-3"><strong>ÊÄªÁªì</strong></a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%A1%A5%E4%B9%A0gpt2%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">
                <img src="/p/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%A1%A5%E4%B9%A0gpt2%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/tree-838666_1280_hu1105538485009176982.jpg"
                        srcset="/p/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%A1%A5%E4%B9%A0gpt2%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/tree-838666_1280_hu1105538485009176982.jpg 800w, /p/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%A1%A5%E4%B9%A0gpt2%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/tree-838666_1280_hu14457667872741287151.jpg 1600w"
                        width="800" 
                        height="527" 
                        loading="lazy"
                        alt="Featured image of post Â§ßÊ®°ÂûãÂü∫Á°ÄÁü•ËØÜË°•‰π†&amp;GPT2‰ª£Á†ÅÂàÜÊûê" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/llm/" >
                LLM
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%A1%A5%E4%B9%A0gpt2%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">Â§ßÊ®°ÂûãÂü∫Á°ÄÁü•ËØÜË°•‰π†&amp;GPT2‰ª£Á†ÅÂàÜÊûê</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            ÂÆûÊìç‰∏Ä‰∏ãGPT2ÁöÑ‰ª£Á†ÅÔºåÊ∑±ÂàªÁêÜËß£transformerÊ®°ÂûãÁöÑÁªìÊûÑ
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-01-10</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="Â§ßÊ®°ÂûãÂü∫Á°ÄÁü•ËØÜ">Â§ßÊ®°ÂûãÂü∫Á°ÄÁü•ËØÜ
</h1><p>‰ª£Á†ÅÊù•Ê∫êÔºöhttps://github.com/openai/gpt-2</p>
<p>GPT2Ê∫ê‰ª£Á†ÅÊèê‰æõ‰∫Ü‰ª•‰∏ãÂá†‰∏™Êñá‰ª∂Ôºö</p>
<p>encoder.py</p>
<p>generate_unconditional_samples.py</p>
<p>interactive_conditional_samples.py</p>
<p>model.py</p>
<p>sample.py</p>
<h2 id="model">model
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def default_hparams():
</span></span><span class="line"><span class="cl">    return HParams(
</span></span><span class="line"><span class="cl">        n_vocab=0,        # ËØçÊ±áË°®Â§ßÂ∞èÔºàÈÄöÂ∏∏ÊòØËØçÊ±áË°®‰∏≠ÂåÖÂê´ÁöÑËØçËØ≠ÊàñÁ¨¶Âè∑Êï∞ÈáèÔºâ
</span></span><span class="line"><span class="cl">        n_ctx=1024,       # ËæìÂÖ•Â∫èÂàóÁöÑÊúÄÂ§ßÈïøÂ∫¶Ôºà‰æãÂ¶ÇÔºå‰∏Ä‰∏™ËæìÂÖ•ÊñáÊú¨Â∫èÂàóÁöÑÊúÄÂ§ß token Êï∞ÈáèÔºâ
</span></span><span class="line"><span class="cl">        n_embd=768,       # ÂµåÂÖ•Â±ÇÁöÑÁª¥Â∫¶Â§ßÂ∞èÔºàÊØè‰∏™ËØçÊàñÁ¨¶Âè∑Âú®ÂµåÂÖ•Á©∫Èó¥‰∏≠ÁöÑË°®Á§∫ÈïøÂ∫¶Ôºâ
</span></span><span class="line"><span class="cl">        n_head=12,        # Â§öÂ§¥Ëá™Ê≥®ÊÑèÂäõÊú∫Âà∂‰∏≠ÁöÑÂ§¥Êï∞ÔºàÂç≥Ê≥®ÊÑèÂäõÂ§¥ÁöÑÊï∞ÈáèÔºâ
</span></span><span class="line"><span class="cl">        n_layer=12,       # Transformer Ê®°Âûã‰∏≠ÁöÑÂ±ÇÊï∞ÔºàÂç≥Â†ÜÂè†ÁöÑ transformer Â±ÇÊï∞Ôºâ
</span></span><span class="line"><span class="cl">    )
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ËØçÊ±áË°®">ËØçÊ±áË°®
</h3><p>ËØçÊ±áË°®ÔºàVocabularyÔºâÊòØËá™ÁÑ∂ËØ≠Ë®ÄÂ§ÑÁêÜÔºàNLPÔºâÊ®°Âûã‰∏≠Áî®‰∫éÂ∞ÜËØ≠Ë®ÄËΩ¨Êç¢‰∏∫Êï∞Â≠óË°®Á§∫ÁöÑ‰∏ÄÁªÑËØçÊàñÁ¨¶Âè∑ÁöÑÈõÜÂêà„ÄÇÂú®Ê∑±Â∫¶Â≠¶‰π†Ê®°Âûã‰∏≠ÔºåËØçÊ±áË°®Áî®‰∫éÂ∞ÜÊñáÊú¨Êï∞ÊçÆ‰∏≠ÁöÑÊØè‰∏™ÂçïËØçÊàñÁ¨¶Âè∑Êò†Â∞Ñ‰∏∫‰∏Ä‰∏™ÂîØ‰∏ÄÁöÑÊï∞Â≠óÔºàÈÄöÂ∏∏ÊòØ‰∏Ä‰∏™Êï¥Êï∞ÔºâÔºå‰ª•‰æøËÆ°ÁÆóÊú∫ËÉΩÂ§üÁêÜËß£ÂíåÂ§ÑÁêÜ„ÄÇ</p>
<h4 id="ËØçÊ±áË°®ÁöÑ‰ΩúÁî®">ËØçÊ±áË°®ÁöÑ‰ΩúÁî®Ôºö
</h4><ol>
<li><strong>Êò†Â∞ÑÊñáÊú¨Âà∞Êï∞Â≠ó</strong>ÔºöÁî±‰∫éÊú∫Âô®Â≠¶‰π†Ê®°ÂûãÊó†Ê≥ïÁõ¥Êé•Â§ÑÁêÜÊñáÊú¨Êï∞ÊçÆÔºåÂøÖÈ°ªÂ∞ÜÊñáÊú¨‰∏≠ÁöÑÊØè‰∏™ËØçÊàñÁ¨¶Âè∑ËΩ¨Êç¢‰∏∫Êï∞Â≠ó„ÄÇËØçÊ±áË°®Â∞±ÊòØËøô‰∏™Êò†Â∞ÑÁöÑÊ†∏ÂøÉÂ∑•ÂÖ∑„ÄÇ‰æãÂ¶ÇÔºåÂØπ‰∫éÂè•Â≠ê‚ÄúÊàëÁà±Ëá™ÁÑ∂ËØ≠Ë®ÄÂ§ÑÁêÜ‚ÄùÔºåÊàë‰ª¨ÈúÄË¶ÅÂ∞Ü‚ÄúÊàë‚Äù„ÄÅ‚ÄúÁà±‚Äù„ÄÅ‚ÄúËá™ÁÑ∂‚Äù„ÄÅ‚ÄúËØ≠Ë®Ä‚Äù„ÄÅ‚ÄúÂ§ÑÁêÜ‚ÄùËøô‰∫õËØçËΩ¨Âåñ‰∏∫Ê®°ÂûãÂèØ‰ª•ÁêÜËß£ÁöÑÊï∞Â≠ó„ÄÇ</li>
<li><strong>ÈôêÂà∂Ê®°ÂûãËæìÂÖ•ÁöÑËßÑÊ®°</strong>ÔºöÂú®ÂÆûÈôÖÊìç‰Ωú‰∏≠ÔºåËØçÊ±áË°®ÁöÑÂ§ßÂ∞èÊúâÈôê„ÄÇÈÄöÂ∏∏ÔºåÊàë‰ª¨‰∏ç‰ºö‰∏∫ÊØè‰∏™ÂèØËÉΩÁöÑÂ≠óËØçÂàõÂª∫‰∏Ä‰∏™Á¥¢ÂºïÔºåËÄåÊòØÊ†πÊçÆËÆ≠ÁªÉÊï∞ÊçÆ‰∏≠Âá∫Áé∞ÁöÑËØçÊ±áÈ¢ëÁéáÊù•ÈôêÂà∂ËØçÊ±áË°®ÁöÑÂ§ßÂ∞è„ÄÇËøôÊ†∑ÔºåËØçÊ±áË°®ÁöÑËßÑÊ®°ÂèØ‰ª•ÊéßÂà∂Ê®°ÂûãÁöÑËæìÂÖ•Áª¥Â∫¶ÔºåÈÅøÂÖçËøáÂ§ßÁöÑËÆ°ÁÆóÂíåÂÜÖÂ≠òÂºÄÈîÄ„ÄÇ</li>
<li><strong>Â§ÑÁêÜÊú™Áü•ËØçÊ±á</strong>ÔºöËØçÊ±áË°®ÈÄöÂ∏∏‰ºö‰∏∫ÊâÄÊúâÊú™Âá∫Áé∞Âú®ËÆ≠ÁªÉÊï∞ÊçÆ‰∏≠ÁöÑËØçÊ±áÊàñÁ¨¶Âè∑‰øùÁïô‰∏Ä‰∏™ÁâπÊÆäÁöÑ‚ÄúÊú™Áü•ËØç‚ÄùÊ†áËÆ∞ÔºàÂ¶Ç <code>[UNK]</code>Ôºâ„ÄÇÂΩìÊ®°ÂûãÈÅáÂà∞Ëøô‰∫õÊú™ËßÅËøáÁöÑËØçÊó∂Ôºå‰ºöÁî®Ëøô‰∏™ÁâπÊÆäÊ†áËÆ∞Êù•‰ª£Êõø„ÄÇ</li>
</ol>
<h4 id="ËØçÊ±áË°®ÁöÑÁªÑÊàê">ËØçÊ±áË°®ÁöÑÁªÑÊàêÔºö
</h4><ol>
<li>
<p><strong>ËØç</strong>ÔºöÂ¶ÇÊûú‰Ω†‰ΩøÁî®ÁöÑÊòØÂü∫‰∫éÂçïËØçÁöÑËØçÊ±áË°®ÔºåÈÇ£‰πàËØçÊ±áË°®‰∏≠ÁöÑÂÖÉÁ¥†Â∞±ÊòØÂçïËØç„ÄÇ‰æãÂ¶ÇÔºåÂÅáËÆæ‰Ω†Êúâ‰∏Ä‰∏™ÂæàÂ∞èÁöÑËØçÊ±áË°®Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">css
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Â§çÂà∂‰ª£Á†Å
</span></span><span class="line"><span class="cl">[&#39;Êàë&#39;, &#39;Áà±&#39;, &#39;Ëá™ÁÑ∂&#39;, &#39;ËØ≠Ë®Ä&#39;, &#39;Â§ÑÁêÜ&#39;]
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>Â≠êËØç</strong>ÔºàSubwordÔºâÔºöÂØπ‰∫é‰∏Ä‰∫õËæÉ‰∏∫Â§çÊùÇÁöÑËØ≠Ë®ÄÊ®°ÂûãÔºåÂ∞§ÂÖ∂ÊòØÂÉè GPT-2 Âíå BERT ËøôÊ†∑ÁöÑÊ®°ÂûãÔºåÂÆÉ‰ª¨ÈÄöÂ∏∏‰ΩøÁî® <strong>Â≠êËØç</strong> ‰Ωú‰∏∫ËØçÊ±áË°®ÁöÑÂü∫Êú¨ÂçïÂÖÉ„ÄÇÂ≠êËØçÊòØ‰∏Ä‰∏™ÊØîÂçïËØçÊõ¥Â∞èÁöÑËØ≠Ë®ÄÂçï‰ΩçÔºåÂÆÉÂèØ‰ª•ÊòØËØçÁöÑ‰∏ÄÈÉ®ÂàÜÊàñËÄÖÊòØ‰∏Ä‰∏™Â∏∏ËßÅÁöÑËØçÊ†π„ÄÅÂâçÁºÄ„ÄÅÂêéÁºÄÁ≠â„ÄÇ‰æãÂ¶ÇÔºåËØçÊ±áË°®‰∏≠ÂèØËÉΩÂåÖÂê´ <code>##ing</code>„ÄÅ<code>un</code> Á≠âÂ≠êËØçÂçïÂÖÉÔºåËÄå‰∏çÊòØÊï¥‰∏™ÂçïËØç <code>running</code> Êàñ <code>undo</code>„ÄÇËøôÊúâÂä©‰∫éÊ®°ÂûãÊõ¥Â•ΩÂú∞Â§ÑÁêÜÊú™ËßÅËøáÁöÑËØçÊ±áÔºåÂπ∂ÂáèÂ∞ëËØçÊ±áË°®ÁöÑÂ§ßÂ∞è„ÄÇ</p>
</li>
<li>
<p><strong>ÁâπÊÆäÊ†áËÆ∞</strong>ÔºöÈô§‰∫ÜÂÆûÈôÖÁöÑËØçÊàñÂ≠êËØçÔºåËØçÊ±áË°®ÈÄöÂ∏∏Ëøò‰ºöÂåÖÂê´‰∏Ä‰∫õÁâπÊÆäÊ†áËÆ∞Ôºö</p>
<ul>
<li><code>[PAD]</code>ÔºöÂ°´ÂÖÖÊ†áËÆ∞ÔºåÁî®‰∫éÂ∞ÜËæìÂÖ•ÊñáÊú¨Â°´ÂÖÖÂà∞Áõ∏ÂêåÁöÑÈïøÂ∫¶„ÄÇ</li>
<li><code>[UNK]</code>ÔºöÊú™Áü•Ê†áËÆ∞ÔºåÁî®‰∫éÂ§ÑÁêÜÈÇ£‰∫õÂú®ËÆ≠ÁªÉÈõÜ‰∏≠Ê≤°ÊúâÂá∫Áé∞ËøáÁöÑËØç„ÄÇ</li>
<li><code>[CLS]</code>ÔºöÂàÜÁ±ªÊ†áËÆ∞ÔºåÈÄöÂ∏∏Áî®‰∫éÊ†áËÆ∞ËæìÂÖ•ÁöÑÂºÄÂßãÔºàÁâπÂà´ÊòØÂú® BERT Á≠âÊ®°Âûã‰∏≠Ôºâ„ÄÇ</li>
<li><code>[SEP]</code>ÔºöÂàÜÈöîÊ†áËÆ∞ÔºåÈÄöÂ∏∏Áî®‰∫éÂàÜÈöî‰∏çÂêåÂè•Â≠êÊàñÊñáÊú¨ÊÆµËêΩÔºàÂú® BERT Á≠âÊ®°Âûã‰∏≠‰πüÊúâ‰ΩøÁî®Ôºâ„ÄÇ</li>
</ul>
</li>
</ol>
<h3 id="ÂêëÈáèÁ©∫Èó¥vector-space">ÂêëÈáèÁ©∫Èó¥ÔºàVector SpaceÔºâ
</h3><p><strong>ÂêëÈáèÁ©∫Èó¥</strong>ÊòØ‰∏Ä‰∏™Êï∞Â≠¶Ê¶ÇÂøµÔºåÊåáÁöÑÊòØÊâÄÊúâÂêëÈáèÁöÑÈõÜÂêàÔºåÂèØ‰ª•Âú®ÂÖ∂‰∏≠ËøõË°åÂä†Ê≥ïÂíåÊ†áÈáè‰πòÊ≥ïÁ≠âÊìç‰Ωú„ÄÇÂú®Êú∫Âô®Â≠¶‰π†ÂíåËá™ÁÑ∂ËØ≠Ë®ÄÂ§ÑÁêÜ‰∏≠ÔºåÊàë‰ª¨ÈÄöÂ∏∏Â∞ÜÊØè‰∏™ËØç„ÄÅÂ≠êËØçÊàñÁ¨¶Âè∑Ë°®Á§∫‰∏∫‰∏Ä‰∏™È´òÁª¥Á©∫Èó¥‰∏≠ÁöÑÂêëÈáè„ÄÇ‰æãÂ¶ÇÔºå‰∏Ä‰∏™ÁÆÄÂçïÁöÑ‰∫åÁª¥ÂêëÈáèÁ©∫Èó¥ÂèØËÉΩÂåÖÂê´‰∫ÜËøôÊ†∑ÁöÑ‰∏ÄÁªÑÂêëÈáèÔºö</p>
<ul>
<li><code>(1, 0)</code></li>
<li><code>(0, 1)</code></li>
<li><code>(1, 1)</code></li>
</ul>
<p>Âú® NLP ‰∏≠ÔºåËøô‰∫õÂêëÈáèÂπ∂Ê≤°ÊúâÂÖ∑‰ΩìÁöÑÂá†‰ΩïÂê´‰πâÔºåËÄåÊòØÁî®Êù•Ë°®Á§∫‰∏çÂêåÁöÑËØ≠‰πâÁâπÂæÅ„ÄÇÊØè‰∏™ÂêëÈáèÁöÑÂÖÉÁ¥†ÔºàÂç≥ÂêÑÁª¥Â∫¶ÁöÑÂÄºÔºâ‰ª£Ë°®‰∫ÜÊüêÁßçÊäΩË±°ÁöÑËØ≠‰πâÂ±ûÊÄß„ÄÇ</p>
<p><strong>ËØçÂêëÈáèÁ©∫Èó¥</strong>ÊÑèÂë≥ÁùÄÊØè‰∏™ËØçÈÉΩË¢´Êò†Â∞Ñ‰∏∫‰∏Ä‰∏™ÂêëÈáèÔºå‰∏îËøô‰∫õÂêëÈáè‰πãÈó¥Êúâ‰∏ÄÂÆöÁöÑÂÖ≥Á≥ª„ÄÇ‰æãÂ¶ÇÔºå&ldquo;king&rdquo; Âíå &ldquo;queen&rdquo; ÂèØËÉΩÂú®ÂêëÈáèÁ©∫Èó¥‰∏≠ÈùûÂ∏∏Êé•ËøëÔºåÂõ†‰∏∫ÂÆÉ‰ª¨ÁöÑËØ≠‰πâÁõ∏‰ººÔºåÂ∞ΩÁÆ°ÂÆÉ‰ª¨ÁöÑÊãºÂÜô‰∏çÂêå„ÄÇÂµåÂÖ•ÁöÑÁõÆÊ†áÂ∞±ÊòØÂ∞ÜËØ≠Ë®Ä‰∏≠ÁöÑËØçËØ≠„ÄÅÂè•Â≠êÊàñÂÖ∂‰ªñËØ≠Ë®ÄÂçï‰ΩçÊò†Â∞ÑÂà∞ËøôÊ†∑‰∏Ä‰∏™ÂêëÈáèÁ©∫Èó¥‰∏≠„ÄÇ</p>
<h3 id="ÂµåÂÖ•embedding">ÂµåÂÖ•ÔºàEmbeddingÔºâ
</h3><p>**ÂµåÂÖ•ÔºàEmbeddingÔºâ**ÊòØÂ∞Ü‰∏Ä‰∏™Á¶ªÊï£ÁöÑËØçÊ±áÈ°πÔºàÂ¶ÇÂçïËØç„ÄÅÂ≠êËØçÔºâËΩ¨Êç¢‰∏∫ËøûÁª≠ÁöÑÂêëÈáèË°®Á§∫ÁöÑËøáÁ®ã„ÄÇËøô‰∫õÂêëÈáèÈÄöÂ∏∏ÂÖ∑ÊúâÂõ∫ÂÆöÁöÑÁª¥Â∫¶Ôºà‰æãÂ¶Ç 300 Áª¥„ÄÅ768 Áª¥Á≠âÔºâÔºåÂπ∂‰∏îËÉΩÂ§üÊçïÊçâËØ•ËØçÁöÑËØ≠‰πâ‰ø°ÊÅØ„ÄÇ</p>
<p>Êç¢Âè•ËØùËØ¥ÔºåÂµåÂÖ•ÊòØÂØπËØçÊ±áÁöÑÊï∞Â≠óË°®Á§∫ÔºåÂÆÉÈÄöËøáÂ∞ÜÊØè‰∏™ËØçÊàñÁ¨¶Âè∑Êò†Â∞ÑÂà∞‰∏Ä‰∏™ÂêëÈáèÁ©∫Èó¥‰∏≠Ôºå‰ΩøÂæóÊ®°ÂûãËÉΩÂ§üÁêÜËß£ÂíåÂ§ÑÁêÜËØ≠Ë®Ä‰∏≠ÁöÑÂ§çÊùÇÁªìÊûÑ„ÄÇ</p>
<p>‰æãÂ¶ÇÔºåÂÅáËÆæ‰Ω†Êúâ‰ª•‰∏ã‰∏â‰∏™ËØçÊ±áÔºö</p>
<ul>
<li>&ldquo;Áå´&rdquo;ÔºàcatÔºâ</li>
<li>&ldquo;Áãó&rdquo;ÔºàdogÔºâ</li>
<li>&ldquo;Ê±ΩËΩ¶&rdquo;ÔºàcarÔºâ</li>
</ul>
<p>ÈÄöËøáÂµåÂÖ•ÔºåËøô‰∫õËØçËØ≠‰ºöË¢´Êò†Â∞Ñ‰∏∫Âõ∫ÂÆöÈïøÂ∫¶ÁöÑÂêëÈáèÔºå‰æãÂ¶ÇÔºö</p>
<ul>
<li>&ldquo;Áå´&rdquo; ‚Üí <code>[0.45, 0.87, 0.34, ...]</code></li>
<li>&ldquo;Áãó&rdquo; ‚Üí <code>[0.42, 0.89, 0.31, ...]</code></li>
<li>&ldquo;Ê±ΩËΩ¶&rdquo; ‚Üí <code>[0.21, 0.08, 0.76, ...]</code></li>
</ul>
<p>Ëøô‰∫õÂêëÈáèÁöÑÁª¥Â∫¶Ôºà‰æãÂ¶Ç 300 Áª¥Êàñ 768 Áª¥ÔºâÂèçÊò†‰∫ÜÂµåÂÖ•Á©∫Èó¥ÁöÑÂ§çÊùÇÂ∫¶„ÄÇÊ®°ÂûãÈÄöËøáËÆ≠ÁªÉÊù•‰ºòÂåñËøô‰∫õÂêëÈáèÔºå‰ΩøÂæóËØ≠‰πâÁõ∏‰ººÁöÑËØçÂú®ÂµåÂÖ•Á©∫Èó¥‰∏≠Ë∑ùÁ¶ªÊõ¥ËøëÔºåËØ≠‰πâ‰∏çÂêåÁöÑËØçË∑ùÁ¶ªËæÉËøú„ÄÇ</p>
<h3 id="ÂêëÈáèvector">ÂêëÈáèÔºàVectorÔºâ
</h3><p><strong>ÂêëÈáè</strong>ÊòØÂú®Êï∞Â≠¶ÂíåËÆ°ÁÆóÊú∫ÁßëÂ≠¶‰∏≠Áî®Êù•Ë°®Á§∫ÊñπÂêëÂíåÂ§ßÂ∞èÁöÑÂØπË±°„ÄÇÊØè‰∏™ËØçÊàñÁ¨¶Âè∑Ë¢´ÂµåÂÖ•‰∏∫‰∏Ä‰∏™<strong>ÂêëÈáè</strong>ÔºåËøô‰∏™ÂêëÈáèÈÄöÂ∏∏ÊòØ‰∏Ä‰∏™ÊµÆÂä®ÁöÑÊï∞Â≠óÊï∞ÁªÑ„ÄÇÂêëÈáèÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩË°®Á§∫‰∏Ä‰∏™ÁâπÂÆöÁöÑÁâπÂæÅÁª¥Â∫¶„ÄÇ</p>
<p>Âú® NLP ‰∏≠ÔºåËØçÁöÑÂêëÈáèÈÄöÂ∏∏Êúâ‰ª•‰∏ãÂá†‰∏™ÁâπÁÇπÔºö</p>
<ul>
<li><strong>Á®†ÂØÜË°®Á§∫</strong>ÔºöÊØè‰∏™ËØçÁöÑÂêëÈáèÊòØ‰∏Ä‰∏™‰ΩéÁª¥ÁöÑÁ®†ÂØÜÂêëÈáèÔºå‰∏çÂÉè‰º†ÁªüÁöÑ‚Äúone-hot‚ÄùÁºñÁ†ÅÔºà‰ªÖ‰ΩøÁî®0Âíå1Êù•Ë°®Á§∫ËØçÊ±áÔºâ„ÄÇÁ®†ÂØÜÂêëÈáèÂåÖÂê´‰∫Ü‰∏∞ÂØåÁöÑËØ≠‰πâ‰ø°ÊÅØ„ÄÇ</li>
<li><strong>ËØ≠‰πâÂÖ≥Á≥ª</strong>ÔºöÈÄöËøáËÆ≠ÁªÉÔºåËØçÂêëÈáèÂèØ‰ª•ÊçïÊçâÂà∞ËØçÊ±á‰πãÈó¥ÁöÑËØ≠‰πâÂÖ≥Á≥ª„ÄÇ‰æãÂ¶ÇÔºå‚Äúking‚Äù Âíå ‚Äúqueen‚Äù ÂèØËÉΩÊúâÁõ∏‰ººÁöÑÂêëÈáèÔºåÂõ†‰∏∫ÂÆÉ‰ª¨ÂÖ±‰∫´ËÆ∏Â§öËØ≠‰πâÁâπÂæÅ„ÄÇ</li>
</ul>
<p>‰æãÂ¶ÇÔºåÂÅáËÆæÊàë‰ª¨ËÆ≠ÁªÉ‰∫Ü‰∏Ä‰∏™Ê®°ÂûãÔºåÂæóÂà∞‰ª•‰∏ãÁöÑËØçÂêëÈáèÔºö</p>
<ul>
<li>&ldquo;ËãπÊûú&rdquo; ‚Üí <code>[0.5, -0.2, 0.1, 0.7]</code></li>
<li>&ldquo;È¶ôËïâ&rdquo; ‚Üí <code>[0.4, -0.1, 0.2, 0.6]</code></li>
</ul>
<p>Ëøô‰∫õÂêëÈáèÁöÑÊï∞ÂÄºË°®Á§∫‰∫ÜÊØè‰∏™ËØçÁöÑÁâπÂæÅÂíåËØ≠‰πâ‰ø°ÊÅØ„ÄÇÂú®ËÆ≠ÁªÉËøáÁ®ã‰∏≠ÔºåÊ®°Âûã‰ºöÈÄöËøáË∞ÉÊï¥Ëøô‰∫õÂêëÈáèÔºå‰ΩøÂæóËØ≠‰πâÁõ∏‰ººÁöÑËØçÁöÑÂêëÈáèÂú®Á©∫Èó¥‰∏≠ÂΩºÊ≠§Êé•Ëøë„ÄÇ</p>
<h3 id="‰∏∫‰ªÄ‰πàË¶Å‰ΩøÁî®ÂµåÂÖ•">‰∏∫‰ªÄ‰πàË¶Å‰ΩøÁî®ÂµåÂÖ•Ôºü
</h3><ol>
<li><strong>ÊçïÊçâËØ≠‰πâÁõ∏‰ººÊÄß</strong>ÔºöÈÄöËøáÂµåÂÖ•ÔºåÊ®°ÂûãÂèØ‰ª•ÁêÜËß£Âì™‰∫õËØçÊòØÁõ∏‰ººÁöÑÔºåÂì™‰∫õÊòØ‰∏çÂêåÁöÑ„ÄÇÊØîÂ¶Ç‚ÄúÁå´‚ÄùÂíå‚ÄúÁãó‚ÄùËôΩÁÑ∂ÊãºÂÜô‰∏çÂêåÔºå‰ΩÜÂÆÉ‰ª¨ÈÉΩÊòØ‚ÄúÂä®Áâ©‚ÄùÔºåÂõ†Ê≠§ÂÆÉ‰ª¨ÁöÑÂêëÈáè‰ºöÂæàÊé•Ëøë„ÄÇ</li>
<li><strong>ÈôçÁª¥</strong>ÔºöÂ∞ÜËØçËØ≠‰ªé‚Äúone-hot‚ÄùÁºñÁ†ÅÁöÑÈ´òÁª¥Á©∫Èó¥Ôºà‰æãÂ¶ÇÔºåÂÅáËÆæÊúâ 10,000 ‰∏™‰∏çÂêåÁöÑËØçÔºåone-hot ÂêëÈáèÂ∞±ÊòØ 10,000 Áª¥ÁöÑÔºâÊò†Â∞ÑÂà∞‰∏Ä‰∏™‰ΩéÁª¥Á©∫Èó¥ÔºàÂ¶Ç 300 Áª¥Ôºâ„ÄÇËøôÊ†∑ÂèØ‰ª•ÂáèÂ∞ëËÆ°ÁÆóÁöÑÂ§çÊùÇÂ∫¶ÂíåÂÜÖÂ≠òÊ∂àËÄó„ÄÇ</li>
<li><strong>Â¢ûÂº∫Ê®°ÂûãÁêÜËß£</strong>ÔºöÈÄöËøáÂ∞ÜËØçËΩ¨Êç¢‰∏∫ÂêëÈáèÔºåÊ®°ÂûãÂèØ‰ª•Êõ¥Âä†ÊúâÊïàÂú∞ÁêÜËß£ÊñáÊú¨‰∏≠ÁöÑËØ≠‰πâ„ÄÅÂè•Ê≥ïÂÖ≥Á≥ªÂíå‰∏ä‰∏ãÊñá‰ø°ÊÅØ„ÄÇËøôÂØπ‰∫éÂ§çÊùÇÁöÑ‰ªªÂä°ÔºàÂ¶ÇÊñáÊú¨ÂàÜÁ±ª„ÄÅÊÉÖÊÑüÂàÜÊûê„ÄÅÁøªËØëÁ≠âÔºâÈùûÂ∏∏ÈáçË¶Å„ÄÇ</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">shape_list</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Deal with dynamic shape in tensorflow cleanly.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>  <span class="c1"># Ëé∑ÂèñÈùôÊÄÅÂΩ¢Áä∂</span>
</span></span><span class="line"><span class="cl">    <span class="n">dynamic</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Ëé∑ÂèñÂä®ÊÄÅÂΩ¢Áä∂</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="n">dynamic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span> <span class="n">is</span> <span class="n">None</span> <span class="k">else</span> <span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="k">static</span><span class="p">)]</span>  <span class="c1"># ËøîÂõûÂêàÂπ∂ÂêéÁöÑÂΩ¢Áä∂</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p><strong><code>static = x.shape.as_list()</code></strong>Ôºö</p>
<ul>
<li><code>x.shape</code> ÊòØ TensorFlow Âº†Èáè <code>x</code> ÁöÑÈùôÊÄÅÂΩ¢Áä∂„ÄÇ</li>
<li><code>as_list()</code> Â∞ÜËøô‰∏™ÂΩ¢Áä∂‰ªé <code>TensorShape</code> ÂØπË±°ËΩ¨Êç¢‰∏∫ Python ÂàóË°®„ÄÇÈùôÊÄÅÂΩ¢Áä∂ÁöÑÂÄºÂ¶ÇÊûúÊòØÂ∑≤Áü•ÁöÑÔºå‰ºöÁõ¥Êé•‰Ωú‰∏∫Êï∞ÂÄºÂ≠òÂú®„ÄÇÂ¶ÇÊûúÊüê‰∏™Áª¥Â∫¶ÁöÑÂÄºÊòØ <code>None</code>ÔºàË°®Á§∫ËØ•Áª¥Â∫¶Âú®ÈùôÊÄÅÂΩ¢Áä∂‰∏≠‰∏çÁ°ÆÂÆöÔºâÔºåÈÇ£‰πà‰ºöÊòØ <code>None</code>„ÄÇ</li>
<li>‰æãÂ¶ÇÔºåÂ¶ÇÊûú <code>x</code> ÁöÑÂΩ¢Áä∂ÊòØ <code>[None, 32, 32, 3]</code>ÔºåÂàô <code>static</code> ‰ºöÊòØ <code>[None, 32, 32, 3]</code>„ÄÇ</li>
</ul>
</li>
<li>
<p><strong><code>dynamic = tf.shape(x)</code></strong>Ôºö</p>
<ul>
<li><code>tf.shape(x)</code> ËøîÂõûÂº†Èáè <code>x</code> ÁöÑÂä®ÊÄÅÂΩ¢Áä∂ÔºåÂÆÉÊòØ‰∏Ä‰∏™ TensorFlow Âº†ÈáèÔºåË°®Á§∫ËøêË°åÊó∂ËØ•Âº†ÈáèÁöÑÂΩ¢Áä∂„ÄÇ‰∏éÈùôÊÄÅÂΩ¢Áä∂‰∏çÂêåÔºåÂä®ÊÄÅÂΩ¢Áä∂‰ºöÊ†πÊçÆÂÆûÈôÖËøêË°åÊó∂ÁöÑËæìÂÖ•Êï∞ÊçÆËøõË°åËÆ°ÁÆó„ÄÇ</li>
<li>ËøîÂõûÂÄºÊòØ‰∏Ä‰∏™ÂΩ¢Áä∂‰∏∫ <code>[d0, d1, ..., dn]</code> ÁöÑÂº†ÈáèÔºà<code>d0</code>Ôºå<code>d1</code> Á≠âÊòØÂº†ÈáèÁöÑÂêÑ‰∏™Áª¥Â∫¶ÁöÑÂä®ÊÄÅÂ§ßÂ∞èÔºâ„ÄÇ</li>
</ul>
</li>
<li>
<p><strong><code>return [dynamic[i] if s is None else s for i, s in enumerate(static)]</code></strong>Ôºö</p>
<ul>
<li>Ëøô‰∏™ÂàóË°®Êé®ÂØºÂºèÁöÑÁõÆÁöÑÊòØÂ∞ÜÈùôÊÄÅÂΩ¢Áä∂ÂíåÂä®ÊÄÅÂΩ¢Áä∂ÂêàÂπ∂Êàê‰∏Ä‰∏™ÂΩ¢Áä∂ÂàóË°®„ÄÇÂ¶ÇÊûúÊüê‰∏™ÈùôÊÄÅÂΩ¢Áä∂ÁöÑÁª¥Â∫¶ÊòØ <code>None</code>ÔºàÂç≥Âú®ÈùôÊÄÅÂΩ¢Áä∂‰∏≠Êú™ÊåáÂÆöÔºâÔºåÈÇ£‰πàÂ∞±‰ΩøÁî®ÂØπÂ∫îÁöÑÂä®ÊÄÅÂΩ¢Áä∂„ÄÇ</li>
<li><code>enumerate(static)</code> ‰ºöÈÅçÂéÜÈùôÊÄÅÂΩ¢Áä∂‰∏≠ÁöÑÊØè‰∏™Áª¥Â∫¶ÔºåÂ¶ÇÊûúËØ•Áª¥Â∫¶ÊòØ <code>None</code>ÔºåÂ∞±‰ªéÂä®ÊÄÅÂΩ¢Áä∂‰∏≠ÂèñÂØπÂ∫îÁöÑÁª¥Â∫¶ÂÄºÔºõÂ¶ÇÊûúËØ•Áª¥Â∫¶‰∏çÊòØ <code>None</code>ÔºåÂàô‰øùÁïôÈùôÊÄÅÂΩ¢Áä∂‰∏≠ÁöÑÂÄº„ÄÇ</li>
</ul>
<p>‰æãÂ¶ÇÔºö</p>
<ul>
<li>ÂÅáËÆæ <code>static = [None, 32, 32, 3]</code>ÔºàÁ¨¨‰∏ÄÁª¥Â∫¶ <code>None</code>ÔºåË°®Á§∫ÂÆÉÊòØÂä®ÊÄÅÁöÑÔºâÂíå <code>dynamic = [64, 32, 32, 3]</code>ÔºàËøêË°åÊó∂ËØ•Âº†ÈáèÁöÑÂÆûÈôÖÂΩ¢Áä∂ÊòØ <code>[64, 32, 32, 3]</code>Ôºâ„ÄÇ</li>
<li>ÈÇ£‰πàÔºåÂáΩÊï∞ÁöÑËøîÂõûÂÄºÂ∞ÜÊòØ <code>[64, 32, 32, 3]</code>„ÄÇ</li>
</ul>
</li>
<li>
<p>‰∏∫‰ªÄ‰πàÈúÄË¶ÅËøô‰∏™ÂáΩÊï∞Ôºü</p>
</li>
</ol>
<p>Âú® TensorFlow ‰∏≠ÔºåËÆ∏Â§öÊìç‰ΩúË¶ÅÊ±ÇÂ§ÑÁêÜÁöÑÂº†ÈáèÂΩ¢Áä∂ÊòØÂ∑≤Áü•ÁöÑÔºàÈùôÊÄÅÂΩ¢Áä∂ÔºâÔºå‰ΩÜÊúâ‰∫õÊÉÖÂÜµ‰∏ãÂΩ¢Áä∂Âú®ÊâßË°åÊó∂Êâç‰ºöÂä®ÊÄÅÁ°ÆÂÆöÔºåÁâπÂà´ÊòØÂú®Â§ÑÁêÜËæìÂÖ•Êï∞ÊçÆÁöÑÊâπÈáèÂ§ßÂ∞è„ÄÅÂõæÂÉèÂ∞∫ÂØ∏Á≠âÂèòÈáèÊó∂„ÄÇ<code>shape_list</code> ÂáΩÊï∞Â∞±ÊòØÁî®Êù•Áªü‰∏ÄÂ§ÑÁêÜËøô‰∏§ÁßçÊÉÖÂÜµÁöÑÔºå‰ΩøÂæóÊó†ËÆ∫ÊòØÂú®ÈùôÊÄÅËøòÊòØÂä®ÊÄÅÂΩ¢Áä∂‰∏ãÔºå‰ª£Á†ÅÈÉΩËÉΩÂ§üÊ≠£Â∏∏ËøêË°åËÄå‰∏ç‰ºöÂá∫Èîô„ÄÇ</p>
<ol start="5">
<li>‰∏æ‰∏™‰æãÂ≠êÔºö</li>
</ol>
<p>ÂÅáËÆæÊàë‰ª¨Êúâ‰∏Ä‰∏™Âº†Èáè <code>x</code>ÔºåÂÆÉÁöÑÂΩ¢Áä∂ÊòØ <code>[None, 64, 64, 3]</code>ÔºàÊâπÈáèÂ§ßÂ∞èÊú™Áü•ÔºâÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import tensorflow as tf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">x = tf.placeholder(tf.float32, shape=[None, 64, 64, 3])  # Âä®ÊÄÅÊâπÈáèÂ§ßÂ∞è
</span></span><span class="line"><span class="cl">shape = shape_list(x)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">print(shape)  # ËæìÂá∫ÂΩ¢Áä∂
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âú®Ëøô‰∏™‰æãÂ≠ê‰∏≠ÔºåÂ¶ÇÊûú‰Ω†‰º†ÈÄí‰∏Ä‰∏™Â§ßÂ∞è‰∏∫ <code>[32, 64, 64, 3]</code> ÁöÑËæìÂÖ•Ôºå<code>shape_list</code> ÂáΩÊï∞‰ºöËøîÂõû <code>[32, 64, 64, 3]</code>ÔºåÂç≥Â∞Ü <code>None</code> ÊõøÊç¢‰∏∫ÂÆûÈôÖÁöÑÊâπÈáèÂ§ßÂ∞è <code>32</code>„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def softmax(x, axis=-1): 
</span></span><span class="line"><span class="cl">    x = x - tf.reduce_max(x, axis=axis, keepdims=True)
</span></span><span class="line"><span class="cl">    ex = tf.exp(x)
</span></span><span class="line"><span class="cl">    return ex / tf.reduce_sum(ex, axis=axis, keepdims=True)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ëøô‰∏™ÂáΩÊï∞ÂÆûÁé∞‰∫Ü Softmax Êìç‰ΩúÔºåÂ∞ÜËæìÂÖ• <code>x</code> ËΩ¨Êç¢‰∏∫Ê¶ÇÁéáÂàÜÂ∏ÉÔºåÂ∏∏Áî®‰∫éÂ§öÂàÜÁ±ªÊ®°ÂûãÁöÑËæìÂá∫Â±Ç„ÄÇÈÄöËøáÂáèÂéªÊúÄÂ§ßÂÄºÈÅøÂÖçÊåáÊï∞ËÆ°ÁÆó‰∏≠ÁöÑÊï∞ÂÄºÊ∫¢Âá∫ÔºåÁ°Æ‰øùËÆ°ÁÆóÁ®≥ÂÆöÊÄß„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def gelu(x):
</span></span><span class="line"><span class="cl">    return 0.5*x*(1+tf.tanh(np.sqrt(2/np.pi)*(x+0.044715*tf.pow(x, 3))))
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>GELU</strong> ÊòØ‰∏ÄÁßçÂπ≥ÊªëÁöÑ„ÄÅÊ¶ÇÁéáÊÄßÁöÑÊøÄÊ¥ªÂáΩÊï∞ÔºåËÉΩÂ§üÊõ¥Ëá™ÁÑ∂Âú∞ÈÄöËøáÈ´òÊñØÂàÜÂ∏ÉËøë‰ººÈùûÁ∫øÊÄßÊøÄÊ¥ª„ÄÇÁõ∏ÊØî‰∫é ReLUÔºåGELU Âú®ËÆ≠ÁªÉÊó∂ÈÄöÂ∏∏ËÉΩÊõ¥Â•ΩÂú∞‰øùÁïôÊ¢ØÂ∫¶ÔºåÂπ∂‰∏îËÉΩÂ§üÂáèÂ∞ëÊ≠ªÁ•ûÁªèÂÖÉÁöÑÈóÆÈ¢ò„ÄÇ</p>
<p>‰ª£Á†Å‰∏≠‰ΩøÁî®‰∫Ü <code>tf.tanh</code> Âíå <code>tf.pow</code>ÔºàTensorFlow ÁöÑÂáΩÊï∞Ôºâ‰∏é NumPy ÁöÑÂ∏∏ÈáèËøõË°åËÆ°ÁÆóÔºåÁ°Æ‰øù‰∫ÜÂú® TensorFlow ‰∏≠ÁöÑÈ´òÊïàËÆ°ÁÆó„ÄÇ</p>
<p>Layer Normalization ÊòØ‰∏ÄÁßçÂú®Ê∑±Â∫¶Â≠¶‰π†‰∏≠Â∏∏Áî®ÁöÑÊäÄÊúØÔºåÊó®Âú®ÂØπÊØè‰∏™Ê†∑Êú¨ÁöÑÁâπÂæÅËøõË°åÂΩí‰∏ÄÂåñÔºå‰ΩøÂæóÁâπÂæÅÁöÑÂùáÂÄº‰∏∫0ÔºåÊñπÂ∑Æ‰∏∫1Ôºå‰ªéËÄåÂä†ÈÄüËÆ≠ÁªÉÂπ∂ÊèêÈ´òÊ®°ÂûãÁöÑÊÄßËÉΩ„ÄÇ</p>
<p>‰ª£Á†ÅËß£ÈáäÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Normalize to mean = 0, std = 1, then do a diagonal affine transform.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">n_state</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">        <span class="n">g</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">n_state</span><span class="p">],</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">n_state</span><span class="p">],</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><strong><code>x</code></strong>: ËæìÂÖ•Âº†ÈáèÔºåÈÄöÂ∏∏ÊòØÁªèËøáÊøÄÊ¥ªÂáΩÊï∞ÂêéÁöÑÊüê‰∏ÄÂ±ÇÁöÑËæìÂá∫„ÄÇ</li>
<li><strong><code>scope</code></strong>: ÂèòÈáè‰ΩúÁî®ÂüüÔºåÁî®‰∫éÂàõÂª∫ÂíåÁÆ°ÁêÜÂèòÈáè„ÄÇ</li>
<li><strong><code>axis=-1</code></strong>: ÂΩí‰∏ÄÂåñÊó∂ÁöÑÁª¥Â∫¶ÔºåÈÄöÂ∏∏Âú® Layer Normalization ‰∏≠ÊòØÊúÄÂêé‰∏ÄÁª¥ÔºàÂç≥ÁâπÂæÅÁª¥Â∫¶Ôºâ„ÄÇ<code>axis=-1</code> Ë°®Á§∫ÂΩí‰∏ÄÂåñÊúÄÂêé‰∏ÄÁª¥ÔºåÈÄöÂ∏∏ÊòØ‰∏Ä‰∏™Ê†∑Êú¨ÁöÑÊâÄÊúâÁâπÂæÅ„ÄÇ</li>
<li><strong><code>epsilon=1e-5</code></strong>: ‰∏∫‰∫ÜÈÅøÂÖçÂú®Èô§Ê≥ï‰∏≠Âá∫Áé∞Èô§Èõ∂ÈîôËØØÔºå<code>epsilon</code> ÊòØ‰∏Ä‰∏™ÂæàÂ∞èÁöÑÂ∏∏Êï∞ÔºàÈªòËÆ§ÂÄº‰∏∫ 1e‚àí51e-51e‚àí5Ôºâ„ÄÇ</li>
<li><strong><code>n_state = x.shape[-1].value</code></strong>: Ëé∑ÂèñËæìÂÖ•Âº†Èáè <code>x</code> Âú®ÊúÄÂêé‰∏ÄÁª¥ÁöÑÂ§ßÂ∞èÔºå‰ª£Ë°®ÁâπÂæÅÊï∞ÁõÆ„ÄÇ</li>
</ol>
<p>Êé•‰∏ãÊù•ÔºåÂÆö‰πâ‰∫Ü‰∏§‰∏™ÂèòÈáè <code>g</code> Âíå <code>b</code>ÔºåÂàÜÂà´Áî®‰∫éÂØπÂΩí‰∏ÄÂåñÂêéÁöÑÁªìÊûúËøõË°åÁ∫øÊÄßÂèòÊç¢Ôºö</p>
<ul>
<li><strong><code>g</code></strong> ÊòØÁº©ÊîæÂõ†Â≠êÔºàÈÄöÂ∏∏Áß∞‰∏∫ GammaÔºâ„ÄÇ</li>
<li><strong><code>b</code></strong> ÊòØÂπ≥ÁßªÂõ†Â≠êÔºàÈÄöÂ∏∏Áß∞‰∏∫ BetaÔºâ„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">       <span class="n">g</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">n_state</span><span class="p">],</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">n_state</span><span class="p">],</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>g</code> Âíå <code>b</code> ÈÉΩÊòØ‰∏éËæìÂÖ• <code>x</code> ÁöÑÊúÄÂêé‰∏ÄÁª¥ÁâπÂæÅÊï∞ÁõÆÁõ∏ÂêåÁöÑÂêëÈáè„ÄÇ<code>g</code> ÂàùÂßãÂåñ‰∏∫ 1Ôºå<code>b</code> ÂàùÂßãÂåñ‰∏∫ 0„ÄÇ</li>
</ul>
<h3 id="ÂΩí‰∏ÄÂåñÊ≠•È™§">ÂΩí‰∏ÄÂåñÊ≠•È™§Ôºö
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        u = tf.reduce_mean(x, axis=axis, keepdims=True)
</span></span><span class="line"><span class="cl">        s = tf.reduce_mean(tf.square(x - u), axis=axis, keepdims=True)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>u = tf.reduce_mean(x, axis=axis, keepdims=True)</code></strong>: ËÆ°ÁÆóËæìÂÖ• <code>x</code> Âú®ÊåáÂÆö <code>axis</code> Áª¥Â∫¶‰∏äÁöÑÂùáÂÄºÔºàÂπ≥ÂùáÂÄºÔºâ„ÄÇËøôÈáåÔºå<code>axis</code> ÈªòËÆ§‰∏∫ -1ÔºåÂç≥Ê≤øÁùÄÊúÄÂêé‰∏ÄÁª¥ËÆ°ÁÆóÂùáÂÄº„ÄÇ</li>
<li><strong><code>s = tf.reduce_mean(tf.square(x - u), axis=axis, keepdims=True)</code></strong>: ËÆ°ÁÆóËæìÂÖ• <code>x</code> ‰∏éÂùáÂÄº <code>u</code> ÁöÑÂ∑ÆÁöÑÂπ≥ÊñπÁöÑÂπ≥ÂùáÂÄºÔºåÂç≥ÊñπÂ∑Æ„ÄÇ<code>keepdims=True</code> ‰øùËØÅËæìÂá∫Áª¥Â∫¶‰∏éËæìÂÖ•Áõ∏ÂêåÔºå‰æø‰∫éÂêéÁª≠Êìç‰Ωú„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        x = (x - u) * tf.rsqrt(s + epsilon)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<dl>
<dt><code>x = (x - u) * tf.rsqrt(s + epsilon)</code></dt>
<dd>
<p>ÂØπËæìÂÖ•</p>
</dd>
</dl>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">x
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøõË°åÊ†áÂáÜÂåñÔºàÂç≥ÂΩí‰∏ÄÂåñÂ§ÑÁêÜÔºâÔºå‰ΩøÂæóÂùáÂÄº‰∏∫ 0ÔºåÊñπÂ∑Æ‰∏∫ 1„ÄÇ</p>
<ul>
<li><code>x - u</code>ÔºöÂáèÂéªÂùáÂÄºÔºå‰ΩøÂæóÊØè‰∏™ÂÖÉÁ¥†ÁöÑÂùáÂÄº‰∏∫ 0„ÄÇ</li>
<li><code>tf.rsqrt(s + epsilon)</code>ÔºöËÆ°ÁÆóÊ†áÂáÜÂ∑ÆÁöÑÂÄíÊï∞Âπ∂ËøõË°åÁº©ÊîæÔºå<code>rsqrt</code> ÊòØ <code>1 / sqrt(x)</code>„ÄÇ<code>epsilon</code> Áî®‰∫éÈò≤Ê≠¢Èô§ 0 ÈîôËØØ„ÄÇ</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        x = x * g + b
</span></span><span class="line"><span class="cl">        return x
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>x = x \* g + b</code></strong>: ÊúÄÂêéÔºåÂØπÊ†áÂáÜÂåñÂêéÁöÑ <code>x</code> ËøõË°åÁ∫øÊÄßÂèòÊç¢Ôºå‰ΩøÁî®ÂèÇÊï∞ <code>g</code>ÔºàÁº©ÊîæÂõ†Â≠êÔºâÂíå <code>b</code>ÔºàÂπ≥ÁßªÂõ†Â≠êÔºâ„ÄÇËøôÁßçÂèòÊç¢‰ΩøÂæóÂΩí‰∏ÄÂåñÁöÑÁªìÊûúÂèØ‰ª•ÊÅ¢Â§ç‰∏ÄÂÆöÁöÑË°®ËææËÉΩÂäõÔºåÁ±ª‰ºº‰∫é Batch Normalization ‰∏≠ÁöÑ affine ÂèòÊç¢„ÄÇ</li>
<li><strong><code>return x</code></strong>: ËøîÂõûÂΩí‰∏ÄÂåñÂπ∂ÁªèËøáÂèòÊç¢ÁöÑÁªìÊûú„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def split_states(x, n):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Reshape the last dimension of x into [n, x.shape[-1]/n].&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    *start, m = shape_list(x)
</span></span><span class="line"><span class="cl">    return tf.reshape(x, start + [n, m//n])
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ëøô‰∏™ÂáΩÊï∞ <code>split_states</code> ÁöÑ‰ΩúÁî®ÊòØÂ∞ÜËæìÂÖ•Âº†Èáè <code>x</code> ÁöÑÊúÄÂêé‰∏ÄÁª¥ÊãÜÂàÜÊàê‰∏§‰∏™ÈÉ®ÂàÜÔºåÂÖ∂‰∏≠‰∏Ä‰∏™ÈÉ®ÂàÜÁöÑÂ§ßÂ∞èÊòØ <code>n</code>ÔºåÂè¶‰∏Ä‰∏™ÈÉ®ÂàÜÁöÑÂ§ßÂ∞èÊòØ <code>m // n</code>Ôºà<code>m</code> ÊòØËæìÂÖ•Âº†ÈáèÁöÑÊúÄÂêé‰∏ÄÁª¥Â§ßÂ∞èÔºâ„ÄÇ</p>
<p><strong><code>\*start, m = shape_list(x)</code></strong>Ôºö</p>
<ul>
<li><code>shape_list(x)</code> ‰ºöËøîÂõûÂº†Èáè <code>x</code> ÁöÑÂΩ¢Áä∂Ôºà‰Ωú‰∏∫‰∏Ä‰∏™ÂàóË°®Ôºâ„ÄÇ<code>*start</code> ‰ºöÂ∞ÜÈô§‰∫ÜÊúÄÂêé‰∏ÄÁª¥‰πãÂ§ñÁöÑÊâÄÊúâÁª¥Â∫¶ÔºàÂç≥Âº†ÈáèÁöÑÂâçÂá†Áª¥ÔºâÂ≠òÂÖ• <code>start</code> ÂèòÈáè‰∏≠Ôºå<code>m</code> Âàô‰øùÂ≠òÂº†ÈáèÊúÄÂêé‰∏ÄÁª¥ÁöÑÂ§ßÂ∞è„ÄÇ</li>
<li>‰æãÂ¶ÇÔºåÂ¶ÇÊûú <code>x</code> ÁöÑÂΩ¢Áä∂ÊòØ <code>[batch_size, time_steps, features]</code>ÔºåÈÇ£‰πà <code>start</code> Â∞Ü‰øùÂ≠ò <code>[batch_size, time_steps]</code>Ôºå<code>m</code> Â∞Ü‰øùÂ≠ò <code>features</code>„ÄÇ</li>
</ul>
<p><strong><code>tf.reshape(x, start + [n, m // n])</code></strong>Ôºö</p>
<ul>
<li><code>start</code> ÊòØ <code>x</code> ÁöÑÂâçÂá†‰∏™Áª¥Â∫¶ÁöÑÂàóË°®Ôºå<code>n</code> ÊòØ‰º†ÂÖ•ÁöÑÂèÇÊï∞ÔºåË°®Á§∫‰Ω†ÊÉ≥Â∞ÜÊúÄÂêé‰∏ÄÁª¥ÊãÜÂàÜÊàê <code>n</code> ÈÉ®ÂàÜÔºå<code>m // n</code> ÊòØÊØè‰∏ÄÈÉ®ÂàÜÁöÑÂ§ßÂ∞è„ÄÇ</li>
<li><code>tf.reshape</code> ÂáΩÊï∞Â∞ÜËæìÂÖ•Âº†Èáè <code>x</code> ÈáçÊñ∞Ë∞ÉÊï¥ÂΩ¢Áä∂ÔºåÂΩ¢Áä∂Âèò‰∏∫ <code>[start, n, m // n]</code>„ÄÇ</li>
<li>‰æãÂ¶ÇÔºåÂ¶ÇÊûú <code>x</code> ÁöÑÂΩ¢Áä∂ÊòØ <code>[batch_size, time_steps, features]</code>ÔºåÂπ∂‰∏î‰º†ÂÖ• <code>n = 2</code>ÔºåÈÇ£‰πàÊñ∞ÁöÑÂΩ¢Áä∂Â∞ÜÊòØ <code>[batch_size, time_steps, 2, features // 2]</code>„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def merge_states(x):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Smash the last two dimensions of x into a single dimension.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    *start, a, b = shape_list(x)
</span></span><span class="line"><span class="cl">    return tf.reshape(x, start + [a*b])
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ëøô‰∏™ÂáΩÊï∞ <code>merge_states</code> ÁöÑ‰ΩúÁî®ÊòØÂ∞ÜËæìÂÖ•Âº†Èáè <code>x</code> ÁöÑÊúÄÂêé‰∏§‰∏™Áª¥Â∫¶ÂêàÂπ∂Êàê‰∏Ä‰∏™Áª¥Â∫¶„ÄÇ‰πüÂ∞±ÊòØËØ¥ÔºåÂÆÉÈÄöËøáÂ∞ÜÊúÄÂêé‰∏§‰∏™Áª¥Â∫¶Áõ∏‰πòÔºåÂ∞ÜÂÆÉ‰ª¨‚ÄúÂéãÊâÅ‚Äù‰∏∫‰∏Ä‰∏™Êñ∞ÁöÑÁª¥Â∫¶„ÄÇ</p>
<p><strong><code>\*start, a, b = shape_list(x)</code></strong>:</p>
<ul>
<li><code>shape_list(x)</code> ËøîÂõûÂº†Èáè <code>x</code> ÁöÑÂΩ¢Áä∂Ôºå‰Ωú‰∏∫‰∏Ä‰∏™ÂàóË°®„ÄÇ</li>
<li><code>*start</code> ‰ºöÂ∞Ü <code>x</code> ÁöÑÊâÄÊúâÁª¥Â∫¶ÔºàÈô§‰∫ÜÊúÄÂêé‰∏§‰∏™Áª¥Â∫¶ÔºâÂ≠òÂÖ• <code>start</code>Ôºå<code>a</code> Âíå <code>b</code> ÂàÜÂà´‰øùÂ≠ò <code>x</code> ÁöÑÂÄíÊï∞Á¨¨‰∫åÁª¥ÂíåÊúÄÂêé‰∏ÄÁª¥ÁöÑÂ§ßÂ∞è„ÄÇ</li>
</ul>
<p>‰∏æ‰∏™‰æãÂ≠êÔºö</p>
<ul>
<li>ÂÅáËÆæ <code>x</code> ÁöÑÂΩ¢Áä∂ÊòØ <code>[batch_size, time_steps, features, channels]</code>ÔºåÈÇ£‰πà <code>start = [batch_size, time_steps, features]</code>Ôºå<code>a = features</code>Ôºå<code>b = channels</code>„ÄÇ</li>
</ul>
<p><strong><code>tf.reshape(x, start + [a \* b])</code></strong>:</p>
<ul>
<li><code>tf.reshape(x, start + [a * b])</code> ‰ºöÂ∞Ü <code>x</code> ÈáçÊñ∞Ë∞ÉÊï¥ÂΩ¢Áä∂ÔºåÊñ∞ÁöÑÂΩ¢Áä∂Áî± <code>start</code>ÔºàÂéüÂÖàÁöÑÊâÄÊúâÁª¥Â∫¶ÔºåÈô§‰∫ÜÊúÄÂêé‰∏§‰∏™ÔºâÂíå <code>a * b</code>ÔºàÂ∞ÜÊúÄÂêé‰∏§‰∏™Áª¥Â∫¶Áõ∏‰πòÁöÑÁªìÊûúÔºâÁªÑÊàê„ÄÇ</li>
<li><code>a * b</code> ÊòØÂ∞ÜÂéüÊú¨ÁöÑÊúÄÂêé‰∏§‰∏™Áª¥Â∫¶ÂêàÂπ∂Êàê‰∏Ä‰∏™Êñ∞ÁöÑÁª¥Â∫¶„ÄÇ</li>
</ul>
<p>Ëøô‰∏™ <code>conv1d</code> ÂáΩÊï∞ÂÆûÁé∞‰∫Ü‰∏Ä‰∏™ <strong>1D Âç∑ÁßØ</strong> Êìç‰Ωú„ÄÇËôΩÁÑ∂ÂÆÉÁöÑÂêçÂ≠óÂíå‰º†ÁªüÁöÑ 1D Âç∑ÁßØÁ±ª‰ººÔºå‰ΩÜÂÆÉÂÆûÈôÖ‰∏äÈÄöËøáÁü©Èòµ‰πòÊ≥ïÂíåÈÄÇÂΩìÁöÑÂΩ¢Áä∂ÂèòÊç¢Êù•Ê®°Êãü 1D Âç∑ÁßØÁöÑÊìç‰Ωú„ÄÇ‰ª•‰∏ãÊòØ‰ª£Á†ÅÈÄêË°åËß£ÈáäÔºö</p>
<h3 id="‰ª£Á†ÅËß£Èáä">‰ª£Á†ÅËß£ÈáäÔºö
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conv1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">w_init_stdev</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">shape_list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nf</span><span class="p">],</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal_initializer</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="n">w_init_stdev</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">nf</span><span class="p">],</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nf</span><span class="p">]))</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="p">[</span><span class="n">nf</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">c</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><strong><code>\*start, nx = shape_list(x)</code></strong>:
<ul>
<li><code>shape_list(x)</code> ËøîÂõûÂº†Èáè <code>x</code> ÁöÑÂΩ¢Áä∂Ôºå‰Ωú‰∏∫‰∏Ä‰∏™ÂàóË°®„ÄÇ<code>*start</code> ‰ºöÂ∞ÜÈô§‰∫ÜÊúÄÂêé‰∏ÄÁª¥‰πãÂ§ñÁöÑÊâÄÊúâÁª¥Â∫¶ÔºàÂç≥Âº†ÈáèÁöÑÂâçÂá†Áª¥ÔºâÂ≠òÂÖ• <code>start</code>Ôºå<code>nx</code> ‰øùÂ≠ò <code>x</code> ÁöÑÊúÄÂêé‰∏ÄÁª¥Â§ßÂ∞è„ÄÇ</li>
<li>ÊØîÂ¶ÇÔºåÂ¶ÇÊûú <code>x</code> ÁöÑÂΩ¢Áä∂ÊòØ <code>[batch_size, length, in_channels]</code>ÔºåÈÇ£‰πà <code>start</code> Â∞ÜÊòØ <code>[batch_size, length]</code>Ôºå<code>nx</code> Â∞±ÊòØ <code>in_channels</code>„ÄÇ</li>
</ul>
</li>
<li><strong><code>w = tf.get_variable('w', [1, nx, nf], initializer=tf.random_normal_initializer(stddev=w_init_stdev))</code></strong>:
<ul>
<li>ÂàõÂª∫‰∏Ä‰∏™Âç∑ÁßØÊ†∏ÔºàÊùÉÈáçÔºâ <code>w</code>ÔºåÂÖ∂ÂΩ¢Áä∂‰∏∫ <code>[1, nx, nf]</code>„ÄÇËøôÈáåÁöÑ <code>1</code> ÊòØÂç∑ÁßØÊ†∏ÁöÑÂ§ßÂ∞èÔºàÂç≥Âç∑ÁßØÊìç‰ΩúÊòØ 1D ÁöÑÔºâÔºå<code>nx</code> ÊòØËæìÂÖ•ÁöÑÊúÄÂêé‰∏ÄÁª¥Â§ßÂ∞èÔºàÈÄöÂ∏∏ÊòØËæìÂÖ•ÈÄöÈÅìÊï∞ÔºâÔºå<code>nf</code> ÊòØÂç∑ÁßØÊìç‰ΩúÂêéËæìÂá∫ÈÄöÈÅìÁöÑÊï∞Èáè„ÄÇ</li>
<li><code>initializer=tf.random_normal_initializer(stddev=w_init_stdev)</code> ÂàùÂßãÂåñÊùÉÈáçÂÄº‰∏∫‰ªéÊ≠£ÊÄÅÂàÜÂ∏É‰∏≠ÈááÊ†∑ÔºåÊ†áÂáÜÂ∑Æ‰∏∫ <code>w_init_stdev</code>ÔºåÈªòËÆ§‰∏∫ <code>0.02</code>„ÄÇ</li>
</ul>
</li>
<li><strong><code>b = tf.get_variable('b', [nf], initializer=tf.constant_initializer(0))</code></strong>:
<ul>
<li>ÂàõÂª∫ÂÅèÁΩÆ <code>b</code>ÔºåÂÖ∂ÂΩ¢Áä∂‰∏∫ <code>[nf]</code>ÔºåÂç≥‰∏éËæìÂá∫ÈÄöÈÅìÊï∞Áõ∏ÂêåÔºåÂàùÂßãÂåñ‰∏∫Èõ∂„ÄÇ</li>
</ul>
</li>
<li><strong><code>c = tf.reshape(tf.matmul(tf.reshape(x, [-1, nx]), tf.reshape(w, [-1, nf])) + b, start + [nf])</code></strong>:
<ul>
<li><strong><code>tf.reshape(x, [-1, nx])</code></strong>: Â∞ÜËæìÂÖ•Âº†Èáè <code>x</code> ÈáçÂ°ë‰∏∫ÂΩ¢Áä∂ <code>[-1, nx]</code>ÔºåÂç≥Â∞ÜÊâÄÊúâÂâçÈù¢ÁöÑÁª¥Â∫¶Â±ïÂπ≥Ôºå‰øùÁïôÊúÄÂêé‰∏ÄÁª¥ <code>nx</code>„ÄÇËøô‰∏ÄÊ≠•Áõ∏ÂΩì‰∫éÂ∞ÜËæìÂÖ•ÁöÑÂ§öÁª¥Âº†ÈáèÂ±ïÂπ≥Êàê‰∫åÁª¥Áü©ÈòµÔºåÊØè‰∏ÄË°å‰ª£Ë°®‰∏Ä‰∏™Êï∞ÊçÆÊ†∑Êú¨ÁöÑËæìÂÖ•ÈÄöÈÅì„ÄÇ</li>
<li><strong><code>tf.reshape(w, [-1, nf])</code></strong>: Â∞ÜÂç∑ÁßØÊ†∏ <code>w</code> ÈáçÂ°ë‰∏∫ÂΩ¢Áä∂ <code>[-1, nf]</code>ÔºåËøôÊÑèÂë≥ÁùÄÂç∑ÁßØÊ†∏ÁöÑÊùÉÈáçË¢´Â±ïÂπ≥‰∏∫‰∏Ä‰∏™Áü©ÈòµÔºåÂÖ∂‰∏≠ÊØè‰∏™ËæìÂÖ•ÈÄöÈÅìÁöÑÊùÉÈáçË¢´ÂàÜÈÖçÂà∞ËæìÂá∫ÈÄöÈÅì„ÄÇ</li>
<li><strong><code>tf.matmul(...)</code></strong>: ÊâßË°åÁü©Èòµ‰πòÊ≥ï„ÄÇÊ≠§Â§ÑÊòØÂ∞ÜÂ±ïÂπ≥ÂêéÁöÑËæìÂÖ•Âº†Èáè <code>x</code> ‰∏éÂ±ïÂπ≥ÂêéÁöÑÂç∑ÁßØÊ†∏ <code>w</code> Áõ∏‰πòÔºåÁ±ª‰ºº‰∫éÂç∑ÁßØÊìç‰Ωú‰∏≠ÁöÑÂä†ÊùÉÊ±ÇÂíåËøáÁ®ã„ÄÇ</li>
<li><strong><code>+ b</code></strong>: Â∞ÜÂÅèÁΩÆÂä†Âà∞ÁªìÊûú‰∏≠„ÄÇ</li>
<li><strong><code>tf.reshape(..., start + [nf])</code></strong>: Â∞ÜÁü©Èòµ‰πòÊ≥ïÂêéÁöÑÁªìÊûúÂÜçÈáçÂ°ëÂõûÂéüÊù•ÁöÑÂΩ¢Áä∂Ôºå‰øùÁïôÈô§‰∫ÜÊúÄÂêé‰∏ÄÁª¥‰ª•Â§ñÁöÑÊâÄÊúâÁª¥Â∫¶ÔºåÊúÄÂêé‰∏ÄÁª¥Âèò‰∏∫ <code>nf</code>ÔºåÂç≥ËæìÂá∫ÈÄöÈÅìÊï∞„ÄÇ</li>
</ul>
</li>
<li><strong><code>return c</code></strong>:
<ul>
<li>ËøîÂõûÂç∑ÁßØÊìç‰ΩúÂêéÁöÑÁªìÊûú <code>c</code>ÔºåÂÆÉÁöÑÂΩ¢Áä∂ÊòØ <code>[batch_size, length, nf]</code>ÔºåÂç≥ËæìÂá∫ÁöÑÊâπÊ¨°Â§ßÂ∞è„ÄÅÈïøÂ∫¶ÂíåËæìÂá∫ÈÄöÈÅìÊï∞„ÄÇ</li>
</ul>
</li>
</ol>
<h3 id="ÊÄªÁªì">ÊÄªÁªìÔºö
</h3><p>Ëøô‰∏™ <code>conv1d</code> ÂáΩÊï∞ÂÆûÁé∞ÁöÑÊòØ‰∏ÄÁßçÈÄöËøáÁü©Èòµ‰πòÊ≥ïÊ®°Êãü 1D Âç∑ÁßØÊìç‰ΩúÁöÑÊñπÂºè„ÄÇ‰º†ÁªüÁöÑ 1D Âç∑ÁßØÈÄöËøáÊªëÂä®Á™óÂè£ÂØπËæìÂÖ•ËøõË°åÂ±ÄÈÉ®Âä†ÊùÉÊ±ÇÂíåÔºåËÄåËøô‰∏™ÂÆûÁé∞ÈÄöËøáÂ∞ÜËæìÂÖ•Â±ïÂπ≥ÊàêÁü©ÈòµÂêé‰∏éÂç∑ÁßØÊ†∏ËøõË°åÁü©Èòµ‰πòÊ≥ïÔºå‰ªéËÄåÂÆûÁé∞Á±ª‰ººÁöÑÊïàÊûú„ÄÇ</p>
<h3 id="‰∏ªË¶ÅÁâπÁÇπ">‰∏ªË¶ÅÁâπÁÇπÔºö
</h3><ul>
<li><strong>ÊùÉÈáçÂΩ¢Áä∂</strong>Ôºö<code>[1, nx, nf]</code>ÔºåË°®Á§∫Âç∑ÁßØÊ†∏ÁöÑÂ§ßÂ∞è‰∏∫ <code>1xnx</code>ÔºåÂç≥Âç∑ÁßØÊìç‰ΩúÊòØÂØπËæìÂÖ•ÁöÑÊØè‰∏™‰ΩçÁΩÆËøõË°åÂä†ÊùÉÊ±ÇÂíåÔºåËæìÂá∫ÈÄöÈÅìÊï∞‰∏∫ <code>nf</code>„ÄÇ</li>
<li><strong>Áü©Èòµ‰πòÊ≥ïÂÆûÁé∞Âç∑ÁßØ</strong>ÔºöÈÄöËøá <code>tf.matmul</code> Â∞ÜËæìÂÖ•Âº†ÈáèÂíåÂç∑ÁßØÊ†∏ÂÅöÁü©Èòµ‰πòÊ≥ïÔºåËÄå‰∏çÊòØ‰º†ÁªüÁöÑÊªëÂä®Á™óÂè£Âç∑ÁßØ„ÄÇ</li>
<li><strong>Â±ïÂπ≥Êìç‰Ωú</strong>ÔºöËæìÂÖ•Âº†ÈáèÂíåÂç∑ÁßØÊ†∏ÈÉΩÈÄöËøá <code>tf.reshape</code> ËøõË°å‰∫ÜÂ±ïÂπ≥Â§ÑÁêÜÔºå‰ª•‰æøËøõË°åÁü©Èòµ‰πòÊ≥ï„ÄÇ</li>
</ul>
<p>ËøôÁßçÊñπÊ≥ïËôΩÁÑ∂Âú®ÂÆûÁé∞‰∏ä‰∏é‰º†ÁªüÁöÑÂç∑ÁßØ‰∏çÂêåÔºå‰ΩÜÊïàÊûúÊòØÁõ∏ÂêåÁöÑÔºåÂπ∂‰∏îÂèØ‰ª•ÈÄöËøáÁü©Èòµ‰πòÊ≥ïÁöÑÊñπÂºèÊèêÈ´òËÆ°ÁÆóÊïàÁéáÊàñÈÄÇÂ∫îÊüê‰∫õÁâπÂÆöÁöÑ‰ªªÂä°ÈúÄÊ±Ç„ÄÇ</p>
<p>ËøôÊÆµ‰ª£Á†ÅÂÆö‰πâ‰∫Ü‰∏Ä‰∏™ÂáΩÊï∞ <code>attention_mask</code>ÔºåÁî®‰∫éÁîüÊàêÊ≥®ÊÑèÂäõÊé©Á†ÅÔºàattention maskÔºâ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">attention_mask</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;1&#39;s in the lower triangle, counting from the lower right corner.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Same as tf.matrix_band_part(tf.ones([nd, ns]), -1, ns-nd), but doesn&#39;t produce garbage on TPUs.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">nd</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">j</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">ns</span> <span class="o">+</span> <span class="n">nd</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ëøô‰∏™ÂáΩÊï∞ÂÆûÁé∞‰∫Ü‰∏Ä‰∏™Â§öÂ§¥Ê≥®ÊÑèÂäõÔºàMulti-head AttentionÔºâÊú∫Âà∂Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">n_state</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">past</span><span class="p">,</span> <span class="n">hparams</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">ndims</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># Should be [batch, sequence, features]</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">n_state</span> <span class="o">%</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_head</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">past</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">past</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">ndims</span> <span class="o">==</span> <span class="mi">5</span>  <span class="c1"># Should be [batch, 2, heads, sequence, features], where 2 is [k, v]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">split_heads</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># From [batch, sequence, features] to [batch, heads, sequence, features]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">split_states</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_head</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">merge_heads</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Reverse of split_heads</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">merge_states</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mask_attn_weights</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># w has shape [batch, heads, dst_sequence, src_sequence], where information flows from src to dst.</span>
</span></span><span class="line"><span class="cl">        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">shape_list</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">b</span> <span class="o">=</span> <span class="n">attention_mask</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">b</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="mf">1e10</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">w</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">multihead_attn</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># q, k, v have shape [batch, heads, sequence, features]</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">rsqrt</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="n">mask_attn_weights</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">=</span> <span class="n">conv1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;c_attn&#39;</span><span class="p">,</span> <span class="n">n_state</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">split_heads</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">present</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">past</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pk</span><span class="p">,</span> <span class="n">pv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">past</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">k</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pk</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pv</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="n">multihead_attn</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="n">merge_heads</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="n">conv1d</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;c_proj&#39;</span><span class="p">,</span> <span class="n">n_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">present</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÊÆµ‰ª£Á†ÅÂÆö‰πâ‰∫Ü‰∏Ä‰∏™Â§öÂ±ÇÊÑüÁü•Êú∫ (MLP) Ê®°ÂùóÔºåÈÄöÂ∏∏Âú®Ê∑±Â∫¶Â≠¶‰π†Ê®°Âûã‰∏≠Áî®‰∫éÈùûÁ∫øÊÄßÂèòÊç¢Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mlp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">n_state</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">hparams</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">nx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="n">gelu</span><span class="p">(</span><span class="n">conv1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;c_fc&#39;</span><span class="p">,</span> <span class="n">n_state</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">h2</span> <span class="o">=</span> <span class="n">conv1d</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;c_proj&#39;</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">h2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÊÆµ‰ª£Á†ÅÂÆûÁé∞‰∫Ü‰∏Ä‰∏™Ê†áÂáÜÁöÑ Transformer ÂùóÔºåÂÖ∂‰∏≠ÂåÖÊã¨‰ª•‰∏ãÊ≠•È™§Ôºö</p>
<ol>
<li><strong>Â±ÇÂΩí‰∏ÄÂåñ + Ëá™Ê≥®ÊÑèÂäõÊú∫Âà∂ + ÊÆãÂ∑ÆËøûÊé•</strong>„ÄÇ</li>
<li><strong>Â±ÇÂΩí‰∏ÄÂåñ + Â§öÂ±ÇÊÑüÁü•Êú∫ÔºàMLPÔºâ + ÊÆãÂ∑ÆËøûÊé•</strong>„ÄÇ</li>
<li>ËøîÂõûÊõ¥Êñ∞ÂêéÁöÑËæìÂá∫ <code>x</code> ÂíåÊ≥®ÊÑèÂäõÂ±ÇÁöÑÁºìÂ≠ò <code>present</code>„ÄÇ</li>
</ol>
<p>Ëøô‰∏™ËÆæËÆ°Á¨¶Âêà Transformer Ê®°ÂûãÁöÑÊ†áÂáÜÁªìÊûÑÔºåÈÄÇÁî®‰∫éËá™ÁÑ∂ËØ≠Ë®ÄÂ§ÑÁêÜ‰ªªÂä°‰∏≠ÁöÑÂ∫èÂàóÂª∫Ê®°„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">past</span><span class="p">,</span> <span class="n">hparams</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">nx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span><span class="p">,</span> <span class="n">present</span> <span class="o">=</span> <span class="n">attn</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;ln_1&#39;</span><span class="p">),</span> <span class="s1">&#39;attn&#39;</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="n">past</span><span class="p">,</span> <span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;ln_2&#39;</span><span class="p">),</span> <span class="s1">&#39;mlp&#39;</span><span class="p">,</span> <span class="n">nx</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">m</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">present</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong><code>past_shape</code></strong>: ÂÆö‰πâÁºìÂ≠òÂº†ÈáèÁöÑÂΩ¢Áä∂ÔºåÁî®‰∫éÂ≠òÂÇ®Ê≥®ÊÑèÂäõÁöÑ Key Âíå Value„ÄÇ</p>
<p><strong><code>expand_tile</code></strong>: Êâ©Â±ïËæìÂÖ•Âº†ÈáèÁöÑÁª¥Â∫¶ÔºåÂπ∂Â§çÂà∂‰ª•ÈÄÇÈÖçÊâπÈáèÂ§ÑÁêÜ„ÄÇ</p>
<p><strong><code>positions_for</code></strong>: ÁîüÊàê‰ΩçÁΩÆÁ¥¢ÂºïÂ∫èÂàóÔºåÂπ∂ËÄÉËôëÂéÜÂè≤Êó∂Èó¥Ê≠•ÂÅèÁßª„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def past_shape(*, hparams, batch_size=None, sequence=None):
</span></span><span class="line"><span class="cl">    return [batch_size, hparams.n_layer, 2, hparams.n_head, sequence, hparams.n_embd // hparams.n_head]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def expand_tile(value, size):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Add a new axis of given size.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    value = tf.convert_to_tensor(value, name=&#39;value&#39;)
</span></span><span class="line"><span class="cl">    ndims = value.shape.ndims
</span></span><span class="line"><span class="cl">    return tf.tile(tf.expand_dims(value, axis=0), [size] + [1]*ndims)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def positions_for(tokens, past_length):
</span></span><span class="line"><span class="cl">    batch_size = tf.shape(tokens)[0]
</span></span><span class="line"><span class="cl">    nsteps = tf.shape(tokens)[1]
</span></span><span class="line"><span class="cl">    return expand_tile(past_length + tf.range(nsteps), batch_size)
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">batch</span><span class="p">,</span> <span class="n">sequence</span> <span class="o">=</span> <span class="n">shape_list</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">wpe</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;wpe&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span><span class="p">,</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_embd</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal_initializer</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">wte</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;wte&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">hparams</span><span class="o">.</span><span class="n">n_vocab</span><span class="p">,</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_embd</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                             <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal_initializer</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">0.02</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">past_length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">past</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">past</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">wte</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">wpe</span><span class="p">,</span> <span class="n">positions_for</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">past_length</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Transformer</span>
</span></span><span class="line"><span class="cl">        <span class="n">presents</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">pasts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">past</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">past</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_layer</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pasts</span><span class="p">)</span> <span class="o">==</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_layer</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">past</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pasts</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">h</span><span class="p">,</span> <span class="n">present</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;h</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">layer</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="n">past</span><span class="p">,</span> <span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">presents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">present</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;present&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">presents</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;ln_f&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Language model loss.  Do tokens &lt;n predict token n?</span>
</span></span><span class="line"><span class="cl">        <span class="n">h_flat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="p">[</span><span class="n">batch</span><span class="o">*</span><span class="n">sequence</span><span class="p">,</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_embd</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">h_flat</span><span class="p">,</span> <span class="n">wte</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="p">[</span><span class="n">batch</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_vocab</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;logits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logits</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">results</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÊÆµ‰ª£Á†ÅÂÆö‰πâ‰∫Ü‰∏Ä‰∏™Ê∑±Â∫¶Â≠¶‰π†Ê®°Âûã <code>model</code>ÔºåÂÆÉÂÆûÁé∞‰∫Ü‰∏Ä‰∏™Âü∫‰∫é Transformer ÁöÑËØ≠Ë®ÄÊ®°ÂûãÔºàÂ¶Ç GPTÔºâ„ÄÇ‰ª•‰∏ãÊòØ‰ª£Á†ÅÁöÑËØ¶ÁªÜËß£ÈáäÔºö</p>
<hr>
<h3 id="ÂáΩÊï∞Á≠æÂêç">ÂáΩÊï∞Á≠æÂêç
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÂèÇÊï∞">ÂèÇÊï∞Ôºö
</h4><ul>
<li>
<p><strong><code>hparams</code></strong>: Ë∂ÖÂèÇÊï∞ÂØπË±°ÔºåÂåÖÂê´Ê®°ÂûãÁöÑÈÖçÁΩÆÔºàÂ¶ÇÂµåÂÖ•Áª¥Â∫¶„ÄÅ‰∏ä‰∏ãÊñáÈïøÂ∫¶„ÄÅËØçÊ±áË°®Â§ßÂ∞èÁ≠âÔºâ„ÄÇ</p>
</li>
<li>
<p><strong><code>X</code></strong>: ËæìÂÖ•Âº†ÈáèÔºåÂΩ¢Áä∂‰∏∫ <code>[batch_size, sequence_length]</code>ÔºåË°®Á§∫ËæìÂÖ•ÁöÑ token Â∫èÂàóÔºàÈÄöÂ∏∏ÊòØËØçÁöÑÁ¥¢ÂºïÔºâ„ÄÇ</p>
</li>
<li>
<dl>
<dt><code>past</code></dt>
<dd>
<p>ÁºìÂ≠òÂº†ÈáèÔºåÂ≠òÂÇ®Êù•Ëá™ÂÖàÂâçÊó∂Èó¥Ê≠•ÁöÑÊ≥®ÊÑèÂäõÁä∂ÊÄÅÔºàKey Âíå ValueÔºâ„ÄÇÂΩ¢Áä∂‰∏∫Ôºö</p>
</dd>
</dl>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">n_layer</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">past_length</span><span class="p">,</span> <span class="n">n_embd</span><span class="o">//</span><span class="n">n_head</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Â¶ÇÊûú‰∏∫Á©∫ÔºåÂàôË°®Á§∫Ê®°Âûã‰ªéÂ§¥ÂºÄÂßãÊé®ÁêÜ„ÄÇ</p>
</li>
<li>
<p><strong><code>scope</code></strong>: ÂèòÈáè‰ΩúÁî®ÂüüÁöÑÂêçÁß∞„ÄÇ</p>
</li>
<li>
<p><strong><code>reuse</code></strong>: ÊòØÂê¶ÈáçÁî®‰ΩúÁî®ÂüüÂÜÖÁöÑÂèòÈáèÔºàÁî®‰∫éÂèòÈáèÂÖ±‰∫´Ôºâ„ÄÇ</p>
</li>
</ul>
<h4 id="ËøîÂõûÂÄº">ËøîÂõûÂÄºÔºö
</h4><p>‰∏Ä‰∏™Â≠óÂÖ∏ <code>results</code>ÔºåÂåÖÂê´Ôºö</p>
<ul>
<li><strong><code>present</code></strong>: ÂΩìÂâçÂ±ÇÁöÑÊ≥®ÊÑèÂäõÁºìÂ≠òÁä∂ÊÄÅ„ÄÇ</li>
<li><strong><code>logits</code></strong>: Ê®°ÂûãÁöÑËæìÂá∫ÔºàÊú™ÂΩí‰∏ÄÂåñÁöÑÊ¶ÇÁéáÂàÜÂ∏ÉÔºâ„ÄÇ</li>
</ul>
<hr>
<h3 id="Ê®°ÂûãÂÆûÁé∞">Ê®°ÂûãÂÆûÁé∞
</h3><h4 id="1-ÂÆö‰πâÂèòÈáè‰ΩúÁî®Âüü">1. ÂÆö‰πâÂèòÈáè‰ΩúÁî®Âüü
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>‰ΩøÁî® TensorFlow ÁöÑÂèòÈáè‰ΩúÁî®ÂüüÔºåÁ°Æ‰øùÂèòÈáèÂëΩÂêçÂîØ‰∏ÄÔºåÂπ∂ÊîØÊåÅÂèòÈáèÂÖ±‰∫´„ÄÇ</li>
</ul>
<h4 id="2-ÂàùÂßãÂåñÂèòÈáè">2. ÂàùÂßãÂåñÂèòÈáè
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">batch</span><span class="p">,</span> <span class="n">sequence</span> <span class="o">=</span> <span class="n">shape_list</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>‰ΩøÁî® <code>shape_list</code> Ëé∑ÂèñËæìÂÖ• <code>X</code> ÁöÑÊâπÊ¨°Â§ßÂ∞èÔºà<code>batch</code>ÔºâÂíåÂ∫èÂàóÈïøÂ∫¶Ôºà<code>sequence</code>Ôºâ„ÄÇ</li>
</ul>
<h4 id="3-ÂÆö‰πâÂµåÂÖ•Áü©Èòµ">3. ÂÆö‰πâÂµåÂÖ•Áü©Èòµ
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">wpe</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;wpe&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span><span class="p">,</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_embd</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                      <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal_initializer</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">wte</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;wte&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">hparams</span><span class="o">.</span><span class="n">n_vocab</span><span class="p">,</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_embd</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                      <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">random_normal_initializer</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">0.02</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>wpe</code></strong>: ‰ΩçÁΩÆÂµåÂÖ•Áü©ÈòµÔºåÂΩ¢Áä∂‰∏∫ <code>[‰∏ä‰∏ãÊñáÈïøÂ∫¶, ÂµåÂÖ•Áª¥Â∫¶]</code>„ÄÇ</li>
<li><strong><code>wte</code></strong>: ËØçÂµåÂÖ•Áü©ÈòµÔºåÂΩ¢Áä∂‰∏∫ <code>[ËØçÊ±áË°®Â§ßÂ∞è, ÂµåÂÖ•Áª¥Â∫¶]</code>„ÄÇ</li>
<li>‰ΩøÁî®ÈöèÊú∫Ê≠£ÊÄÅÂàÜÂ∏ÉÂàùÂßãÂåñÊùÉÈáç„ÄÇ</li>
</ul>
<h4 id="4-ËÆ°ÁÆó‰ΩçÁΩÆÂÅèÁßª">4. ËÆ°ÁÆó‰ΩçÁΩÆÂÅèÁßª
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">past_length</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">past</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">past</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">wte</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">wpe</span><span class="p">,</span> <span class="n">positions_for</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">past_length</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>past_length</code></strong>: Â¶ÇÊûúÊ≤°ÊúâÁºìÂ≠ò <code>past</code>ÔºåÂàô <code>past_length=0</code>ÔºåÂê¶Âàô‰∏∫ÁºìÂ≠òÁöÑÊó∂Èó¥Ê≠•ÈïøÂ∫¶„ÄÇ</li>
<li><strong><code>tf.gather(wte, X)</code></strong>: ÈÄöËøáÁ¥¢Âºï <code>X</code> Ëé∑ÂèñËØçÂµåÂÖ•„ÄÇ</li>
<li><strong><code>tf.gather(wpe, positions_for(X, past_length))</code></strong>: Ëé∑Âèñ‰ΩçÁΩÆÂµåÂÖ•ÔºàÂà©Áî® <code>positions_for</code> ÁîüÊàê‰ΩçÁΩÆÁ¥¢ÂºïÔºâ„ÄÇ</li>
<li>Â∞ÜËØçÂµåÂÖ•Âíå‰ΩçÁΩÆÂµåÂÖ•Áõ∏Âä†ÔºåÂæóÂà∞ÂàùÂßãÁöÑËæìÂÖ•Ë°®Á§∫ <code>h</code>„ÄÇ</li>
</ul>
<hr>
<h4 id="5-transformer-Â±ÇÁöÑÂâçÂêëËÆ°ÁÆó">5. Transformer Â±ÇÁöÑÂâçÂêëËÆ°ÁÆó
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">presents</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">pasts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">past</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">past</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_layer</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pasts</span><span class="p">)</span> <span class="o">==</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_layer</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>presents</code></strong>: Â≠òÂÇ®ÂΩìÂâçÂ±ÇÁöÑÊ≥®ÊÑèÂäõÁä∂ÊÄÅÔºàKey Âíå ValueÔºâ„ÄÇ</li>
<li><strong><code>pasts</code></strong>: Â¶ÇÊûúÂ≠òÂú®ÁºìÂ≠òÔºåÂàôÊåâÂ±ÇËß£ÂåÖÁºìÂ≠òÂº†ÈáèÔºõÂê¶ÂàôÂàùÂßãÂåñ‰∏∫Á©∫„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">past</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pasts</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">h</span><span class="p">,</span> <span class="n">present</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;h</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">layer</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="n">past</span><span class="p">,</span> <span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">presents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">present</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">results</span><span class="p">[</span><span class="s1">&#39;present&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">presents</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>ÈÅçÂéÜÊØè‰∏ÄÂ±ÇÁöÑ Transformer Âùó Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">block
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>‰º†ÂÖ•ËæìÂÖ•Ë°®Á§∫ <code>h</code> ÂíåÂΩìÂâçÂ±ÇÁöÑÁºìÂ≠òÁä∂ÊÄÅ <code>past</code>„ÄÇ</li>
<li>ËÆ°ÁÆóËæìÂá∫ <code>h</code> ÂíåÂΩìÂâçÂ±ÇÁöÑÊ≥®ÊÑèÂäõÁä∂ÊÄÅ <code>present</code>„ÄÇ</li>
</ul>
</li>
<li>
<p>Â∞ÜÊâÄÊúâÂ±ÇÁöÑ <code>present</code> Â†ÜÂè†ÔºåÂΩ¢Áä∂‰∏∫ <code>[batch_size, n_layer, 2, n_head, sequence, n_embd//n_head]</code>ÔºåÂπ∂Â≠òÂÖ•ÁªìÊûúÂ≠óÂÖ∏„ÄÇ</p>
</li>
</ul>
<hr>
<h4 id="6-ËæìÂá∫Â±ÇÂΩí‰∏ÄÂåñ">6. ËæìÂá∫Â±ÇÂΩí‰∏ÄÂåñ
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">h</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;ln_f&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂØπÊúÄÂêé‰∏ÄÂ±ÇÁöÑËæìÂá∫ <code>h</code> ËøõË°åÂ±ÇÂΩí‰∏ÄÂåñÔºàLayer NormalizationÔºâ„ÄÇ</li>
</ul>
<hr>
<h4 id="7-ËæìÂá∫Â±ÇËÆ°ÁÆó">7. ËæìÂá∫Â±ÇËÆ°ÁÆó
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">h_flat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="p">[</span><span class="n">batch</span><span class="o">*</span><span class="n">sequence</span><span class="p">,</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_embd</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">h_flat</span><span class="p">,</span> <span class="n">wte</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="p">[</span><span class="n">batch</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_vocab</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">results</span><span class="p">[</span><span class="s1">&#39;logits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logits</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>h_flat</code></strong>: Â∞Ü <code>h</code> ÈáçÂ°ë‰∏∫‰∫åÁª¥Âº†Èáè <code>[batch*sequence, ÂµåÂÖ•Áª¥Â∫¶]</code>ÔºåÊñπ‰æøÂêéÁª≠Áü©Èòµ‰πòÊ≥ïÊìç‰Ωú„ÄÇ</li>
<li><code>logits</code>:
<ul>
<li>‰∏éËØçÂµåÂÖ•Áü©Èòµ <code>wte</code> ÁöÑËΩ¨ÁΩÆÁõ∏‰πòÔºåËÆ°ÁÆóÊØè‰∏™ token ÁöÑÂæóÂàÜÔºàÊú™ÂΩí‰∏ÄÂåñÊ¶ÇÁéáÔºâ„ÄÇ</li>
<li>Â∞ÜÁªìÊûúÈáçÂ°ë‰∏∫ <code>[batch, sequence, vocab_size]</code>„ÄÇ</li>
</ul>
</li>
<li>Â∞Ü <code>logits</code> Â≠òÂÖ•ÁªìÊûúÂ≠óÂÖ∏„ÄÇ</li>
</ul>
<hr>
<h3 id="ÊÄªÁªì-1">ÊÄªÁªì
</h3><ul>
<li><strong>ËæìÂÖ•</strong>ÔºöËØçÂ∫èÂàó <code>X</code> ÂíåÁºìÂ≠òÁä∂ÊÄÅ <code>past</code>„ÄÇ</li>
<li><strong>ËØçÂíå‰ΩçÁΩÆÂµåÂÖ•</strong>ÔºöÈÄöËøáËØçÂµåÂÖ•Âíå‰ΩçÁΩÆÂµåÂÖ•ÂàùÂßãÂåñËæìÂÖ•Ë°®Á§∫„ÄÇ</li>
<li>Transformer Â±ÇÔºö
<ul>
<li>ÈÄöËøáÂ§öÂ±Ç Transformer ÂùóÔºàÂåÖÂê´Ê≥®ÊÑèÂäõÊú∫Âà∂Âíå MLPÔºâËÆ°ÁÆóË°®Á§∫„ÄÇ</li>
<li>‰øùÂ≠òÂΩìÂâçÊó∂Èó¥Ê≠•ÁöÑÊ≥®ÊÑèÂäõÁä∂ÊÄÅ„ÄÇ</li>
</ul>
</li>
<li><strong>ËæìÂá∫Â±Ç</strong>ÔºöÈÄöËøáËØçÂµåÂÖ•Áü©ÈòµÁöÑËΩ¨ÁΩÆËÆ°ÁÆóÊØè‰∏™ token ÁöÑ logits„ÄÇ</li>
<li>ËøîÂõûÂÄºÔºö
<ul>
<li><strong><code>present</code></strong>ÔºöÂΩìÂâçÂ±ÇÁöÑÊ≥®ÊÑèÂäõÁºìÂ≠ò„ÄÇ</li>
<li><strong><code>logits</code></strong>ÔºöÈ¢ÑÊµã‰∏ã‰∏Ä‰∏™ token ÁöÑÂàÜÂ∏É„ÄÇ</li>
</ul>
</li>
</ul>
<p>ËøôÊòØ‰∏Ä‰∏™Ê†áÂáÜÁöÑÂü∫‰∫é Transformer ÁöÑËØ≠Ë®ÄÊ®°ÂûãÔºåÂ∏∏Áî®‰∫éÁîüÊàê‰ªªÂä°ÊàñËØ≠Ë®ÄÂª∫Ê®°‰ªªÂä°‰∏≠ÔºàÂ¶Ç GPTÔºâ„ÄÇ</p>
<h2 id="encoder">encoder
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;Byte pair encoding utilities&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">regex</span> <span class="k">as</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@lru_cache</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bytes_to_unicode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns list of utf-8 byte and a corresponding list of unicode strings.
</span></span></span><span class="line"><span class="cl"><span class="s2">    The reversible bpe codes work on unicode strings.
</span></span></span><span class="line"><span class="cl"><span class="s2">    This means you need a large # of unicode characters in your vocab if you want to avoid UNKs.
</span></span></span><span class="line"><span class="cl"><span class="s2">    When you&#39;re at something like a 10B token dataset you end up needing around 5K for decent coverage.
</span></span></span><span class="line"><span class="cl"><span class="s2">    This is a signficant percentage of your normal, say, 32K bpe vocab.
</span></span></span><span class="line"><span class="cl"><span class="s2">    To avoid that, we want lookup tables between utf-8 bytes and unicode strings.
</span></span></span><span class="line"><span class="cl"><span class="s2">    And avoids mapping to whitespace/control characters the bpe code barfs on.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;!&#34;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;~&#34;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;¬°&#34;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;¬¨&#34;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;¬Æ&#34;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s2">&#34;√ø&#34;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">cs</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[:]</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">bs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="o">+</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">cs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">cs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_pairs</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Return set of symbol pairs in a word.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Word is represented as tuple of symbols (symbols being variable-length strings).
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pairs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">prev_char</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pairs</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">prev_char</span><span class="p">,</span> <span class="n">char</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">prev_char</span> <span class="o">=</span> <span class="n">char</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pairs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Encoder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">bpe_merges</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span> <span class="c1"># how to handle errors in decoding</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">byte_encoder</span> <span class="o">=</span> <span class="n">bytes_to_unicode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">byte_decoder</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">byte_encoder</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">bpe_ranks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bpe_merges</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bpe_merges</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Should haved added re.IGNORECASE so BPE merges can happen for capitalized versions of contractions</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;&#34;&#34;&#39;s|&#39;t|&#39;re|&#39;ve|&#39;m|&#39;ll|&#39;d| ?\p</span><span class="si">{L}</span><span class="s2">+| ?\p</span><span class="si">{N}</span><span class="s2">+| ?[^\s\p</span><span class="si">{L}</span><span class="s2">\p</span><span class="si">{N}</span><span class="s2">]+|\s+(?!\S)|\s+&#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">bpe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">word</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pairs</span> <span class="o">=</span> <span class="n">get_pairs</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">bigram</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpe_ranks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">bigram</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpe_ranks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">first</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">bigram</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_word</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">j</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_word</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_word</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">first</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">second</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_word</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_word</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_word</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_word</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">word</span> <span class="o">=</span> <span class="n">new_word</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">pairs</span> <span class="o">=</span> <span class="n">get_pairs</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">word</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">word</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">word</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">bpe_tokens</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pat</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">byte_encoder</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">bpe_tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">[</span><span class="n">bpe_token</span><span class="p">]</span> <span class="k">for</span> <span class="n">bpe_token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpe</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">bpe_tokens</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">byte_decoder</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">text</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_encoder</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">models_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="s1">&#39;encoder.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">encoder</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="s1">&#39;vocab.bpe&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">bpe_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">bpe_merges</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">merge_str</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">merge_str</span> <span class="ow">in</span> <span class="n">bpe_data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Encoder</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">encoder</span><span class="o">=</span><span class="n">encoder</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">bpe_merges</span><span class="o">=</span><span class="n">bpe_merges</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="def-bytes_to_unicode-‰∏ªË¶ÅÂäüËÉΩ">def bytes_to_unicode() <strong>‰∏ªË¶ÅÂäüËÉΩ</strong>
</h3><ul>
<li><strong>Â≠óËäÇÂà∞ Unicode ÁöÑÂèåÂêëÊò†Â∞Ñ</strong>Ôºö ËØ•ÂáΩÊï∞ÂÆûÁé∞‰∫Ü <code>utf-8</code> Â≠óËäÇÂà∞ Unicode Â≠óÁ¨¶ÁöÑÊò†Â∞ÑÔºåÁ°Æ‰øùÔºö
<ol>
<li>ÊâÄÊúâÂ∏∏ËßÅÂ≠óÁ¨¶ÈÉΩËÉΩÁõ¥Êé•Êò†Â∞Ñ„ÄÇ</li>
<li>È¢ùÂ§ñÁöÑÂ≠óËäÇÂÄºÔºàÊéßÂà∂Â≠óÁ¨¶ÊàñÁ©∫ÁôΩÂ≠óÁ¨¶Á≠âÔºâÊò†Â∞ÑÂà∞‰∏ìÁî®ÁöÑ Unicode Â≠óÁ¨¶ÔºàÈÅøÂÖç‰∏éÂ∏∏ËßÑÂ≠óÁ¨¶ÂÜ≤Á™ÅÔºâ„ÄÇ</li>
</ol>
</li>
<li><strong>Â∫îÁî®Âú∫ÊôØ</strong>Ôºö
<ul>
<li><strong>ÂàÜËØçÔºàTokenizationÔºâ</strong>Ôºö Âú®Âü∫‰∫é BPE ÁöÑÂàÜËØçÊñπÊ≥ï‰∏≠ÔºåÈÄöÂ∏∏Êìç‰ΩúÁöÑÊòØ Unicode Â≠óÁ¨¶ËÄå‰∏çÊòØÂ≠óËäÇ„ÄÇËøô‰∏™Êò†Â∞ÑË°®ÂÖÅËÆ∏Âú®Â§ÑÁêÜÊñáÊú¨Êó∂ÔºåËΩªÊùæÂú∞Â∞ÜÂ≠óËäÇË°®Á§∫‰∏é Unicode Ë°®Á§∫‰∫íÁõ∏ËΩ¨Êç¢„ÄÇ</li>
<li><strong>ÂáèÂ∞ëÊú™ÁôªÂΩïËØçÔºàUNKÔºâ</strong>Ôºö ÈÄöËøáÂ∞ÜÊâÄÊúâÂ≠óËäÇÊò†Â∞ÑÂà∞ÁâπÂÆöÁöÑ Unicode Â≠óÁ¨¶ÔºåËÉΩÂ§üÊúâÊïàÈÅøÂÖçÊú™ÁôªÂΩïËØçÔºàUNKÔºâÁöÑÈóÆÈ¢ò„ÄÇ</li>
</ul>
</li>
</ul>
<h3 id="def-get_pairsword‰∏ªË¶ÅÂäüËÉΩ">def get_pairs(word):<strong>‰∏ªË¶ÅÂäüËÉΩ</strong>
</h3><ul>
<li>Á¨¶Âè∑ÂØπÊèêÂèñÔºö
<ul>
<li>Áî®‰∫éÊèêÂèñÂçïËØç‰∏≠Áõ∏ÈÇªÁ¨¶Âè∑ÁöÑÊâÄÊúâÂèØËÉΩÁªÑÂêàÔºàÊó†ÈáçÂ§çÔºâ„ÄÇ</li>
<li>Á¨¶Âè∑ÂèØ‰ª•ÊòØÂçï‰∏™Â≠óÁ¨¶Ôºå‰πüÂèØ‰ª•ÊòØÊõ¥Â§ßÁöÑÂçï‰ΩçÔºàÂ¶ÇÂ≠óËäÇÊàñÂ≠êËØçÔºâ„ÄÇ</li>
</ul>
</li>
<li>BPE ÁÆóÊ≥ï‰∏≠ÁöÑ‰ΩúÁî®Ôºö
<ul>
<li>Âú® Byte Pair Encoding (BPE) ÂàÜËØçÁÆóÊ≥ï‰∏≠Ôºö
<ul>
<li>ÈÄöËøáÊèêÂèñÁ¨¶Âè∑ÂØπÔºåÂèØ‰ª•ÁªüËÆ°ÊØèÂØπÁ¨¶Âè∑Âá∫Áé∞ÁöÑÈ¢ëÁéá„ÄÇ</li>
<li>Ê†πÊçÆÈ¢ëÁéáÂêàÂπ∂ÊúÄÂ∏∏ËßÅÁöÑÁ¨¶Âè∑ÂØπÔºåÈÄêÊ≠•ÁîüÊàêÊñ∞ÁöÑÂ≠êËØç„ÄÇ</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>Byte Pair Encoding (BPE)</strong> ÊòØ‰∏ÄÁßçÁÆÄÂçïËÄåÈ´òÊïàÁöÑÊï∞ÊçÆÂéãÁº©ÁÆóÊ≥ïÔºåÂêåÊó∂‰πüÊòØËá™ÁÑ∂ËØ≠Ë®ÄÂ§ÑÁêÜÔºàNLPÔºâÈ¢ÜÂüü‰∏≠ÂπøÊ≥õ‰ΩøÁî®ÁöÑÂàÜËØçÊäÄÊúØ„ÄÇÂÆÉÈÄöËøáÂ∞Ü‰ΩéÁ∫ßÂçïÂÖÉÔºàÂ¶ÇÂ≠óÁ¨¶ÊàñÂ≠óËäÇÔºâÂêàÂπ∂ÊàêÊõ¥Â§ßÁöÑÂçïÂÖÉÔºàÂ¶ÇÂ≠êËØçÔºâÊù•ÂÆûÁé∞ÂéãÁº©ÊàñÂàÜËØç„ÄÇ</p>
<hr>
<h4 id="bpe-ÁöÑÊù•Ê∫ê"><strong>BPE ÁöÑÊù•Ê∫ê</strong>
</h4><ol>
<li><strong>Êï∞ÊçÆÂéãÁº©</strong>Ôºö
<ul>
<li>BPE ÊúÄÂàùÊòØÁî®‰∫éÂéãÁº©Êï∞ÊçÆÁöÑ‰∏ÄÁßçÁÆóÊ≥ïÔºàÊèêÂá∫‰∫é 1994 Âπ¥Ôºâ„ÄÇÂÆÉÈÄöËøá‰∏çÊñ≠Â∞ÜÊï∞ÊçÆ‰∏≠Âá∫Áé∞È¢ëÁéáÊúÄÈ´òÁöÑÁõ∏ÈÇªÂ≠óËäÇÂØπÂêàÂπ∂‰∏∫Êñ∞ÁöÑÂçï‰∏™Â≠óËäÇÊù•ÂáèÂ∞ëÊï¥‰ΩìÊï∞ÊçÆÈáè„ÄÇ</li>
</ul>
</li>
<li><strong>Ëá™ÁÑ∂ËØ≠Ë®ÄÂ§ÑÁêÜ‰∏≠ÁöÑÂ∫îÁî®</strong>Ôºö
<ul>
<li>Âú® NLP ‰∏≠ÔºåBPE Ë¢´Áî®‰Ωú‰∏ÄÁßç <strong>Â≠êËØçÔºàsubwordÔºâÂàÜËØçÊñπÊ≥ï</strong>„ÄÇ</li>
<li>‰º†ÁªüÁöÑÂàÜËØçÊñπÊ≥ïÔºàÂ¶ÇÂü∫‰∫éÁ©∫Ê†ºÊàñËØçÂÖ∏ÂàÜËØçÔºâÂÆπÊòìÈÅáÂà∞Êú™ÁôªÂΩïËØçÔºàOOV, Out-Of-VocabularyÔºâÈóÆÈ¢ò„ÄÇËÄå BPE ÈÄöËøáÂ∞ÜÂçïËØçÂàÜËß£ÊàêÂ≠êËØçÔºåÂèØ‰ª•ÊúâÊïàÂáèÂ∞ëÊú™ÁôªÂΩïËØçÁöÑÂá∫Áé∞ÔºåÂêåÊó∂ÊèêÈ´òÊ®°ÂûãÁöÑÊ≥õÂåñËÉΩÂäõ„ÄÇ</li>
</ul>
</li>
</ol>
<hr>
<h4 id="bpe-ÁöÑÂü∫Êú¨ÊÄùÊÉ≥"><strong>BPE ÁöÑÂü∫Êú¨ÊÄùÊÉ≥</strong>
</h4><p>BPE ÁöÑÊ†∏ÂøÉÊÄùÊÉ≥ÊòØÔºö<strong>ÊâæÂà∞Âπ∂ÂêàÂπ∂ÊñáÊú¨Êï∞ÊçÆ‰∏≠Âá∫Áé∞È¢ëÁéáÊúÄÈ´òÁöÑÁõ∏ÈÇªÁ¨¶Âè∑ÂØπÔºåÁõ¥Âà∞ËææÂà∞È¢ÑËÆæÁöÑËØçÊ±áË°®Â§ßÂ∞èÊàñÂÖ∂‰ªñÂÅúÊ≠¢Êù°‰ª∂</strong>„ÄÇ</p>
<p><strong>ÂÖ≥ÈîÆÊ≠•È™§</strong>Ôºö</p>
<ol>
<li><strong>ÂàùÂßãÂåñ</strong>Ôºö
<ul>
<li>Â∞ÜÊñáÊú¨‰∏≠ÁöÑÊØè‰∏™ÂçïËØçÊãÜÂàÜ‰∏∫Âü∫Êú¨Á¨¶Âè∑ÔºàÂ¶ÇÂ≠óÁ¨¶ÊàñÂ≠óËäÇÔºâ„ÄÇ
<ul>
<li>Á§∫‰æãÔºö<code>&quot;word&quot;</code> ‚Üí <code>['w', 'o', 'r', 'd']</code></li>
</ul>
</li>
</ul>
</li>
<li><strong>ÁªüËÆ°Á¨¶Âè∑ÂØπ</strong>Ôºö
<ul>
<li>ÊâæÂá∫ÊâÄÊúâÁõ∏ÈÇªÁ¨¶Âè∑ÂØπÔºåÂπ∂ÁªüËÆ°ÂÆÉ‰ª¨ÁöÑÈ¢ëÁéá„ÄÇ
<ul>
<li>Á§∫‰æãÔºö<code>['w', 'o', 'r', 'd']</code> ‰∏≠ÁöÑÁ¨¶Âè∑ÂØπÔºö<code>('w', 'o')</code>, <code>('o', 'r')</code>, <code>('r', 'd')</code></li>
</ul>
</li>
</ul>
</li>
<li><strong>ÂêàÂπ∂ÊúÄÈ¢ëÁπÅÁöÑÁ¨¶Âè∑ÂØπ</strong>Ôºö
<ul>
<li>ÊâæÂà∞È¢ëÁéáÊúÄÈ´òÁöÑÁ¨¶Âè∑ÂØπÔºåÂ∞ÜÂÖ∂ÂêàÂπ∂‰∏∫Êñ∞ÁöÑÁ¨¶Âè∑„ÄÇ
<ul>
<li>Á§∫‰æãÔºöÂêàÂπ∂ <code>('o', 'r')</code> ‚Üí <code>['w', 'or', 'd']</code></li>
</ul>
</li>
</ul>
</li>
<li><strong>ÈáçÂ§çÊ≠•È™§ 2 Âíå 3</strong>Ôºö
<ul>
<li>‰∏çÊñ≠ÁªüËÆ°Êñ∞ÁöÑÁ¨¶Âè∑ÂØπÂπ∂ËøõË°åÂêàÂπ∂ÔºåÁõ¥Âà∞Êª°Ë∂≥È¢ÑËÆæÊù°‰ª∂ÔºàÂ¶ÇËØçÊ±áË°®Â§ßÂ∞èËææÂà∞ÈôêÂà∂Ôºâ„ÄÇ
<ul>
<li>Á§∫‰æãÔºöÁªßÁª≠ÂêàÂπ∂ <code>('w', 'or')</code> ‚Üí <code>['wor', 'd']</code></li>
<li>ÂÜçÂêàÂπ∂ <code>('wor', 'd')</code> ‚Üí <code>['word']</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<h4 id="bpe-ÁöÑ‰ºòÁÇπ"><strong>BPE ÁöÑ‰ºòÁÇπ</strong>
</h4><ol>
<li><strong>ÂáèÂ∞ëÊú™ÁôªÂΩïËØçÔºàOOVÔºâÈóÆÈ¢ò</strong>Ôºö
<ul>
<li>Âç≥‰ΩøÈÅáÂà∞‰ªéÊú™ËßÅËøáÁöÑÂçïËØçÔºå‰πüÂèØ‰ª•Â∞ÜÂÖ∂ÂàÜËß£‰∏∫Â≠êËØçÊàñÂ≠óÁ¨¶ËøõË°åÂ§ÑÁêÜ„ÄÇ
<ul>
<li>Â¶ÇÂçïËØç <code>unbelievable</code>ÔºåÂ¶ÇÊûúÊï¥‰∏™ÂçïËØç‰∏çÂú®ËØçÊ±áË°®‰∏≠ÔºåBPE ÂèØËÉΩÂ∞ÜÂÖ∂ÂàÜËß£‰∏∫ <code>[&quot;un&quot;, &quot;believ&quot;, &quot;able&quot;]</code>„ÄÇ</li>
</ul>
</li>
</ul>
</li>
<li><strong>ÊèêÈ´òÊ®°ÂûãÊïàÁéá</strong>Ôºö
<ul>
<li>Â≠êËØçÂàÜËØçÂèØ‰ª•ÊòæËëóÂáèÂ∞ëËØçÊ±áË°®Â§ßÂ∞èÔºåÂêåÊó∂‰øùÁïôÂØπÁΩïËßÅÂçïËØçÁöÑÂ§ÑÁêÜËÉΩÂäõ„ÄÇ</li>
</ul>
</li>
<li><strong>ÈÄÇÂ∫îÂ§öËØ≠Ë®ÄÂ§ÑÁêÜ</strong>Ôºö
<ul>
<li>BPE ËÉΩÂ§üÁÅµÊ¥ªÂú∞Â§ÑÁêÜÂ≠óÁ¨¶ÂíåÂ≠êËØçÔºåÁâπÂà´ÈÄÇÁî®‰∫éÂ§öÁßçËØ≠Ë®ÄÁöÑÂàÜËØçÈúÄÊ±Ç„ÄÇ</li>
</ul>
</li>
</ol>
<hr>
<h4 id="bpe-ÁöÑÁ§∫‰æã"><strong>BPE ÁöÑÁ§∫‰æã</strong>
</h4><p>‰ª• <code>&quot;low lower lowest&quot;</code> ‰∏∫‰æãÔºåÂÅáËÆæÁõÆÊ†áÊòØÁîüÊàê BPE ËØçÊ±áË°®„ÄÇ</p>
<ol>
<li>
<p><strong>ÂàùÂßãÁä∂ÊÄÅ</strong>Ôºö</p>
<ul>
<li>Â∞ÜÂçïËØçÊãÜËß£‰∏∫Â≠óÁ¨¶Ôºö<code>['l', 'o', 'w']</code>, <code>['l', 'o', 'w', 'e', 'r']</code>, <code>['l', 'o', 'w', 'e', 's', 't']</code></li>
</ul>
</li>
<li>
<p><strong>ÁªüËÆ°Á¨¶Âè∑ÂØπÈ¢ëÁéá</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(&#39;l&#39;, &#39;o&#39;): 3
</span></span><span class="line"><span class="cl">(&#39;o&#39;, &#39;w&#39;): 3
</span></span><span class="line"><span class="cl">(&#39;w&#39;, &#39;e&#39;): 2
</span></span><span class="line"><span class="cl">(&#39;e&#39;, &#39;r&#39;): 1
</span></span><span class="line"><span class="cl">(&#39;e&#39;, &#39;s&#39;): 1
</span></span><span class="line"><span class="cl">(&#39;s&#39;, &#39;t&#39;): 1
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>ÂêàÂπ∂È¢ëÁéáÊúÄÈ´òÁöÑÁ¨¶Âè∑ÂØπ</strong>Ôºö</p>
<ul>
<li>
<p>ÂêàÂπ∂</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(&#39;l&#39;, &#39;o&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><p>‚Üí Êñ∞ÁöÑÂçïËØçÂ∫èÂàóÔºö</p>
<ul>
<li><code>['lo', 'w']</code>, <code>['lo', 'w', 'e', 'r']</code>, <code>['lo', 'w', 'e', 's', 't']</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>ÈáçÂ§çÁªüËÆ°‰∏éÂêàÂπ∂</strong>Ôºö</p>
<ul>
<li>
<p>ÂÜçÊ¨°ÁªüËÆ°Á¨¶Âè∑ÂØπÔºåÂπ∂ÂêàÂπ∂Ôºö</p>
<ul>
<li>
<p>ÂêàÂπ∂</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(&#39;lo&#39;, &#39;w&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><p>‚Üí Êñ∞ÁöÑÂçïËØçÂ∫èÂàóÔºö</p>
<ul>
<li><code>['low']</code>, <code>['low', 'e', 'r']</code>, <code>['low', 'e', 's', 't']</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>ÊúÄÁªàÔºåÂèØËÉΩÂæóÂà∞Ôºö</p>
<ul>
<li><code>['low']</code>, <code>['lower']</code>, <code>['lowest']</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<h4 id="ÂÆûÈôÖÁî®ÈÄî"><strong>ÂÆûÈôÖÁî®ÈÄî</strong>
</h4><ol>
<li><strong>ËØ≠Ë®ÄÊ®°Âûã</strong>Ôºö
<ul>
<li>‰∏ªÊµÅÈ¢ÑËÆ≠ÁªÉËØ≠Ë®ÄÊ®°ÂûãÔºàÂ¶Ç GPT„ÄÅBERTÔºâÁöÑÂàÜËØçÊñπÊ≥ïÂæÄÂæÄÂü∫‰∫é BPE ÊàñÁ±ª‰ººÊñπÊ≥ïÔºàÂ¶Ç WordPieceÔºâ„ÄÇ</li>
<li>Ëøô‰∫õÊ®°Âûã‰ºöÂü∫‰∫éÂ§ßËßÑÊ®°ËØ≠ÊñôÊûÑÂª∫‰∏Ä‰∏™Â≠êËØçËØçÊ±áË°®„ÄÇ</li>
</ul>
</li>
<li><strong>ÊñáÊú¨ÂéãÁº©</strong>Ôºö
<ul>
<li>BPE ÂèØÁî®‰∫éÂáèÂ∞ëÊï∞ÊçÆÂ≠òÂÇ®Âç†Áî®ÔºåÂ¶ÇÂú®Êï∞ÊçÆ‰º†ËæìÂíåÂ≠òÂÇ®‰ºòÂåñ‰∏≠„ÄÇ</li>
</ul>
</li>
</ol>
<hr>
<h3 id="class-encoder">class Encoder:
</h3><p>ËøôÊÆµ‰ª£Á†ÅÂÆö‰πâ‰∫Ü‰∏Ä‰∏™ <code>Encoder</code> Á±ªÔºåÁî®‰∫éÂÆûÁé∞Âü∫‰∫é <strong>Byte Pair Encoding (BPE)</strong> ÁöÑÂàÜËØçÔºàtokenizationÔºâÂíåËß£Á†ÅÔºàdetokenizationÔºâËøáÁ®ã„ÄÇÂÆÉÂú®Ëá™ÁÑ∂ËØ≠Ë®ÄÂ§ÑÁêÜ‰∏≠ÈùûÂ∏∏ÊúâÁî®ÔºåÁâπÂà´ÊòØÂú®ÊûÑÂª∫Âíå‰ΩøÁî®Âü∫‰∫éÂ≠êËØçÁöÑËØ≠Ë®ÄÊ®°ÂûãÊó∂„ÄÇ‰ª•‰∏ãÊòØ‰ª£Á†ÅÁöÑÈÄêÊ≠•Ëß£ÊûêÔºö</p>
<hr>
<h4 id="1-__init__-ÊñπÊ≥ïÂàùÂßãÂåñ"><strong>1. <code>__init__</code> ÊñπÊ≥ïÔºöÂàùÂßãÂåñ</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">bpe_merges</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>ÂèÇÊï∞</strong>Ôºö</p>
<ul>
<li><code>encoder</code>: ‰∏Ä‰∏™Êò†Â∞ÑÔºåÂ∞Ü BPE Â≠êËØçÔºàtokensÔºâÊò†Â∞ÑÂà∞ÂîØ‰∏ÄÁöÑÊï¥Êï∞ ID„ÄÇ</li>
<li><code>bpe_merges</code>: BPE ÂêàÂπ∂Êìç‰ΩúÂàóË°®ÔºåË°®Á§∫Âì™‰∫õÁ¨¶Âè∑ÂØπÂ∫îËØ•Ë¢´‰ºòÂÖàÂêàÂπ∂„ÄÇ</li>
<li><code>errors</code>: Âú®Ëß£Á†ÅËøáÁ®ã‰∏≠Â¶Ç‰ΩïÂ§ÑÁêÜÈîôËØØÔºåÈªòËÆ§‰∏∫ <code>'replace'</code>„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ÂàùÂßãÂåñÂÜÖÂÆπ</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>self.encoder</code>ÔºöÁî®‰∫éÁºñÁ†ÅÊñáÊú¨ÔºàÂ≠êËØç ‚Üí IDÔºâ„ÄÇ</li>
<li><code>self.decoder</code>ÔºöÁî®‰∫éËß£Á†ÅÊñáÊú¨ÔºàID ‚Üí Â≠êËØçÔºâÔºåÈÄöËøáÂèçËΩ¨ <code>encoder</code> ÊûÑÂª∫„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">byte_encoder</span> <span class="o">=</span> <span class="n">bytes_to_unicode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">byte_decoder</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">byte_encoder</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>self.byte_encoder</code>ÔºöÂ≠óËäÇÂà∞ Unicode Â≠óÁ¨¶ÁöÑÊò†Â∞ÑË°®Ôºà‰ΩøÁî®‰πãÂâçÂÆö‰πâÁöÑ <code>bytes_to_unicode()</code>Ôºâ„ÄÇ</li>
<li><code>self.byte_decoder</code>ÔºöÂèçÂêëÊò†Â∞ÑÔºåÁî®‰∫éÂ∞Ü Unicode Â≠óÁ¨¶ËΩ¨Êç¢ÂõûÂ≠óËäÇ„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">bpe_ranks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bpe_merges</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bpe_merges</span><span class="p">))))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Â∞Ü <code>bpe_merges</code> ËΩ¨Êç¢‰∏∫Â≠óÂÖ∏ <code>bpe_ranks</code>ÔºåÁî®Êù•Âø´ÈÄüÊü•ÊâæÁ¨¶Âè∑ÂØπÁöÑ‰ºòÂÖàÁ∫ßÔºàÈ¢ëÁéáË∂äÈ´òÔºårank Ë∂äÂ∞èÔºâ„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÁºìÂ≠òÂ≠óÂÖ∏ÔºåÁî®‰∫éÂ≠òÂÇ®Â∑≤ÁªèËÆ°ÁÆóËøáÁöÑ BPE ÂàÜËØçÁªìÊûúÔºåÈÅøÂÖçÈáçÂ§çËÆ°ÁÆó„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;&#34;&#34;&#39;s|&#39;t|&#39;re|&#39;ve|&#39;m|&#39;ll|&#39;d| ?\p</span><span class="si">{L}</span><span class="s2">+| ?\p</span><span class="si">{N}</span><span class="s2">+| ?[^\s\p</span><span class="si">{L}</span><span class="s2">\p</span><span class="si">{N}</span><span class="s2">]+|\s+(?!\S)|\s+&#34;&#34;&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂàÜËØçÊ≠£ÂàôË°®ËææÂºèÔºö
<ul>
<li>ÂåπÈÖçÂ≠êËØç„ÄÅÊï∞Â≠ó„ÄÅÊ†áÁÇπÁ¨¶Âè∑ÂíåÁ©∫Ê†º„ÄÇ</li>
<li>‰æãÂ¶ÇÔºå<code>&quot;I'm learning BPE.&quot;</code> ‰ºöË¢´ÂàÜÊàêÔºö<code>[&quot;I&quot;, &quot;'m&quot;, &quot;learning&quot;, &quot;BPE&quot;, &quot;.&quot;]</code>„ÄÇ</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="2-bpe-ÊñπÊ≥ïÊ†∏ÂøÉÁöÑ-bpe-ÂàÜËØçÈÄªËæë"><strong>2. <code>bpe</code> ÊñπÊ≥ïÔºöÊ†∏ÂøÉÁöÑ BPE ÂàÜËØçÈÄªËæë</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">bpe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>ËæìÂÖ•</strong>Ôºö‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ <code>token</code>„ÄÇ</p>
</li>
<li>
<p><strong>ÂäüËÉΩ</strong>ÔºöÂØπËæìÂÖ•ÁöÑÂ≠óÁ¨¶‰∏≤ÊâßË°å BPE Êìç‰ΩúÔºåÂ∞ÜÂÖ∂ÂàÜËß£‰∏∫ BPE Â≠êËØç„ÄÇ</p>
</li>
<li>
<p>Ê≠•È™§</p>
<p>Ôºö</p>
<ol>
<li>
<p><strong>ÁºìÂ≠òÊ£ÄÊü•</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Â¶ÇÊûú <code>token</code> Â∑≤ÁªèËÆ°ÁÆóËøáÔºåÁõ¥Êé•ËøîÂõûÁºìÂ≠òÁªìÊûú„ÄÇ</p>
</li>
<li>
<p><strong>ÂàùÂßãÂåñ</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">word</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pairs</span> <span class="o">=</span> <span class="n">get_pairs</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Â∞Ü <code>token</code> ËΩ¨Êç¢‰∏∫ÂÖÉÁªÑÔºàÂ≠óÁ¨¶Â∫èÂàóÔºâÔºå‰æãÂ¶ÇÔºö<code>&quot;low&quot;</code> ‚Üí <code>('l', 'o', 'w')</code>„ÄÇ</li>
<li>Ë∞ÉÁî® <code>get_pairs</code> ÊèêÂèñÁõ∏ÈÇªÂ≠óÁ¨¶ÂØπ„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>Âæ™ÁéØÂêàÂπ∂Á¨¶Âè∑ÂØπ</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">bigram</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpe_ranks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">bigram</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpe_ranks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÊâæÂá∫ÂΩìÂâçÁ¨¶Âè∑ÂØπ‰∏≠‰ºòÂÖàÁ∫ßÔºàrankÔºâÊúÄÈ´òÁöÑ <code>bigram</code>„ÄÇ</li>
<li>Â¶ÇÊûú <code>bigram</code> ‰∏çÂú® <code>bpe_ranks</code> ‰∏≠ÔºåÁªìÊùüÂæ™ÁéØ„ÄÇ</li>
</ul>
<p><strong>Á¨¶Âè∑ÂØπÂêàÂπ∂ÈÄªËæë</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">first</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">second</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_word</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Â¶ÇÊûúÊâæÂà∞ÂåπÈÖçÁöÑÁ¨¶Âè∑ÂØπÔºåÂêàÂπ∂Êàê‰∏Ä‰∏™Êñ∞Á¨¶Âè∑„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ÁºìÂ≠òÁªìÊûú</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">word</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">word</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Â∞ÜÂàÜËØçÁªìÊûúÂ≠òÂÖ•ÁºìÂ≠òÂπ∂ËøîÂõû„ÄÇ</li>
</ul>
</li>
</ol>
</li>
</ul>
<hr>
<h4 id="3-encode-ÊñπÊ≥ïÊñáÊú¨ÂàÜËØç"><strong>3. <code>encode</code> ÊñπÊ≥ïÔºöÊñáÊú¨ÂàÜËØç</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>ËæìÂÖ•</strong>ÔºöÂ≠óÁ¨¶‰∏≤ <code>text</code>„ÄÇ</p>
</li>
<li>
<p><strong>ÂäüËÉΩ</strong>ÔºöÂØπËæìÂÖ•ÊñáÊú¨ÊâßË°åÂàÜËØçÔºåËøîÂõûÂØπÂ∫îÁöÑ token ID ÂàóË°®„ÄÇ</p>
</li>
<li>
<p>Ê≠•È™§</p>
<p>Ôºö</p>
<ol>
<li>
<p><strong>Ê≠£ÂàôÂåπÈÖç</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pat</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰ΩøÁî® <code>self.pat</code> ÂØπÊñáÊú¨ËøõË°åÂàÜËØç„ÄÇ</p>
</li>
<li>
<p><strong>Â≠óËäÇÁºñÁ†Å</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">byte_encoder</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Â∞ÜÊØè‰∏™ÂàÜËØçËΩ¨Êç¢‰∏∫ UTF-8 Â≠óËäÇÔºåÁÑ∂ÂêéÈÄöËøá <code>byte_encoder</code> Êò†Â∞Ñ‰∏∫ Unicode Â≠óÁ¨¶„ÄÇ</p>
</li>
<li>
<p><strong>BPE ÂàÜËØç</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">bpe_tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">[</span><span class="n">bpe_token</span><span class="p">]</span> <span class="k">for</span> <span class="n">bpe_token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bpe</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Ë∞ÉÁî® <code>bpe</code> ÊñπÊ≥ïÂØπÂ≠êËØçÊâßË°å BPE Êìç‰Ωú„ÄÇ</li>
<li>Â∞ÜÁªìÊûúÊò†Â∞Ñ‰∏∫ token ID„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ËøîÂõûÁªìÊûú</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">return</span> <span class="n">bpe_tokens</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøîÂõûÊâÄÊúâ token ID ÁöÑÂàóË°®„ÄÇ</p>
</li>
</ol>
</li>
</ul>
<hr>
<h4 id="4-decode-ÊñπÊ≥ïid-Ëß£Á†Å"><strong>4. <code>decode</code> ÊñπÊ≥ïÔºöID Ëß£Á†Å</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>ËæìÂÖ•</strong>ÔºöÊï¥Êï∞ÂàóË°® <code>tokens</code>Ôºàtoken IDsÔºâ„ÄÇ</p>
</li>
<li>
<p><strong>ÂäüËÉΩ</strong>ÔºöÂ∞Ü token ID Ëß£Á†Å‰∏∫ÂéüÂßãÊñáÊú¨„ÄÇ</p>
</li>
<li>
<p>Ê≠•È™§</p>
<p>Ôºö</p>
<ol>
<li>
<p><strong>Â≠êËØçËøòÂéü</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰ΩøÁî® <code>self.decoder</code> Â∞Ü token ID Êò†Â∞ÑÂõûÂ≠êËØç„ÄÇ</p>
</li>
<li>
<p><strong>Â≠óËäÇËß£Á†Å</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">text</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">byte_decoder</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>‰ΩøÁî® <code>byte_decoder</code> Â∞Ü Unicode Â≠óÁ¨¶ËΩ¨Êç¢ÂõûÂ≠óËäÇ„ÄÇ</li>
<li>Â∞ÜÂ≠óËäÇËß£Á†Å‰∏∫ UTF-8 ÊñáÊú¨„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ËøîÂõûÁªìÊûú</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">return</span> <span class="n">text</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
</li>
</ul>
<hr>
<h3 id="def-get_encodermodel_name-models_dir">def get_encoder(model_name, models_dir)
</h3><p>ËøôÊÆµ‰ª£Á†ÅÂÆö‰πâ‰∫Ü‰∏Ä‰∏™ÂáΩÊï∞ <code>get_encoder</code>ÔºåÂÆÉÁî®‰∫éÂä†ËΩΩÂíåÂàùÂßãÂåñ‰∏Ä‰∏™ <code>Encoder</code> ÂÆû‰æãÔºåÈÄöÂ∏∏Áî®‰∫éËá™ÁÑ∂ËØ≠Ë®ÄÂ§ÑÁêÜ‰ªªÂä°Ôºà‰æãÂ¶ÇÂü∫‰∫é BPE ÁöÑÂàÜËØçÂô®Ôºâ„ÄÇ‰∏ãÈù¢ÊòØÂÖ∑‰ΩìÁöÑÂäüËÉΩÂíåÊ≠•È™§Ëß£ÊûêÔºö</p>
<hr>
<h4 id="1-ÂáΩÊï∞Á≠æÂêç"><strong>1. ÂáΩÊï∞Á≠æÂêç</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_encoder</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">models_dir</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>ÂèÇÊï∞</p>
<p>Ôºö</p>
<ul>
<li><code>model_name</code>: Ê®°ÂûãÁöÑÂêçÁß∞ÔºàÂ≠óÁ¨¶‰∏≤ÔºâÔºåË°®Á§∫ÁâπÂÆöÊ®°ÂûãÊñá‰ª∂ÊâÄÂú®ÁöÑÂ≠êÁõÆÂΩïÂêçÁß∞„ÄÇ</li>
<li><code>models_dir</code>: Â≠òÂÇ®Ê®°ÂûãÊñá‰ª∂ÁöÑ‰∏ªÁõÆÂΩïË∑ØÂæÑ„ÄÇ</li>
</ul>
</li>
<li>
<p>ËøîÂõûÂÄº</p>
<p>Ôºö</p>
<ul>
<li>ËøîÂõû‰∏Ä‰∏™ <code>Encoder</code> ÂØπË±°ÔºåÁî®‰∫éÂàÜËØçÂíåËß£Á†Å„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="2-Âä†ËΩΩ-encoderjson-Êñá‰ª∂"><strong>2. Âä†ËΩΩ <code>encoder.json</code> Êñá‰ª∂</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="s1">&#39;encoder.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoder</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>ÂäüËÉΩ</p>
<p>Ôºö</p>
<ul>
<li>ÊâìÂºÄÊ®°ÂûãÁõÆÂΩï‰∏≠ÁöÑ <code>encoder.json</code> Êñá‰ª∂„ÄÇ</li>
<li>‰ΩøÁî® <code>json.load</code> Ëß£Êûê JSON Êñá‰ª∂ÂÜÖÂÆπÔºåÂä†ËΩΩÁºñÁ†ÅÂô®Ôºà<code>encoder</code>Ôºâ„ÄÇ</li>
</ul>
</li>
<li>
<p><code>encoder.json</code> ÁöÑ‰ΩúÁî®</p>
<p>Ôºö</p>
<ul>
<li>
<p>ÊòØ‰∏Ä‰∏™ <strong>Êò†Â∞ÑÊñá‰ª∂</strong>ÔºåÂ∞ÜÊØè‰∏™Â≠êËØçÔºàBPE tokenÔºâÊò†Â∞ÑÂà∞ÂîØ‰∏ÄÁöÑÊï¥Êï∞ ID„ÄÇ</p>
</li>
<li>
<p>Ê†ºÂºèÁ§∫‰æãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hello&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;world&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;h&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ello&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="err">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<hr>
<h4 id="3-Âä†ËΩΩ-vocabbpe-Êñá‰ª∂"><strong>3. Âä†ËΩΩ <code>vocab.bpe</code> Êñá‰ª∂</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="s1">&#39;vocab.bpe&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">bpe_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>ÂäüËÉΩ</p>
<p>Ôºö</p>
<ul>
<li>ÊâìÂºÄÊ®°ÂûãÁõÆÂΩï‰∏≠ÁöÑ <code>vocab.bpe</code> Êñá‰ª∂ÔºàUTF-8 ÁºñÁ†ÅÔºâ„ÄÇ</li>
<li>‰ΩøÁî® <code>f.read()</code> ËØªÂèñÊï¥‰∏™Êñá‰ª∂ÂÜÖÂÆπÂà∞Â≠óÁ¨¶‰∏≤ <code>bpe_data</code> ‰∏≠„ÄÇ</li>
</ul>
</li>
<li>
<p><code>vocab.bpe</code> ÁöÑ‰ΩúÁî®</p>
<p>Ôºö</p>
<ul>
<li>
<p>ÊòØ‰∏Ä‰∏™ <strong>BPE ÂêàÂπ∂ËßÑÂàôÊñá‰ª∂</strong>ÔºåÂÆö‰πâ‰∫ÜÊâÄÊúâÁ¨¶Âè∑ÂØπÁöÑÂêàÂπ∂È°∫Â∫è„ÄÇ</p>
</li>
<li>
<p>Ê†ºÂºèÁ§∫‰æãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">#version: 0.2
</span></span><span class="line"><span class="cl">h e
</span></span><span class="line"><span class="cl">he llo
</span></span><span class="line"><span class="cl">lo w
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÊØèË°åË°®Á§∫‰∏Ä‰∏™Á¨¶Âè∑ÂØπÔºà‰æãÂ¶Ç <code>h e</code>Ôºâ„ÄÇ</li>
<li>Á¨¨‰∏ÄË°åÊòØÊ≥®ÈáäÔºåÈÄöÂ∏∏Ë°®Á§∫Êñá‰ª∂ÁâàÊú¨„ÄÇ</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="4-ÊèêÂèñÂêàÂπ∂ËßÑÂàô"><strong>4. ÊèêÂèñÂêàÂπ∂ËßÑÂàô</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">bpe_merges</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">merge_str</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">merge_str</span> <span class="ow">in</span> <span class="n">bpe_data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÂäüËÉΩ</strong>Ôºö
<ul>
<li>‰ªé <code>bpe_data</code> ‰∏≠ÊèêÂèñ BPE ÂêàÂπ∂ËßÑÂàôÔºåË∑≥ËøáÁ¨¨‰∏ÄË°åÊ≥®ÈáäÔºà<code>[1:]</code>Ôºâ„ÄÇ</li>
<li>‰ΩøÁî® <code>split()</code> Â∞ÜÊØèË°åÂÜÖÂÆπÂàÜÂâ≤ÊàêÁ¨¶Âè∑ÂØπÔºàÂÖÉÁªÑÔºâ„ÄÇ</li>
<li>‰æãÂ¶ÇÔºö
<ul>
<li>ËæìÂÖ•Ôºö<code>&quot;h e\nhe llo\nlo w\n&quot;</code></li>
<li>ÁªìÊûúÔºö<code>[('h', 'e'), ('he', 'llo'), ('lo', 'w')]</code></li>
</ul>
</li>
</ul>
</li>
<li><strong><code>bpe_merges</code> ÁöÑ‰ΩúÁî®</strong>Ôºö
<ul>
<li>ÂÆö‰πâ‰∫ÜÁ¨¶Âè∑ÂØπÂêàÂπ∂ÁöÑ‰ºòÂÖàÈ°∫Â∫èÔºåÁî®‰∫é BPE ÂàÜËØç„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="5-ÂàõÂª∫-encoder-ÂÆû‰æã"><strong>5. ÂàõÂª∫ <code>Encoder</code> ÂÆû‰æã</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">return</span> <span class="n">Encoder</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoder</span><span class="o">=</span><span class="n">encoder</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">bpe_merges</span><span class="o">=</span><span class="n">bpe_merges</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÂäüËÉΩ</strong>Ôºö
<ul>
<li>‰ΩøÁî® <code>encoder</code> Âíå <code>bpe_merges</code> ÂàõÂª∫‰∏Ä‰∏™ <code>Encoder</code> ÂØπË±°„ÄÇ</li>
<li>Â∞Ü <code>Encoder</code> ËøîÂõûÔºå‰ª•‰æøË∞ÉÁî®ËÄÖÂèØ‰ª•‰ΩøÁî®ÂÖ∂ <code>encode</code> Âíå <code>decode</code> ÊñπÊ≥ïËøõË°åÂàÜËØçÂíåËß£Á†Å„ÄÇ</li>
</ul>
</li>
<li><strong>ÂèÇÊï∞‰º†ÈÄíÂà∞ <code>Encoder</code> ÁöÑÂÜÖÂÆπ</strong>Ôºö
<ul>
<li><code>encoder</code>: Â∞ÜÂ≠êËØçÊò†Â∞ÑÂà∞Êï¥Êï∞ ID ÁöÑÂ≠óÂÖ∏„ÄÇ</li>
<li><code>bpe_merges</code>: BPE ÂêàÂπ∂ËßÑÂàôÔºà‰ºòÂÖàÁ∫ßÊåâÂàóË°®È°∫Â∫èÂÆö‰πâÔºâ„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="‰ª£Á†ÅÊï¥‰Ωì‰ΩúÁî®ÊÄªÁªì"><strong>‰ª£Á†ÅÊï¥‰Ωì‰ΩúÁî®ÊÄªÁªì</strong>
</h4><ul>
<li>ËæìÂÖ•Ôºö
<ul>
<li>Ê®°ÂûãÂêçÁß∞Ôºà<code>model_name</code>ÔºâÂíåÊ®°ÂûãÊñá‰ª∂ÊâÄÂú®ÁõÆÂΩïÔºà<code>models_dir</code>Ôºâ„ÄÇ</li>
</ul>
</li>
<li>ÂäüËÉΩÔºö
<ul>
<li>‰ªéÊåáÂÆöÁõÆÂΩï‰∏≠Âä†ËΩΩÔºö
<ol>
<li>Â≠êËØçÂà∞Êï¥Êï∞ ID ÁöÑÊò†Â∞ÑÊñá‰ª∂Ôºà<code>encoder.json</code>Ôºâ„ÄÇ</li>
<li>BPE ÂêàÂπ∂ËßÑÂàôÊñá‰ª∂Ôºà<code>vocab.bpe</code>Ôºâ„ÄÇ</li>
</ol>
</li>
<li>ÂàùÂßãÂåñ‰∏Ä‰∏™ <code>Encoder</code> ÂØπË±°ÔºåÂÖ∑Â§áÂàÜËØçÂíåËß£Á†ÅÂäüËÉΩ„ÄÇ</li>
</ul>
</li>
<li>ËæìÂá∫Ôºö
<ul>
<li>‰∏Ä‰∏™ÂèØ‰ª•Áõ¥Êé•Áî®‰∫éÂàÜËØçÂíåËß£Á†ÅÁöÑ <code>Encoder</code> ÂÆû‰æã„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="Â∫îÁî®Âú∫ÊôØ"><strong>Â∫îÁî®Âú∫ÊôØ</strong>
</h4><ul>
<li>
<p>Ê®°ÂûãÂàÜËØçÂàùÂßãÂåñÔºö</p>
<ul>
<li>Âú®Âü∫‰∫éÂ≠êËØçÔºàÂ¶Ç GPT„ÄÅBERTÔºâËÆ≠ÁªÉÁöÑËØ≠Ë®ÄÊ®°Âûã‰∏≠Ôºå<code>get_encoder</code> ÈÄöÂ∏∏Áî®‰∫éÂä†ËΩΩ‰∏éÊ®°ÂûãÂØπÂ∫îÁöÑÂàÜËØçÂô®„ÄÇ</li>
</ul>
</li>
<li>
<p>ÂàÜËØçÂíåËß£Á†ÅÔºö</p>
<ul>
<li>
<p>Âä†ËΩΩÂÆåÊàêÂêéÔºå</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Encoder
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂØπË±°ÂèØ‰ª•Áî®Êù•Ôºö</p>
<ul>
<li><strong>ÂàÜËØç</strong>ÔºöÂ∞ÜÊñáÊú¨ËΩ¨‰∏∫ token ID„ÄÇ</li>
<li><strong>Ëß£Á†Å</strong>ÔºöÂ∞Ü token ID ËøòÂéü‰∏∫ÊñáÊú¨„ÄÇ</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="Á§∫‰æãË∞ÉÁî®"><strong>Á§∫‰æãË∞ÉÁî®</strong>
</h4><p>ÂÅáËÆæÊ®°ÂûãÁõÆÂΩï‰∏∫ <code>&quot;models/&quot;</code>ÔºåÊ®°ÂûãÂêçÁß∞‰∏∫ <code>&quot;gpt2&quot;</code>ÔºåÊñá‰ª∂ÁªìÊûÑÂ¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">models/
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ gpt2/
</span></span><span class="line"><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ encoder.json
</span></span><span class="line"><span class="cl">‚îÇ   ‚îú‚îÄ‚îÄ vocab.bpe
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ë∞ÉÁî®‰ª£Á†ÅÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">encoder</span> <span class="o">=</span> <span class="n">get_encoder</span><span class="p">(</span><span class="s1">&#39;gpt2&#39;</span><span class="p">,</span> <span class="s1">&#39;models/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">text</span> <span class="o">=</span> <span class="s2">&#34;Hello, world!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">tokens</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>  <span class="c1"># ËæìÂá∫ÂàÜËØçÂêéÁöÑ token ID ÂàóË°®</span>
</span></span><span class="line"><span class="cl"><span class="n">decoded_text</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">decoded_text</span><span class="p">)</span>  <span class="c1"># ËæìÂá∫Ëß£Á†ÅÂêéÁöÑÂéüÂßãÊñáÊú¨</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="sample">sample
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">model</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">top_k_logits</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># no truncation</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">logits</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_top_k</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">values</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">top_k</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">min_values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">logits</span> <span class="o">&lt;</span> <span class="n">min_values</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">logits</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1e10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">logits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">       <span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">       <span class="k">lambda</span><span class="p">:</span> <span class="n">logits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="k">lambda</span><span class="p">:</span> <span class="n">_top_k</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">top_p_logits</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Nucleus sampling&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">batch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sorted_logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;DESCENDING&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cumulative_probs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">sorted_logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">indices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># number of indices to include</span>
</span></span><span class="line"><span class="cl">        <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">cumulative_probs</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">min_values</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">sorted_logits</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">&lt;</span> <span class="n">min_values</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1e10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">logits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sample_sequence</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">hparams</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">start_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">start_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Specify exactly one of start_token and context!&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Specify exactly one of start_token and context!&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">fill</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">start_token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">lm_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">tokens</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="n">past</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">logits</span> <span class="o">=</span> <span class="n">lm_output</span><span class="p">[</span><span class="s1">&#39;logits&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">hparams</span><span class="o">.</span><span class="n">n_vocab</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">presents</span> <span class="o">=</span> <span class="n">lm_output</span><span class="p">[</span><span class="s1">&#39;present&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">presents</span><span class="o">.</span><span class="n">set_shape</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">past_shape</span><span class="p">(</span><span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;logits&#39;</span><span class="p">:</span> <span class="n">logits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;presents&#39;</span><span class="p">:</span> <span class="n">presents</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;sample_sequence&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">past</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">next_outputs</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="n">past</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logits</span> <span class="o">=</span> <span class="n">next_outputs</span><span class="p">[</span><span class="s1">&#39;logits&#39;</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>  <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logits</span> <span class="o">=</span> <span class="n">top_k_logits</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">top_k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logits</span> <span class="o">=</span> <span class="n">top_p_logits</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">top_p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">samples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="n">next_outputs</span><span class="p">[</span><span class="s1">&#39;presents&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">past</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">past</span><span class="p">,</span> <span class="n">next_outputs</span><span class="p">[</span><span class="s1">&#39;presents&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">samples</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">samples</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">past</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">body</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">cond</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">cond</span><span class="o">=</span><span class="n">cond</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">maximum_iterations</span><span class="o">=</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">loop_vars</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="n">past</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">prev</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">output</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">shape_invariants</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">past_shape</span><span class="p">(</span><span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">back_prop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tokens</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÊÆµ‰ª£Á†ÅÂÆö‰πâ‰∫Ü‰∏Ä‰∏™ÂáΩÊï∞ <code>top_k_logits</code>ÔºåÁî®‰∫éÂØπ logitsÔºàÊ®°ÂûãÁöÑËæìÂá∫ÂàÜÂ∏ÉÔºâËøõË°å <strong>Top-K ÈôêÂà∂</strong>„ÄÇTop-K Á≠ñÁï•ÊòØ‰∏ÄÁßçÂú®ÁîüÊàê‰ªªÂä°ÔºàÂ¶ÇÊñáÊú¨ÁîüÊàêÔºâ‰∏≠Â∏∏Áî®ÁöÑËß£Á†ÅÊñπÊ≥ïÔºåÁî®‰∫éÈôêÂà∂ÂÄôÈÄâËæìÂá∫ÁöÑËåÉÂõ¥„ÄÇ‰∏ãÈù¢ÊòØ‰ª£Á†ÅÁöÑËØ¶ÁªÜËß£Èáä„ÄÇ</p>
<hr>
<h4 id="1-ÂáΩÊï∞Á≠æÂêç-1"><strong>1. ÂáΩÊï∞Á≠æÂêç</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">top_k_logits</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ËæìÂÖ•ÂèÇÊï∞</strong>Ôºö
<ul>
<li><code>logits</code>: Âº†ÈáèÔºàTensorÔºâÔºåÈÄöÂ∏∏ÊòØËØ≠Ë®ÄÊ®°ÂûãËæìÂá∫ÁöÑÊú™ÂΩí‰∏ÄÂåñÂàÜÂ∏ÉÔºàÂØπÊØè‰∏™ËØçÊ±áÁöÑÂàÜÊï∞Ôºâ„ÄÇ</li>
<li><code>k</code>: Êï¥Êï∞ÔºåË°®Á§∫Ë¶Å‰øùÁïôÂàÜÊï∞ÊúÄÈ´òÁöÑ <code>k</code> ‰∏™ÂÄôÈÄâÈ°π„ÄÇ</li>
</ul>
</li>
<li><strong>ËøîÂõûÂÄº</strong>Ôºö
<ul>
<li>‰∏Ä‰∏™ÁªèËøá Top-K ËøáÊª§ÁöÑ logits Âº†ÈáèÔºåÂàÜÊï∞‰Ωé‰∫éÂâç <code>k</code> ÂêçÁöÑÈ°πË¢´Â±èËîΩ‰∏∫ÈùûÂ∏∏Â∞èÁöÑÂÄºÔºà<code>-1e10</code>Ôºâ„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="2-ÁâπÊÆäÊÉÖÂÜµk0"><strong>2. ÁâπÊÆäÊÉÖÂÜµÔºök=0</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># no truncation</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">logits</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Âê´‰πâ</p>
<p>Ôºö</p>
<ul>
<li>Â¶ÇÊûú <code>k=0</code>ÔºåË°®Á§∫‰∏çËøõË°å‰ªª‰ΩïÊà™Êñ≠Êìç‰ΩúÔºåÁõ¥Êé•ËøîÂõûÂéüÂßã <code>logits</code>„ÄÇ</li>
<li>ÈÄöÂ∏∏Âú®Ëß£Á†ÅÊó∂‰ΩøÁî® <code>k=0</code> ÁöÑÊÉÖÂÜµÂæàÂ∞ë„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="3-ÂÜÖÈÉ®ÂáΩÊï∞-_top_k"><strong>3. ÂÜÖÈÉ®ÂáΩÊï∞ <code>_top_k</code></strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_top_k</span><span class="p">():</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Ëøô‰∏™ÂÜÖÈÉ®ÂáΩÊï∞ÂÆö‰πâ‰∫ÜÂÖ∑‰ΩìÁöÑ <strong>Top-K Êà™Êñ≠Êìç‰Ωú</strong>„ÄÇ</li>
<li><strong>Ê†∏ÂøÉÊ≠•È™§</strong>Ôºö</li>
</ul>
<h4 id="step-1-Ëé∑Âèñ-top-k-ÂÄôÈÄâÈ°πÁöÑÂàÜÊï∞"><strong>Step 1: Ëé∑Âèñ Top-K ÂÄôÈÄâÈ°πÁöÑÂàÜÊï∞</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">values</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">top_k</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">min_values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>‰ΩøÁî® <code>tf.nn.top_k(logits, k=k)</code>Ôºö
<ul>
<li>ËøîÂõû <code>logits</code> ‰∏≠ÊØè‰∏ÄË°åÁöÑÂâç <code>k</code> ‰∏™ÊúÄÂ§ßÂÄºÂèäÂÖ∂ÂØπÂ∫îÁ¥¢Âºï„ÄÇ</li>
<li><code>values</code> ÊòØÊØè‰∏ÄË°åÁöÑ Top-K ÂÄôÈÄâÂàÜÊï∞„ÄÇ</li>
<li><code>values[:, -1]</code> ÊòØÊØè‰∏ÄË°å‰∏≠Á¨¨ <code>k</code> Â∞èÁöÑÂàÜÊï∞ÔºàÂç≥ Top-K ÁöÑÊúÄÂ∞èÂÄºÔºâ„ÄÇ</li>
</ul>
</li>
<li><strong><code>min_values</code> ÁöÑ‰ΩúÁî®</strong>Ôºö
<ul>
<li>Â∞Ü <code>min_values</code> Êâ©Â±ïÁª¥Â∫¶ÔºàÊ∑ªÂä† <code>tf.newaxis</code>ÔºâÔºå‰ΩøÂÖ∂ÂΩ¢Áä∂‰∏é <code>logits</code> ÂÖºÂÆπÔºåÊñπ‰æøÂêéÁª≠ÊØîËæÉ„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="step-2-Â±èËîΩ‰Ωé‰∫é-top-k-ÁöÑÂàÜÊï∞"><strong>Step 2: Â±èËîΩ‰Ωé‰∫é Top-K ÁöÑÂàÜÊï∞</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">logits</span> <span class="o">&lt;</span> <span class="n">min_values</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">logits</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1e10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">logits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>tf.where</code> ÁöÑÂäüËÉΩ</strong>Ôºö
<ul>
<li>Â¶ÇÊûú <code>logits</code> Â∞è‰∫é <code>min_values</code>Ôºà‰∏çÂú® Top-K ‰∏≠ÔºâÔºåÂ∞ÜÂÖ∂ÊõøÊç¢‰∏∫ <code>-1e10</code>„ÄÇ</li>
<li>Âê¶Âàô‰øùÁïôÂéüÂßãÂàÜÊï∞„ÄÇ</li>
</ul>
</li>
<li><strong>Â±èËîΩÂàÜÊï∞‰∏∫ <code>-1e10</code> ÁöÑ‰ΩúÁî®</strong>Ôºö
<ul>
<li>Âú®ÈöèÂêéÁöÑ Softmax Êìç‰Ωú‰∏≠ÔºåËøô‰∫õÂÄºÂ∞ÜË¢´ÂΩí‰∏ÄÂåñ‰∏∫Êé•Ëøë <code>0</code> ÁöÑÊ¶ÇÁéáÔºå‰ªéËÄåÂøΩÁï•Ëøô‰∫õÂÄôÈÄâÈ°π„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="4-Êù°‰ª∂ÊâßË°å"><strong>4. Êù°‰ª∂ÊâßË°å</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">   <span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">   <span class="k">lambda</span><span class="p">:</span> <span class="n">logits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="k">lambda</span><span class="p">:</span> <span class="n">_top_k</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>tf.cond</code> ÁöÑÂäüËÉΩ</strong>Ôºö
<ul>
<li>Ê†πÊçÆÊù°‰ª∂ÊâßË°å‰∏çÂêåÁöÑÂàÜÊîØ„ÄÇ</li>
<li>Â¶ÇÊûú <code>k=0</code>ÔºåÁõ¥Êé•ËøîÂõû <code>logits</code>„ÄÇ</li>
<li>Â¶ÇÊûú <code>k&gt;0</code>ÔºåË∞ÉÁî® <code>_top_k()</code> ËøõË°å Top-K Êà™Êñ≠„ÄÇ</li>
</ul>
</li>
<li><strong>‰∏∫‰Ωï‰ΩøÁî® <code>tf.cond</code> ËÄå‰∏çÊòØÁÆÄÂçïÁöÑ <code>if-else</code></strong>Ôºü
<ul>
<li>Âú® TensorFlow ‰∏≠ÔºåÂä®ÊÄÅËÆ°ÁÆóÂõæÈúÄË¶ÅÊòéÁ°ÆÂÆö‰πâÊâßË°åÈÄªËæëÔºå<code>tf.cond</code> ÊòØÊù°‰ª∂ÂàÜÊîØÁöÑÊ†áÂáÜÊìç‰Ωú„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="5-Â∑•‰ΩúÂéüÁêÜÊÄªÁªì"><strong>5. Â∑•‰ΩúÂéüÁêÜÊÄªÁªì</strong>
</h4><ol>
<li>
<p>Â¶ÇÊûú <code>k=0</code>ÔºåÁõ¥Êé•ËøîÂõûÂéüÂßã <code>logits</code>„ÄÇ</p>
</li>
<li>
<p>Â¶ÇÊûú Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">k&gt;0
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÊâæÂá∫ÊØèË°å <code>logits</code> ‰∏≠ÁöÑÂâç <code>k</code> ‰∏™ÊúÄÂ§ßÂÄº„ÄÇ</li>
<li>Â∞Ü‰∏çÂú® Top-K ‰∏≠ÁöÑÂàÜÊï∞ÊõøÊç¢‰∏∫ <code>-1e10</code>„ÄÇ</li>
</ul>
</li>
</ol>
<hr>
<h4 id="‰ª£Á†ÅËøêË°åÁ§∫‰æã"><strong>‰ª£Á†ÅËøêË°åÁ§∫‰æã</strong>
</h4><p>ÂÅáËÆæËæìÂÖ•Â¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl"><span class="n">k</span> <span class="o">=</span> <span class="mi">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>ÊâßË°åÊ≠•È™§</strong>Ôºö</p>
<ol>
<li>Á¨¨‰∏ÄË°å logitsÔºö
<ul>
<li>Top-2 ÂÄôÈÄâÈ°π‰∏∫ <code>[2.0, 1.0]</code>„ÄÇ</li>
<li>ÂÖ∂‰ΩôÂÄºÂ±èËîΩ‰∏∫ <code>-1e10</code>„ÄÇ</li>
<li>ÁªìÊûú‰∏∫ <code>[2.0, 1.0, -1e10, -1e10]</code>„ÄÇ</li>
</ul>
</li>
<li>Á¨¨‰∫åË°å logitsÔºö
<ul>
<li>Top-2 ÂÄôÈÄâÈ°π‰∏∫ <code>[3.0, 2.5]</code>„ÄÇ</li>
<li>ÁªìÊûú‰∏∫ <code>[-1e10, 3.0, 2.5, -1e10]</code>„ÄÇ</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>ÊúÄÁªàËæìÂá∫</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">[[</span> <span class="mf">2.0</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e10</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e10</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="o">-</span><span class="mf">1e10</span><span class="p">,</span>  <span class="mf">3.0</span><span class="p">,</span>  <span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e10</span><span class="p">]]</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<hr>
<h4 id="Â∫îÁî®Âú∫ÊôØ-1"><strong>Â∫îÁî®Âú∫ÊôØ</strong>
</h4><ul>
<li><strong>ÁîüÊàê‰ªªÂä°ÔºàÂ¶ÇÊñáÊú¨ÁîüÊàê„ÄÅÊú∫Âô®ÁøªËØëÔºâ</strong>Ôºö
<ul>
<li>Áî®‰∫éÊéßÂà∂Ëß£Á†ÅÊó∂ÁöÑÂ§öÊ†∑ÊÄßÔºåÈôêÂà∂Ê®°ÂûãÂú®ÊØè‰∏ÄÊ≠•ÁîüÊàêÁöÑÂÄôÈÄâÈ°πÊï∞Èáè„ÄÇ</li>
<li>Âíå <strong>Top-P (nucleus) Êà™Êñ≠</strong> ‰∏ÄËµ∑Â∏∏Áî®‰∫éÁîüÊàê‰ºòÂåñ„ÄÇ</li>
</ul>
</li>
<li><strong>Èôç‰ΩéËÆ°ÁÆóÂ§çÊùÇÂ∫¶</strong>Ôºö
<ul>
<li>ÂØπÂÄôÈÄâÈ°πËøõË°åÊà™Êñ≠ÔºåÂáèÂ∞ëÂêéÁª≠ËÆ°ÁÆóÈáè„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<p>ËøôÊÆµ‰ª£Á†ÅÂÆûÁé∞‰∫Ü <strong>Top-p Êà™Êñ≠ÔºàNucleus SamplingÔºâ</strong>ÔºåÂÆÉÊòØ‰∏ÄÁßçÁîüÊàê‰ªªÂä°‰∏≠ÁöÑÈááÊ†∑ÊñπÊ≥ïÔºåÁ°Æ‰øùÁîüÊàêÁöÑÂàÜÂ∏É‰ªÖÂåÖÂê´Á¥ØÁßØÊ¶ÇÁéá‰∏çË∂ÖËøá <code>p</code> ÁöÑÂÄôÈÄâÈ°πÔºå‰ªéËÄåÊéßÂà∂ÁîüÊàêÂ§öÊ†∑ÊÄß„ÄÇ‰ª•‰∏ãÊòØÂØπ‰ª£Á†ÅÁöÑËØ¶ÁªÜËß£ÈáäÔºö</p>
<hr>
<h4 id="1-ÂáΩÊï∞Á≠æÂêç-2"><strong>1. ÂáΩÊï∞Á≠æÂêç</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">top_p_logits</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Nucleus sampling&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ËæìÂÖ•ÂèÇÊï∞</strong>Ôºö
<ul>
<li><code>logits</code>ÔºöÊ®°ÂûãËæìÂá∫ÁöÑÊú™ÂΩí‰∏ÄÂåñÂàÜÂ∏ÉÔºàÂØπÊØè‰∏™ËØçÊ±áÁöÑÂàÜÊï∞ÔºâÔºåÂΩ¢Áä∂‰∏∫ <code>[batch_size, vocab_size]</code>„ÄÇ</li>
<li><code>p</code>ÔºöÊµÆÁÇπÊï∞ÔºåÁ¥ØÁßØÊ¶ÇÁéáÈòàÂÄºÔºåËåÉÂõ¥‰∏∫ <code>[0, 1]</code>„ÄÇ‰æãÂ¶ÇÔºå<code>p=0.9</code> ÊÑèÂë≥ÁùÄ‰ªÖ‰øùÁïôÁ¥ØÁßØÊ¶ÇÁéáÂ∞è‰∫éÁ≠â‰∫é <code>0.9</code> ÁöÑÂÄôÈÄâÈ°π„ÄÇ</li>
</ul>
</li>
<li><strong>ËøîÂõûÂÄº</strong>Ôºö
<ul>
<li>‰∏Ä‰∏™ÁªèËøá Top-p Êà™Êñ≠ÁöÑ <code>logits</code> Âº†ÈáèÔºåÂàÜÊï∞‰Ωé‰∫éÁ¥ØÁßØÊ¶ÇÁéáÈòàÂÄº <code>p</code> ÁöÑÂÄôÈÄâÈ°πË¢´Â±èËîΩÔºàËµãÂÄº‰∏∫ <code>-1e10</code>Ôºâ„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="2-Ëé∑ÂèñËæìÂÖ•Áª¥Â∫¶"><strong>2. Ëé∑ÂèñËæìÂÖ•Áª¥Â∫¶</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">batch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">as_list</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂäüËÉΩÔºö
<ul>
<li>Ëé∑Âèñ <code>logits</code> ÁöÑÂΩ¢Áä∂Ôºå<code>batch</code> ÊòØÊâπÈáèÂ§ßÂ∞èÔºå<code>_</code> ÊòØËØçÊ±áË°®ÁöÑÂ§ßÂ∞èÔºà<code>vocab_size</code>Ôºâ„ÄÇ</li>
<li>ÂÅáËÆæËæìÂÖ• <code>logits</code> ÂΩ¢Áä∂‰∏∫ <code>[batch_size, vocab_size]</code>„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="3-ÂØπ-logits-ÊåâÂàÜÊï∞ÈôçÂ∫èÊéíÂ∫è"><strong>3. ÂØπ logits ÊåâÂàÜÊï∞ÈôçÂ∫èÊéíÂ∫è</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sorted_logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;DESCENDING&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂäüËÉΩÔºö
<ul>
<li>Êåâ <code>logits</code> ÁöÑÂàÜÊï∞ÈôçÂ∫èÊéíÂ∫èÔºàÂú®ÊúÄÂêé‰∏ÄÁª¥ÔºåÂç≥ËØçÊ±áÁª¥Â∫¶‰∏äÔºâ„ÄÇ</li>
<li><code>sorted_logits</code> ÊòØÊåâÂàÜÊï∞‰ªéÂ§ßÂà∞Â∞èÊéíÂàóÁöÑÂº†ÈáèÔºå‰∏é <code>logits</code> ÁöÑÂΩ¢Áä∂Áõ∏Âêå„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="4-ËÆ°ÁÆóÁ¥ØÁßØÊ¶ÇÁéá"><strong>4. ËÆ°ÁÆóÁ¥ØÁßØÊ¶ÇÁéá</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">cumulative_probs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">sorted_logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>Ê≠•È™§</strong>Ôºö</p>
<ol>
<li>
<p>‰ΩøÁî® <code>tf.nn.softmax</code> ÂØπ <code>sorted_logits</code> ËøõË°åÂΩí‰∏ÄÂåñÔºåÂæóÂà∞Ê¶ÇÁéáÂàÜÂ∏É„ÄÇ</p>
</li>
<li>
<p>‰ΩøÁî®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">tf.cumsum
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËÆ°ÁÆóÁ¥ØÁßØÊ¶ÇÁéáÔºàÂú®ÊúÄÂêé‰∏ÄÁª¥‰∏äÔºâ„ÄÇ</p>
<ul>
<li><strong>Á¥ØÁßØÊ¶ÇÁéá</strong>ÔºöÂØπ‰∫éÊØè‰∏™ËØçÔºåË°®Á§∫ËØ•ËØçÂèä‰πãÂâçÊâÄÊúâËØçÁöÑÊÄªÊ¶ÇÁéá„ÄÇ</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>Á§∫‰æã</strong>Ôºö ÂÅáËÆæ <code>sorted_logits</code> ÂØπÂ∫îÁöÑ Softmax Ê¶ÇÁéá‰∏∫ <code>[0.4, 0.3, 0.2, 0.1]</code>ÔºåÁ¥ØÁßØÊ¶ÇÁéá‰∏∫ <code>[0.4, 0.7, 0.9, 1.0]</code>„ÄÇ</p>
</li>
</ul>
<hr>
<h4 id="5-ÊâæÂà∞Ë∂ÖËøáÈòàÂÄº-p-ÁöÑÊúÄÂ∞èÁ¥¢Âºï"><strong>5. ÊâæÂà∞Ë∂ÖËøáÈòàÂÄº <code>p</code> ÁöÑÊúÄÂ∞èÁ¥¢Âºï</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">indices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">cumulative_probs</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÂàÜÊ≠•Ëß£Èáä"><strong>ÂàÜÊ≠•Ëß£Èáä</strong>Ôºö
</h4><ol>
<li>
<p><strong>Âà§Êñ≠Á¥ØÁßØÊ¶ÇÁéáÊòØÂê¶Â∞è‰∫éÁ≠â‰∫é <code>p</code></strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">cumulative_probs</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂØπ <code>cumulative_probs</code> ÁöÑÊØè‰∏™ÂÄºÔºåÂà§Êñ≠ÊòØÂê¶Â∞è‰∫éÁ≠â‰∫é <code>p</code>„ÄÇ</li>
<li>ÁªìÊûúÊòØ‰∏Ä‰∏™Â∏ÉÂ∞îÂÄºÁü©ÈòµÔºåËΩ¨Âåñ‰∏∫ <code>0</code>ÔºàFalseÔºâÊàñ <code>1</code>ÔºàTrueÔºâ„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ÁªüËÆ°Êª°Ë∂≥Êù°‰ª∂ÁöÑ‰∏™Êï∞</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂØπÊØè‰∏ÄË°åÔºàËØçÊ±áÁª¥Â∫¶ÔºâÁªüËÆ°Êª°Ë∂≥ <code>cumulative_probs &lt;= p</code> ÁöÑËØçÁöÑ‰∏™Êï∞„ÄÇ</li>
<li>ÁªìÊûúÊòØ‰∏Ä‰∏™ÂΩ¢Áä∂‰∏∫ <code>[batch_size]</code> ÁöÑÂº†ÈáèÔºåÊØè‰∏™ÂÄºË°®Á§∫ËØ•Ë°å‰∏≠Êª°Ë∂≥Êù°‰ª∂ÁöÑËØçÁöÑÊï∞Èáè„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ÊâæÂà∞Á¥ØÁßØÊ¶ÇÁéáË∂ÖËøá <code>p</code> ÁöÑÊúÄÂ∞èÁ¥¢Âºï</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">...</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Á¥ØÁßØÊ¶ÇÁéáÂàöË∂ÖËøá <code>p</code> ÁöÑËØçÁöÑÁ¥¢ÂºïÂ∫îËØ•ÊòØ <code>Êù°‰ª∂‰∏™Êï∞ - 1</code>„ÄÇ</li>
<li>Â¶ÇÊûúÊ≤°ÊúâËØçÊª°Ë∂≥Êù°‰ª∂ÔºàÈò≤Ê≠¢Á¥¢Âºï‰∏∫Ë¥üÊï∞ÔºâÔºåÁî® <code>tf.maximum</code> Â∞ÜÁ¥¢Âºï‰∏ãÈôêËÆæ‰∏∫ <code>0</code>„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ÁªÑÂêàÊàê‰∫åÁª¥Á¥¢Âºï</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch</span><span class="p">),</span> <span class="o">...</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂàõÂª∫ÊØè‰∏™ÊâπÊ¨°ÁöÑË°åÁ¥¢ÂºïÔºà<code>tf.range(0, batch)</code>ÔºâÂíåÂàóÁ¥¢ÂºïÔºà<code>Êù°‰ª∂‰∏™Êï∞ - 1</code>Ôºâ„ÄÇ</li>
<li><code>indices</code> ÊòØ‰∏Ä‰∏™ÂΩ¢Áä∂‰∏∫ <code>[batch_size, 2]</code> ÁöÑÂº†ÈáèÔºåÊØè‰∏™ÂÖÉÁ¥†Ë°®Á§∫ÈúÄË¶Å‰øùÁïôÁöÑÊúÄÂ§ßÂàÜÊï∞‰ΩçÁΩÆ„ÄÇ</li>
</ul>
</li>
</ol>
<hr>
<h4 id="6-ÊâæÂà∞Á¥ØÁßØÊ¶ÇÁéáÈòàÂÄºÂØπÂ∫îÁöÑÊúÄÂ∞èÂàÜÊï∞"><strong>6. ÊâæÂà∞Á¥ØÁßØÊ¶ÇÁéáÈòàÂÄºÂØπÂ∫îÁöÑÊúÄÂ∞èÂàÜÊï∞</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">min_values</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">sorted_logits</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂäüËÉΩÔºö
<ul>
<li>‰ΩøÁî® <code>indices</code> ‰ªé <code>sorted_logits</code> ‰∏≠ÊèêÂèñÁ¥ØÁßØÊ¶ÇÁéáÂàöË∂ÖËøá <code>p</code> ÁöÑÊúÄÂ∞èÂàÜÊï∞ÔºàÈòàÂÄºÂàÜÊï∞Ôºâ„ÄÇ</li>
<li><code>min_values</code> ÊòØ‰∏Ä‰∏™ÂΩ¢Áä∂‰∏∫ <code>[batch_size]</code> ÁöÑÂº†ÈáèÔºåÊØè‰∏™ÂÄºË°®Á§∫ËØ•ÊâπÊ¨°ÂØπÂ∫îÁöÑÂàÜÊï∞ÈòàÂÄº„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="7-Â±èËîΩÂàÜÊï∞‰Ωé‰∫éÈòàÂÄºÁöÑ-logits"><strong>7. Â±èËîΩÂàÜÊï∞‰Ωé‰∫éÈòàÂÄºÁöÑ logits</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">logits</span> <span class="o">&lt;</span> <span class="n">min_values</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1e10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">logits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>tf.where</code> ÁöÑÂäüËÉΩ</strong>Ôºö
<ul>
<li>Â¶ÇÊûú <code>logits</code> Â∞è‰∫é <code>min_values</code>ÔºåÂ∞ÜÂÖ∂ÊõøÊç¢‰∏∫ <code>-1e10</code>ÔºàÈùûÂ∏∏Â∞èÁöÑÂÄºÔºâ„ÄÇ</li>
<li>Âê¶Âàô‰øùÁïôÂéüÂßãÂàÜÊï∞„ÄÇ</li>
</ul>
</li>
<li><strong>ÊïàÊûú</strong>Ôºö
<ul>
<li>‰Ωé‰∫éÂàÜÊï∞ÈòàÂÄºÁöÑËØçÊ±áÂá†‰πé‰∏ç‰ºöË¢´ÈÄâ‰∏≠ÔºàÂêéÁª≠ÁöÑ Softmax ‰ºöÂ∞ÜÂÖ∂Ê¶ÇÁéáÂΩí‰∏ÄÂåñ‰∏∫Êé•Ëøë 0Ôºâ„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="‰ª£Á†ÅÊÄªÁªì"><strong>‰ª£Á†ÅÊÄªÁªì</strong>
</h4><p>ËøôÊÆµ‰ª£Á†ÅÂÆûÁé∞‰∫Ü <strong>Top-p Êà™Êñ≠ÔºàNucleus SamplingÔºâ</strong>ÔºåÊ≠•È™§Â¶Ç‰∏ãÔºö</p>
<ol>
<li>ÂØπ logits ÊåâÂàÜÊï∞ÈôçÂ∫èÊéíÂ∫è„ÄÇ</li>
<li>ËÆ°ÁÆóÊØè‰∏™ËØçÁöÑÁ¥ØÁßØÊ¶ÇÁéá„ÄÇ</li>
<li>ÊâæÂà∞ÂàöÂ•ΩÊª°Ë∂≥Á¥ØÁßØÊ¶ÇÁéá <code>‚â§ p</code> ÁöÑÂàÜÊï∞ÈòàÂÄº„ÄÇ</li>
<li>Â∞ÜÂàÜÊï∞‰Ωé‰∫éÈòàÂÄºÁöÑÂÄôÈÄâÈ°πÂ±èËîΩ‰∏∫ <code>-1e10</code>„ÄÇ</li>
</ol>
<hr>
<h4 id="‰ª£Á†ÅËøêË°åÁ§∫‰æã-1"><strong>‰ª£Á†ÅËøêË°åÁ§∫‰æã</strong>
</h4><p>ÂÅáËÆæËæìÂÖ•Â¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="mf">0.8</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÊâßË°åËøáÁ®ã"><strong>ÊâßË°åËøáÁ®ã</strong>Ôºö
</h4><ol>
<li>
<p>ÂØπ logits ÊéíÂ∫èÔºåÂæóÂà∞Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[[2.0, 1.0, 0.5, 0.1],
</span></span><span class="line"><span class="cl"> [1.5, 1.0, 0.3, 0.2]]
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ËÆ°ÁÆóÁ¥ØÁßØÊ¶ÇÁéáÔºàSoftmax + cumsumÔºâÔºå‰æãÂ¶ÇÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[[0.6, 0.9, 0.99, 1.0],
</span></span><span class="line"><span class="cl"> [0.5, 0.85, 0.98, 1.0]]
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ÈòàÂÄºÂØπÂ∫îÂàÜÊï∞‰∏∫Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[1.0, 1.0]
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Â±èËîΩÂàÜÊï∞‰Ωé‰∫éÈòàÂÄºÁöÑÈ°πÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[[2.0, 1.0, -1e10, -1e10],
</span></span><span class="line"><span class="cl"> [1.5, 1.0, -1e10, -1e10]]
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<hr>
<h4 id="Â∫îÁî®Âú∫ÊôØ-2"><strong>Â∫îÁî®Âú∫ÊôØ</strong>
</h4><ul>
<li>ÊñáÊú¨ÁîüÊàê‰ªªÂä°Ôºö
<ul>
<li>ÈôêÂà∂ÁîüÊàêËåÉÂõ¥Ôºå‰ªÖ‰øùÁïôÁ¥ØÁßØÊ¶ÇÁéáÊª°Ë∂≥ <code>p</code> ÁöÑÂÄôÈÄâÈ°πÔºåÈÅøÂÖç‰ΩéÊ¶ÇÁéáËØçÂØºËá¥ÁöÑÊó†ÊÑè‰πâÁîüÊàê„ÄÇ</li>
</ul>
</li>
<li>ÁîüÊàêÊéßÂà∂Ôºö
<ul>
<li>Top-p ËÉΩÊ†πÊçÆÊ¶ÇÁéáÂä®ÊÄÅË∞ÉÊï¥ÂÄôÈÄâÈ°πÊï∞ÈáèÔºåÊØî Top-k Êõ¥ÁÅµÊ¥ª„ÄÇ</li>
</ul>
</li>
</ul>
<p>ËøôÊÆµ‰ª£Á†ÅÂÆö‰πâ‰∫Ü‰∏Ä‰∏™ÂáΩÊï∞ <code>sample_sequence</code>ÔºåÁî®‰∫éÂú®Âü∫‰∫éËØ≠Ë®ÄÊ®°ÂûãÔºàÂ¶Ç GPT-2ÔºâÁöÑÊñáÊú¨ÁîüÊàê‰ªªÂä°‰∏≠ÔºåÈÄêÊ≠•ÁîüÊàêÂõ∫ÂÆöÈïøÂ∫¶ÁöÑÂ∫èÂàó„ÄÇ‰ª•‰∏ãÊòØÂØπ‰ª£Á†ÅÁöÑËØ¶ÁªÜËß£Êûê„ÄÇ</p>
<hr>
<h3 id="def-sample_sequence">def sample_sequence
</h3><h4 id="1-ÂáΩÊï∞Á≠æÂêçÂíåËæìÂÖ•ÂèÇÊï∞"><strong>1. ÂáΩÊï∞Á≠æÂêçÂíåËæìÂÖ•ÂèÇÊï∞</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sample_sequence</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">hparams</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">start_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>ËæìÂÖ•ÂèÇÊï∞Ôºö</p>
<ol>
<li><strong><code>hparams</code></strong>ÔºöÊ®°ÂûãÁöÑË∂ÖÂèÇÊï∞ÔºåÂåÖÂê´ËØçÊ±áÂ§ßÂ∞èÔºà<code>n_vocab</code>Ôºâ„ÄÅÈöêËóèÂ±ÇÂ§ßÂ∞èÁ≠âÈÖçÁΩÆ„ÄÇ</li>
<li><strong><code>length</code></strong>ÔºöÁîüÊàêÁöÑÂ∫èÂàóÈïøÂ∫¶ÔºàÊúÄÂ§ßËø≠‰ª£Ê¨°Êï∞Ôºâ„ÄÇ</li>
<li><strong><code>start_token</code></strong>ÔºöÊñáÊú¨ÁîüÊàêÁöÑËµ∑Âßã tokenÔºà‰∏Ä‰∏™Êï¥Êï∞Ë°®Á§∫ËØçÊ±á IDÔºâ„ÄÇ</li>
<li><strong><code>batch_size</code></strong>ÔºöÊâπÈáèÂ§ßÂ∞èÔºåÂÜ≥ÂÆö‰∫ÜÂêåÊó∂ÁîüÊàêÂ§öÂ∞ëÊù°Â∫èÂàó„ÄÇ</li>
<li><strong><code>context</code></strong>ÔºöËæìÂÖ•‰∏ä‰∏ãÊñáÂ∫èÂàóÔºåÂΩ¢Áä∂‰∏∫ <code>[batch_size, sequence_length]</code>ÔºåÂèØÈÄâ„ÄÇÂíå <code>start_token</code> ‰∫íÊñ•„ÄÇ</li>
<li><strong><code>temperature</code></strong>ÔºöÊéßÂà∂ÈááÊ†∑ÁöÑÈöèÊú∫ÊÄß„ÄÇÂÄºË∂ä‰ΩéÔºåÁîüÊàêÁöÑÊñáÊú¨Ë∂äÁ°ÆÂÆöÔºõÂÄºË∂äÈ´òÔºåÁîüÊàêÁöÑÊñáÊú¨Ë∂äÈöèÊú∫„ÄÇ</li>
<li><strong><code>top_k</code></strong>ÔºöTop-k Êà™Êñ≠Ôºå‰øùÁïôÊ¶ÇÁéáÂàÜÂ∏É‰∏≠ÂàÜÊï∞ÊúÄÈ´òÁöÑ k ‰∏™ËØç„ÄÇ</li>
<li><strong><code>top_p</code></strong>ÔºöTop-p Êà™Êñ≠ÔºàÊ†∏ÈááÊ†∑ÔºâÔºå‰øùÁïôÁ¥ØÁßØÊ¶ÇÁéáÂ∞è‰∫éÁ≠â‰∫é <code>p</code> ÁöÑËØç„ÄÇ</li>
</ol>
</li>
</ul>
<hr>
<h4 id="2-ÂèÇÊï∞È™åËØÅÂíåÂàùÂßã‰∏ä‰∏ãÊñáËÆæÁΩÆ"><strong>2. ÂèÇÊï∞È™åËØÅÂíåÂàùÂßã‰∏ä‰∏ãÊñáËÆæÁΩÆ</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="n">start_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Specify exactly one of start_token and context!&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Specify exactly one of start_token and context!&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">fill</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">start_token</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>ÈÄöËøá</p>
<p><code>start_token</code> Êàñ <code>context</code></p>
<p>ÊåáÂÆöÁîüÊàêÁöÑËµ∑ÂßãÊù°‰ª∂Ôºö</p>
<ol>
<li>Â¶ÇÊûú <code>start_token</code> Ë¢´ÊåáÂÆöÔºåÂàôÂàùÂßãÂåñ <code>context</code> ‰∏∫ <code>[batch_size, 1]</code> ÁöÑÂº†ÈáèÔºåÂÄºÂÖ®‰∏∫ <code>start_token</code>„ÄÇ</li>
<li>Â¶ÇÊûúÊ≤°ÊúâÊèê‰æõ <code>start_token</code>ÔºåÂàôÈúÄË¶ÅÊèê‰æõ <code>context</code>„ÄÇ</li>
<li>‰∫åËÄÖ‰∏çËÉΩÂêåÊó∂Â≠òÂú®„ÄÇ</li>
</ol>
</li>
</ul>
<hr>
<h4 id="3-ÂÆö‰πâÁîüÊàêÂçïÊ≠•ÁöÑÂáΩÊï∞-step"><strong>3. ÂÆö‰πâÁîüÊàêÂçïÊ≠•ÁöÑÂáΩÊï∞ <code>step</code></strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">lm_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">tokens</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="n">past</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">AUTO_REUSE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">logits</span> <span class="o">=</span> <span class="n">lm_output</span><span class="p">[</span><span class="s1">&#39;logits&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">hparams</span><span class="o">.</span><span class="n">n_vocab</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">presents</span> <span class="o">=</span> <span class="n">lm_output</span><span class="p">[</span><span class="s1">&#39;present&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">presents</span><span class="o">.</span><span class="n">set_shape</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">past_shape</span><span class="p">(</span><span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;logits&#39;</span><span class="p">:</span> <span class="n">logits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;presents&#39;</span><span class="p">:</span> <span class="n">presents</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>ÂäüËÉΩ</strong>Ôºö</p>
<ul>
<li>
<p>Ë∞ÉÁî®ËØ≠Ë®ÄÊ®°ÂûãÔºà</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">model.model
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÔºâÔºåÊ†πÊçÆÂΩìÂâçËæìÂÖ•ÁöÑ tokens ÂíåÂéÜÂè≤‰∏ä‰∏ãÊñáÔºà</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">past
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÔºâÁîüÊàêÔºö</p>
<ol>
<li><strong><code>logits</code></strong>ÔºöÊ®°ÂûãÂØπÂΩìÂâç tokens ÁöÑÈ¢ÑÊµãÂàÜÊï∞ÔºàÊú™ÂΩí‰∏ÄÂåñÔºâ„ÄÇ</li>
<li><strong><code>presents</code></strong>ÔºöÂΩìÂâçÁîüÊàêÊ≠•È™§ÁöÑÊ≥®ÊÑèÂäõÂ±ÇÁä∂ÊÄÅÔºåÁî®‰∫éÁºìÂ≠òÂéÜÂè≤‰∏ä‰∏ãÊñá‰ª•ÊèêÈ´òÁîüÊàêÊïàÁéá„ÄÇ</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>ÂÖ≥ÈîÆÁÇπ</strong>Ôºö</p>
<ol>
<li><strong><code>past</code></strong>ÔºöË°®Á§∫ÂéÜÂè≤ÁîüÊàêÊ≠•È™§ÁöÑÁºìÂ≠òÁä∂ÊÄÅÔºåÁî®‰∫éÂä†ÈÄüËá™ÂõûÂΩíÊ®°ÂûãÁöÑÁîüÊàê„ÄÇ</li>
<li><strong><code>reuse=tf.AUTO_REUSE</code></strong>ÔºöÂÖÅËÆ∏Âú® TensorFlow ‰∏≠ÈáçÁî®Ê®°ÂûãÊùÉÈáç„ÄÇ</li>
</ol>
</li>
</ul>
<hr>
<h4 id="4-ÂÆö‰πâÁîüÊàêÂæ™ÁéØÁöÑ-body-ÂáΩÊï∞"><strong>4. ÂÆö‰πâÁîüÊàêÂæ™ÁéØÁöÑ <code>body</code> ÂáΩÊï∞</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">past</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">next_outputs</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">past</span><span class="o">=</span><span class="n">past</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logits</span> <span class="o">=</span> <span class="n">next_outputs</span><span class="p">[</span><span class="s1">&#39;logits&#39;</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>  <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logits</span> <span class="o">=</span> <span class="n">top_k_logits</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">top_k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logits</span> <span class="o">=</span> <span class="n">top_p_logits</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">top_p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">samples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">next_outputs</span><span class="p">[</span><span class="s1">&#39;presents&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">past</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">past</span><span class="p">,</span> <span class="n">next_outputs</span><span class="p">[</span><span class="s1">&#39;presents&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">samples</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">output</span><span class="p">,</span> <span class="n">samples</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>ËæìÂÖ•ÂèÇÊï∞</strong>Ôºö</p>
<ol>
<li><strong><code>past</code></strong>ÔºöÁºìÂ≠òÁöÑÂéÜÂè≤‰∏ä‰∏ãÊñáÔºåÁî®‰∫éÂä†ÈÄüÁîüÊàê„ÄÇ</li>
<li><strong><code>prev</code></strong>Ôºö‰∏ä‰∏ÄÊ≠•ÁîüÊàêÁöÑ tokens„ÄÇ</li>
<li><strong><code>output</code></strong>ÔºöÂΩìÂâçÁîüÊàêÁöÑÂÆåÊï¥Â∫èÂàó„ÄÇ</li>
</ol>
</li>
<li>
<p><strong>ÂäüËÉΩÂàÜËß£</strong>Ôºö</p>
<ol>
<li>
<p>Ë∞ÉÁî® <code>step</code> Ëé∑ÂèñÂΩìÂâçÊ≠•ÁöÑ <code>logits</code> Âíå <code>presents</code>„ÄÇ</p>
</li>
<li>
<p>ÂØπ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">logits
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøõË°åÈááÊ†∑Á≠ñÁï•Ôºö</p>
<ul>
<li>Ë∞ÉÊï¥ÂàÜÂ∏ÉÈöèÊú∫ÊÄßÔºà<code>temperature</code>Ôºâ„ÄÇ</li>
<li>‰ΩøÁî® Top-k Âíå Top-p Á≠ñÁï•ÈôêÂà∂ÂÄôÈÄâÈ°π„ÄÇ</li>
<li>Ë∞ÉÁî® <code>tf.multinomial</code> ‰ªéË∞ÉÊï¥ÂêéÁöÑÂàÜÂ∏É‰∏≠ÈááÊ†∑‰∏ã‰∏Ä‰∏™ token„ÄÇ</li>
</ul>
</li>
<li>
<p>Êõ¥Êñ∞</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">past
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âíå</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">output
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÊãºÊé•ÂΩìÂâçÊ≠•ÁîüÊàêÁöÑ <code>presents</code> Âà∞ <code>past</code>„ÄÇ</li>
</ul>
</li>
</ol>
<ul>
<li>ÊãºÊé•Êñ∞ÁîüÊàêÁöÑ token Âà∞ <code>output</code>„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ËøîÂõûÂÄº</strong>Ôºö</p>
<ul>
<li>Êñ∞ÁöÑ <code>past</code>„ÄÅÂΩìÂâçÊ≠•ÁöÑÁîüÊàê token„ÄÅÊñ∞ÁöÑÁîüÊàêÂ∫èÂàó <code>output</code>„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h4 id="5-ÂàùÂßãÂåñÁ¨¨‰∏ÄÊ≠•"><strong>5. ÂàùÂßãÂåñÁ¨¨‰∏ÄÊ≠•</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">past</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">body</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÊâßË°å <code>body</code>Ôºå‰ΩøÁî® <code>context</code> ÂàùÂßãÂåñÁîüÊàêÂ∫èÂàóÔºåÂπ∂Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™ÁîüÊàêÁªìÊûú„ÄÇ</li>
</ul>
<hr>
<h4 id="6-ÂÆö‰πâÂæ™ÁéØÊù°‰ª∂Âíå‰∏ª‰Ωì"><strong>6. ÂÆö‰πâÂæ™ÁéØÊù°‰ª∂Âíå‰∏ª‰Ωì</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">cond</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">True</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Âæ™ÁéØÊù°‰ª∂ÂáΩÊï∞ <code>cond</code> ÊÄªÊòØËøîÂõû <code>True</code>ÔºåË°®Á§∫ÊåâÂõ∫ÂÆöÊ≠•Êï∞ÊâßË°åÂæ™ÁéØÔºàÁî± <code>maximum_iterations</code> ÈôêÂà∂Ôºâ„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">cond</span><span class="o">=</span><span class="n">cond</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">maximum_iterations</span><span class="o">=</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop_vars</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">past</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">prev</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">shape_invariants</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">past_shape</span><span class="p">(</span><span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">        <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">        <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">back_prop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Âæ™ÁéØÊéßÂà∂Ôºö</p>
<ol>
<li><strong><code>cond</code></strong>ÔºöÂßãÁªà‰∏∫ <code>True</code>ÔºåÂæ™ÁéØÂà∞Ëææ <code>maximum_iterations</code> ‰∏∫Ê≠¢„ÄÇ</li>
<li><strong><code>body</code></strong>ÔºöË∞ÉÁî®‰∏äËø∞ <code>body</code> ÂáΩÊï∞ÈÄêÊ≠•ÁîüÊàêÂ∫èÂàó„ÄÇ</li>
<li><strong><code>loop_vars</code></strong>ÔºöÂæ™ÁéØÁöÑÂèòÈáèÔºåÂåÖÊã¨ <code>past</code>„ÄÅ<code>prev</code>„ÄÅ<code>output</code>„ÄÇ</li>
<li><strong><code>shape_invariants</code></strong>ÔºöÊåáÂÆöÂæ™ÁéØÂèòÈáèÁöÑÂΩ¢Áä∂ÂèòÂåñËßÑÂàôÔºåÊîØÊåÅÂä®ÊÄÅÈïøÂ∫¶„ÄÇ</li>
</ol>
</li>
</ul>
<hr>
<h4 id="7-ËøîÂõûÁîüÊàêÁöÑÂ∫èÂàó"><strong>7. ËøîÂõûÁîüÊàêÁöÑÂ∫èÂàó</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">return</span> <span class="n">tokens</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÊúÄÁªàËøîÂõûÁîüÊàêÁöÑÂÆåÊï¥Â∫èÂàó <code>tokens</code>„ÄÇ</li>
</ul>
<hr>
<h4 id="Â∑•‰ΩúÊµÅÁ®ãÊÄªÁªì"><strong>Â∑•‰ΩúÊµÅÁ®ãÊÄªÁªì</strong>
</h4><ol>
<li>
<p>ÂàùÂßãÂåñ‰∏ä‰∏ãÊñáÔºà<code>context</code> Êàñ <code>start_token</code>Ôºâ„ÄÇ</p>
</li>
<li>
<p>Âú®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">tf.while_loop
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰∏≠Ôºö</p>
<ul>
<li>ÈÄêÊ≠•Ë∞ÉÁî®Ê®°ÂûãÁîüÊàê‰∏ã‰∏Ä‰∏™ token„ÄÇ</li>
<li>‰ΩøÁî®ÈááÊ†∑Á≠ñÁï•ÔºàTop-k Êàñ Top-pÔºâÁ≠õÈÄâÂÄôÈÄâËØç„ÄÇ</li>
<li>Êõ¥Êñ∞ÂéÜÂè≤‰∏ä‰∏ãÊñáÂíåÁîüÊàêÂ∫èÂàó„ÄÇ</li>
</ul>
</li>
<li>
<p>Âæ™ÁéØÊâßË°åËá≥ÁîüÊàêÈïøÂ∫¶ËææÂà∞ÊåáÂÆöÂÄºÔºåËøîÂõûÁîüÊàêÁöÑ token Â∫èÂàó„ÄÇ</p>
</li>
</ol>
<hr>
<h4 id="Â∫îÁî®Âú∫ÊôØ-3"><strong>Â∫îÁî®Âú∫ÊôØ</strong>
</h4><ol>
<li>ÊñáÊú¨ÁîüÊàêÔºö
<ul>
<li>GPT Á≥ªÂàóÊ®°Âûã‰∏≠ÁöÑÊñáÊú¨Ë°•ÂÖ®„ÄÅÂØπËØùÁîüÊàêÁ≠â„ÄÇ</li>
</ul>
</li>
<li>ÂÆöÂà∂ÈááÊ†∑Á≠ñÁï•Ôºö
<ul>
<li>Ê†πÊçÆ‰ªªÂä°Ë∞ÉÊï¥ <code>temperature</code>„ÄÅ<code>top_k</code> Âíå <code>top_p</code> ÂèÇÊï∞ÔºåÁîüÊàêÈ£éÊ†ºÂåñÊàñÊõ¥ÂêàÁêÜÁöÑÊñáÊú¨„ÄÇ</li>
</ul>
</li>
</ol>
<p>Â¶ÇÊûúÊúâÂÖ∑‰ΩìÈóÆÈ¢òÊàñÊÉ≥ËøêË°å‰ª£Á†ÅÊµãËØïÔºåÊàëÂèØ‰ª•ÂçèÂä©Ëøõ‰∏ÄÊ≠•ÂàÜÊûêÔºÅ</p>
<h2 id="generate_unconditional_samples">generate_unconditional_samples
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">fire</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">model</span><span class="o">,</span> <span class="nn">sample</span><span class="o">,</span> <span class="nn">encoder</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sample_model</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;124M&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">nsamples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">models_dir</span><span class="o">=</span><span class="s1">&#39;models&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Run the sample_model
</span></span></span><span class="line"><span class="cl"><span class="s2">    :model_name=124M : String, which model to use
</span></span></span><span class="line"><span class="cl"><span class="s2">    :seed=None : Integer seed for random number generators, fix seed to
</span></span></span><span class="line"><span class="cl"><span class="s2">     reproduce results
</span></span></span><span class="line"><span class="cl"><span class="s2">    :nsamples=0 : Number of samples to return, if 0, continues to
</span></span></span><span class="line"><span class="cl"><span class="s2">     generate samples indefinately.
</span></span></span><span class="line"><span class="cl"><span class="s2">    :batch_size=1 : Number of batches (only affects speed/memory).
</span></span></span><span class="line"><span class="cl"><span class="s2">    :length=None : Number of tokens in generated text, if None (default), is
</span></span></span><span class="line"><span class="cl"><span class="s2">     determined by model hyperparameters
</span></span></span><span class="line"><span class="cl"><span class="s2">    :temperature=1 : Float value controlling randomness in boltzmann
</span></span></span><span class="line"><span class="cl"><span class="s2">     distribution. Lower temperature results in less random completions. As the
</span></span></span><span class="line"><span class="cl"><span class="s2">     temperature approaches zero, the model will become deterministic and
</span></span></span><span class="line"><span class="cl"><span class="s2">     repetitive. Higher temperature results in more random completions.
</span></span></span><span class="line"><span class="cl"><span class="s2">    :top_k=0 : Integer value controlling diversity. 1 means only 1 word is
</span></span></span><span class="line"><span class="cl"><span class="s2">     considered for each step (token), resulting in deterministic completions,
</span></span></span><span class="line"><span class="cl"><span class="s2">     while 40 means 40 words are considered at each step. 0 (default) is a
</span></span></span><span class="line"><span class="cl"><span class="s2">     special setting meaning no restrictions. 40 generally is a good value.
</span></span></span><span class="line"><span class="cl"><span class="s2">     :models_dir : path to parent folder containing model subfolders
</span></span></span><span class="line"><span class="cl"><span class="s2">     (i.e. contains the &lt;model_name&gt; folder)
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">models_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">models_dir</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">get_encoder</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">models_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">hparams</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">default_hparams</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="s1">&#39;hparams.json&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">hparams</span><span class="o">.</span><span class="n">override_from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">length</span> <span class="o">=</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Can&#39;t get samples longer than window size: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">())</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">tf</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">output</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">sample_sequence</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">start_token</span><span class="o">=</span><span class="n">enc</span><span class="o">.</span><span class="n">encoder</span><span class="p">[</span><span class="s1">&#39;&lt;|endoftext|&gt;&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span>
</span></span><span class="line"><span class="cl">        <span class="p">)[:,</span> <span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">ckpt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">ckpt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">generated</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">nsamples</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">generated</span> <span class="o">&lt;</span> <span class="n">nsamples</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">generated</span> <span class="o">+=</span> <span class="n">batch_size</span>
</span></span><span class="line"><span class="cl">                <span class="n">text</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="s2">&#34; SAMPLE &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">fire</span><span class="o">.</span><span class="n">Fire</span><span class="p">(</span><span class="n">sample_model</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÊÆµ‰ª£Á†ÅÊòØ‰∏Ä‰∏™Áî®‰∫éÁîüÊàêÊñáÊú¨Ê†∑Êú¨ÁöÑ Python ËÑöÊú¨ÔºåÂü∫‰∫é TensorFlow ÂÆûÁé∞Ôºå‰ΩøÁî®‰∫Ü GPT Ê®°ÂûãÔºà‰æãÂ¶Ç GPT-2Ôºâ„ÄÇ‰ª•‰∏ãÊòØÂØπ‰ª£Á†ÅÁöÑÈÄêÊ≠•Ëß£ÈáäÔºö</p>
<hr>
<h3 id="1-Â§¥ÈÉ®‰ª£Á†Å">1. <strong>Â§¥ÈÉ®‰ª£Á†Å</strong>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÊòØ‰∏Ä‰∏™ shebangÔºåÁî®‰∫éÊåáÂÆöËøêË°åËÑöÊú¨ÁöÑ Python Ëß£ÈáäÂô®„ÄÇ</p>
<hr>
<h3 id="2-ÂºïÂÖ•‰æùËµñÂ∫ì">2. <strong>ÂºïÂÖ•‰æùËµñÂ∫ì</strong>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">fire</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">model</span><span class="o">,</span> <span class="nn">sample</span><span class="o">,</span> <span class="nn">encoder</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>fire</code></strong>: Áî®‰∫éËß£ÊûêÂëΩ‰ª§Ë°åÂèÇÊï∞ÔºåÂèØ‰ª•ËΩªÊùæÂú∞Â∞ÜÂáΩÊï∞Êö¥Èú≤‰∏∫ÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑„ÄÇ</li>
<li><strong><code>json</code></strong> Âíå <strong><code>os</code></strong>: Áî®‰∫éËØªÂèñÂíåÂ§ÑÁêÜÊ®°ÂûãÁöÑÈÖçÁΩÆÊñá‰ª∂ÂíåË∑ØÂæÑ„ÄÇ</li>
<li><strong><code>numpy</code></strong>: Áî®‰∫éÈöèÊú∫Êï∞ÁßçÂ≠êËÆæÂÆö„ÄÇ</li>
<li><strong><code>tensorflow</code></strong>: Áî®‰∫éÂä†ËΩΩÂíåËøêË°å TensorFlow Ê®°Âûã„ÄÇ</li>
<li><strong><code>model</code>, <code>sample</code>, <code>encoder</code></strong>: Ëá™ÂÆö‰πâÊ®°ÂùóÔºåÂàÜÂà´ÂåÖÂê´Ê®°ÂûãÂÆö‰πâ„ÄÅÈááÊ†∑ÈÄªËæëÂíåÊñáÊú¨ÁºñÁ†ÅÂô®„ÄÇ</li>
</ul>
<hr>
<h3 id="3-sample_model-ÂáΩÊï∞">3. <strong><code>sample_model</code> ÂáΩÊï∞</strong>
</h3><p>ËøôÊòØÁîüÊàêÊñáÊú¨ÁöÑÊ†∏ÂøÉÂáΩÊï∞ÔºåÊîØÊåÅÂ§öÁßçÂèÇÊï∞ÊéßÂà∂ÁîüÊàêË°å‰∏∫„ÄÇ</p>
<h4 id="ÂèÇÊï∞ËØ¥Êòé"><strong>ÂèÇÊï∞ËØ¥Êòé</strong>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sample_model</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;124M&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">nsamples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">models_dir</span><span class="o">=</span><span class="s1">&#39;models&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>model_name</code></strong>: Ê®°ÂûãÁöÑÂêçÁß∞Ôºå‰æãÂ¶Ç <code>'124M'</code>„ÄÇ</li>
<li><strong><code>seed</code></strong>: ÈöèÊú∫Êï∞ÁßçÂ≠êÔºåÂõ∫ÂÆöÁßçÂ≠ê‰ª•Ëé∑ÂæóÂèØÈáçÂ§çÁªìÊûú„ÄÇ</li>
<li><strong><code>nsamples</code></strong>: Ë¶ÅÁîüÊàêÁöÑÊ†∑Êú¨Êï∞Èáè„ÄÇÂ¶ÇÊûú‰∏∫ <code>0</code>ÔºåÂàôÊåÅÁª≠ÁîüÊàêÁõ¥Âà∞‰∏≠Êñ≠„ÄÇ</li>
<li><strong><code>batch_size</code></strong>: ÊØèÊâπÊ¨°ÁîüÊàêÁöÑÊ†∑Êú¨Êï∞Èáè„ÄÇ</li>
<li><strong><code>length</code></strong>: ÁîüÊàêÁöÑÊñáÊú¨ÈïøÂ∫¶Ôºà‰ª• token ‰∏∫Âçï‰ΩçÔºâ„ÄÇÂ¶ÇÊûú‰∏çÊåáÂÆöÔºåÂàôÈªòËÆ§‰ΩøÁî®Ê®°ÂûãÁöÑÊúÄÂ§ßÈïøÂ∫¶„ÄÇ</li>
<li><strong><code>temperature</code></strong>: ÊéßÂà∂ÁîüÊàêÊñáÊú¨ÁöÑÈöèÊú∫ÊÄß„ÄÇËæÉ‰ΩéÂÄº‰ºöÊõ¥Á°ÆÂÆöÊÄßÔºåËæÉÈ´òÂÄº‰ºöÊõ¥ÈöèÊú∫„ÄÇ</li>
<li><strong><code>top_k</code></strong>: ÈôêÂà∂ÁîüÊàêÊó∂ÁöÑÂÄôÈÄâ token Êï∞Èáè„ÄÇ<code>0</code> Ë°®Á§∫‰∏çÈôêÂà∂„ÄÇ</li>
<li><strong><code>top_p</code></strong>: ÊéßÂà∂ nucleus samplingÔºàÊ†∏ÈááÊ†∑ÔºâÁöÑÂèÇÊï∞ÔºåÈôêÂà∂ÁîüÊàêÊó∂Á¥ØËÆ°Ê¶ÇÁéáÁöÑÈòàÂÄº„ÄÇ</li>
<li><strong><code>models_dir</code></strong>: Ê®°ÂûãÊñá‰ª∂ÊâÄÂú®ÁöÑÊ†πÁõÆÂΩï„ÄÇ</li>
</ul>
<hr>
<p><strong>‰∏ªË¶ÅÈÄªËæë</strong></p>
<ol>
<li><strong>Âä†ËΩΩÊ®°ÂûãÂíåË∂ÖÂèÇÊï∞</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">models_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">models_dir</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">enc</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">get_encoder</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">models_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">hparams</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">default_hparams</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="s1">&#39;hparams.json&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">hparams</span><span class="o">.</span><span class="n">override_from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Ëß£Êûê <code>models_dir</code> Ë∑ØÂæÑÔºåÂä†ËΩΩÁºñÁ†ÅÂô®ÂíåÊ®°ÂûãÁöÑË∂ÖÂèÇÊï∞„ÄÇ</li>
<li>Ë∂ÖÂèÇÊï∞ÔºàÂ¶Ç‰∏ä‰∏ãÊñáÈïøÂ∫¶ <code>n_ctx</code>ÔºâÂ≠òÂÇ®Âú® <code>hparams.json</code> Êñá‰ª∂‰∏≠„ÄÇ</li>
</ul>
<ol>
<li><strong>È™åËØÅÊñáÊú¨ÈïøÂ∫¶</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">length</span> <span class="o">=</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Can&#39;t get samples longer than window size: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Â¶ÇÊûúÊú™ÊåáÂÆöÈïøÂ∫¶ÔºåÂàô‰ΩøÁî®Ê®°ÂûãÁöÑÈªòËÆ§ÈïøÂ∫¶ÔºàÂç≥‰∏ä‰∏ãÊñáÁ™óÂè£ÁöÑÂ§ßÂ∞èÔºâ„ÄÇ</li>
<li>Â¶ÇÊûúÊåáÂÆöÁöÑÈïøÂ∫¶Ë∂ÖËøáÊ®°ÂûãÊîØÊåÅÁöÑÁ™óÂè£Â§ßÂ∞èÔºåÂàôÊäõÂá∫ÈîôËØØ„ÄÇ</li>
</ul>
<ol>
<li><strong>ÂàõÂª∫ TensorFlow ‰ºöËØù</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">())</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tf</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Âú® TensorFlow Âõæ‰∏≠ËøêË°å‰ºöËØù„ÄÇ</li>
<li>ËÆæÁΩÆÈöèÊú∫ÁßçÂ≠ê‰ª•Á°Æ‰øùÁîüÊàêÁªìÊûúÁöÑÂèØÈáçÂ§çÊÄß„ÄÇ</li>
</ul>
<ol>
<li><strong>ÂÆö‰πâÈááÊ†∑ËøáÁ®ã</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">sample_sequence</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_token</span><span class="o">=</span><span class="n">enc</span><span class="o">.</span><span class="n">encoder</span><span class="p">[</span><span class="s1">&#39;&lt;|endoftext|&gt;&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span>
</span></span><span class="line"><span class="cl"><span class="p">)[:,</span> <span class="mi">1</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Ë∞ÉÁî® <code>sample_sequence</code> ÊñπÊ≥ïÔºåÂü∫‰∫éÊåáÂÆöÂèÇÊï∞ÁîüÊàêÊñáÊú¨Â∫èÂàó„ÄÇ</li>
<li>Ëµ∑Âßã token ‰∏∫ <code>'&lt;|endoftext|&gt;'</code>ÔºåÁî®‰∫éÊåáÁ§∫ÁîüÊàêÊó†Êù°‰ª∂ÊñáÊú¨„ÄÇ</li>
</ul>
<ol>
<li><strong>Âä†ËΩΩÊ®°ÂûãÊùÉÈáç</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">ckpt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">ckpt</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>‰ΩøÁî® TensorFlow ÁöÑ <code>Saver</code> ÂØπË±°Âä†ËΩΩÊ®°ÂûãÁöÑÊùÉÈáçÊñá‰ª∂„ÄÇ</li>
<li>Ëá™Âä®ÂØªÊâæÊúÄÊñ∞ÁöÑÊ£ÄÊü•ÁÇπÊñá‰ª∂Ôºà<code>.ckpt</code>Ôºâ„ÄÇ</li>
</ul>
<ol>
<li><strong>ÁîüÊàêÊñáÊú¨Ê†∑Êú¨</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">generated</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">nsamples</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">generated</span> <span class="o">&lt;</span> <span class="n">nsamples</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">generated</span> <span class="o">+=</span> <span class="n">batch_size</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="s2">&#34; SAMPLE &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÈÄöËøá <code>sess.run(output)</code> ÊâßË°åÈááÊ†∑Êìç‰Ωú„ÄÇ</li>
<li>‰ΩøÁî®ÁºñÁ†ÅÂô®ÁöÑ <code>decode</code> ÊñπÊ≥ïÂ∞ÜÁîüÊàêÁöÑ token Â∫èÂàóËΩ¨Êç¢‰∏∫‰∫∫Á±ªÂèØËØªÁöÑÊñáÊú¨„ÄÇ</li>
<li>ÊâìÂç∞ÁîüÊàêÁöÑÊ†∑Êú¨„ÄÇ</li>
</ul>
<hr>
<h3 id="4-‰∏ªÂáΩÊï∞">4. <strong>‰∏ªÂáΩÊï∞</strong>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">fire</span><span class="o">.</span><span class="n">Fire</span><span class="p">(</span><span class="n">sample_model</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>‰ΩøÁî® <code>fire.Fire</code> Â∞Ü <code>sample_model</code> ÂáΩÊï∞Êö¥Èú≤‰∏∫ÂëΩ‰ª§Ë°åÊé•Âè£ÔºåÂÖÅËÆ∏ÈÄöËøáÂëΩ‰ª§Ë°å‰º†ÈÄíÂèÇÊï∞Ë∞ÉÁî®„ÄÇ</li>
</ul>
<hr>
<h4 id="ËøêË°åÊñπÂºè"><strong>ËøêË°åÊñπÂºè</strong>
</h4><p>ÂÅáËÆæÊñá‰ª∂Âêç‰∏∫ <code>generate_samples.py</code>ÔºåÂú®ÂëΩ‰ª§Ë°å‰∏≠ÂèØ‰ª•ËøêË°åÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python generate_samples.py --model_name 124M --nsamples <span class="m">5</span> --length <span class="m">50</span> --temperature 0.7 --top_k <span class="m">40</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÁîüÊàê 5 ‰∏™ÈïøÂ∫¶‰∏∫ 50 ÁöÑÊ†∑Êú¨Ôºå‰ΩøÁî® <code>124M</code> Ê®°ÂûãÔºåÈááÊ†∑ÂèÇÊï∞‰∏∫ <code>temperature=0.7</code> Âíå <code>top_k=40</code>„ÄÇ</p>
<hr>
<h4 id="Ê†∏ÂøÉÊ®°Âùó"><strong>Ê†∏ÂøÉÊ®°Âùó</strong>
</h4><ol>
<li><strong><code>model</code></strong>: ÂÆö‰πâ GPT Ê®°ÂûãÁöÑÊû∂ÊûÑ„ÄÇ</li>
<li><strong><code>sample</code></strong>: ÂÆûÁé∞ÈááÊ†∑ÈÄªËæë„ÄÇ</li>
<li><strong><code>encoder</code></strong>: ÂÆûÁé∞ÊñáÊú¨ÁºñÁ†ÅÔºàÂ≠óÁ¨¶Âà∞ token ÁöÑÊò†Â∞ÑÔºâÂíåËß£Á†ÅÔºàtoken Âà∞ÊñáÊú¨ÁöÑÊò†Â∞ÑÔºâ„ÄÇ</li>
</ol>
<hr>
<h4 id="ÊÄªÁªì-2"><strong>ÊÄªÁªì</strong>
</h4><p>ËøôÊÆµ‰ª£Á†ÅÊòØ‰∏Ä‰∏™ÂÖ∏ÂûãÁöÑÊó†Êù°‰ª∂ÊñáÊú¨ÁîüÊàêËÑöÊú¨ÔºåÂÖÅËÆ∏Áî®Êà∑ÈÄöËøáË∞ÉÊï¥ÂèÇÊï∞ÁîüÊàêÈ´òË¥®ÈáèÁöÑËá™ÁÑ∂ËØ≠Ë®ÄÊñáÊú¨„ÄÇÂÆÉÂ±ïÁ§∫‰∫ÜÂ¶Ç‰ΩïÂä†ËΩΩÈ¢ÑËÆ≠ÁªÉÊ®°Âûã„ÄÅÈÖçÁΩÆË∂ÖÂèÇÊï∞Âπ∂ÊâßË°åÈááÊ†∑Êìç‰Ωú„ÄÇ</p>
<p>‚Äúshebang‚Äù ÊòØ‰∏Ä‰∏™Ëã±ËØ≠ËØçÔºåÂÆÉÁöÑ‰∏≠ÊñáÊÑèÊÄùÊòØÊåáËÑöÊú¨Êñá‰ª∂ÂºÄÂ§¥ÁöÑÈÇ£‰∏ÄË°å <code>#!/usr/bin/env python3</code>Ôºå‰πüÂè´‰Ωú**‚ÄúËß£ÈáäÂô®Êåá‰ª§‚Äù<strong>Êàñ</strong>‚ÄúÈ≠îÊ≥ïË°å‚Äù**„ÄÇ</p>
<p>ÂÖ∑‰ΩìÂê´‰πâÊòØÔºö</p>
<ul>
<li><strong><code>#!</code></strong>ÔºöË°®Á§∫ËøôÊòØ‰∏Ä‰∏™ÁâπÊÆäÁöÑÊåá‰ª§Ë°åÔºåÂëäËØâÊìç‰ΩúÁ≥ªÁªüÁî®Âì™‰∏™Á®ãÂ∫èÊù•ËøêË°åËøô‰∏™ËÑöÊú¨„ÄÇ</li>
<li><strong><code>/usr/bin/env python3</code></strong>ÔºöË°®Á§∫‰ΩøÁî®ÁéØÂ¢É‰∏≠ÊâæÂà∞ÁöÑ <code>python3</code> Ëß£ÈáäÂô®Êù•ÊâßË°åËøôÊÆµ‰ª£Á†Å„ÄÇ</li>
</ul>
<p>ÁÆÄËÄåË®Ä‰πãÔºåËøôË°å‰ª£Á†ÅÁöÑ‰ΩúÁî®ÊòØÔºö<strong>ËÆ©ËÑöÊú¨Âú® Linux Êàñ macOS Á≥ªÁªü‰∏≠ÂèØ‰ª•Áõ¥Êé•ËøêË°åÔºåËÄåÊó†ÈúÄÊâãÂä®Ë∞ÉÁî® Python„ÄÇ</strong></p>
<p>ÊØîÂ¶ÇÔºåÂ¶ÇÊûú‰∏Ä‰∏™Êñá‰ª∂Âè´ <code>script.py</code>ÔºåÂåÖÂê´Ëøô‰∏ÄË°åÔºå‰Ω†ÂèØ‰ª•Áõ¥Êé•ËøêË°åÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./script.py
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËÄå‰∏çÈúÄË¶ÅËæìÂÖ•Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python3 script.py
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="interactive_conditional_samples">interactive_conditional_samples
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">fire</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">model</span><span class="o">,</span> <span class="nn">sample</span><span class="o">,</span> <span class="nn">encoder</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">interact_model</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;124M&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">nsamples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">models_dir</span><span class="o">=</span><span class="s1">&#39;models&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Interactively run the model
</span></span></span><span class="line"><span class="cl"><span class="s2">    :model_name=124M : String, which model to use
</span></span></span><span class="line"><span class="cl"><span class="s2">    :seed=None : Integer seed for random number generators, fix seed to reproduce
</span></span></span><span class="line"><span class="cl"><span class="s2">     results
</span></span></span><span class="line"><span class="cl"><span class="s2">    :nsamples=1 : Number of samples to return total
</span></span></span><span class="line"><span class="cl"><span class="s2">    :batch_size=1 : Number of batches (only affects speed/memory).  Must divide nsamples.
</span></span></span><span class="line"><span class="cl"><span class="s2">    :length=None : Number of tokens in generated text, if None (default), is
</span></span></span><span class="line"><span class="cl"><span class="s2">     determined by model hyperparameters
</span></span></span><span class="line"><span class="cl"><span class="s2">    :temperature=1 : Float value controlling randomness in boltzmann
</span></span></span><span class="line"><span class="cl"><span class="s2">     distribution. Lower temperature results in less random completions. As the
</span></span></span><span class="line"><span class="cl"><span class="s2">     temperature approaches zero, the model will become deterministic and
</span></span></span><span class="line"><span class="cl"><span class="s2">     repetitive. Higher temperature results in more random completions.
</span></span></span><span class="line"><span class="cl"><span class="s2">    :top_k=0 : Integer value controlling diversity. 1 means only 1 word is
</span></span></span><span class="line"><span class="cl"><span class="s2">     considered for each step (token), resulting in deterministic completions,
</span></span></span><span class="line"><span class="cl"><span class="s2">     while 40 means 40 words are considered at each step. 0 (default) is a
</span></span></span><span class="line"><span class="cl"><span class="s2">     special setting meaning no restrictions. 40 generally is a good value.
</span></span></span><span class="line"><span class="cl"><span class="s2">     :models_dir : path to parent folder containing model subfolders
</span></span></span><span class="line"><span class="cl"><span class="s2">     (i.e. contains the &lt;model_name&gt; folder)
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">models_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">models_dir</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">nsamples</span> <span class="o">%</span> <span class="n">batch_size</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">enc</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">get_encoder</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">models_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">hparams</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">default_hparams</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="s1">&#39;hparams.json&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">hparams</span><span class="o">.</span><span class="n">override_from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">length</span> <span class="o">=</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span> <span class="o">//</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Can&#39;t get samples longer than window size: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">())</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">tf</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">sample_sequence</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">ckpt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">ckpt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">raw_text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Model prompt &gt;&gt;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="n">raw_text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prompt should not be empty!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">raw_text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Model prompt &gt;&gt;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">context_tokens</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">raw_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">generated</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsamples</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">context</span><span class="p">:</span> <span class="p">[</span><span class="n">context_tokens</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">                <span class="p">})[:,</span> <span class="nb">len</span><span class="p">(</span><span class="n">context_tokens</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">generated</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                    <span class="n">text</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="s2">&#34; SAMPLE &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">fire</span><span class="o">.</span><span class="n">Fire</span><span class="p">(</span><span class="n">interact_model</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÊÆµ‰ª£Á†ÅÊòØ‰∏Ä‰∏™‰∫§‰∫íÂºèËÑöÊú¨ÔºåÂÖÅËÆ∏Áî®Êà∑‰ΩøÁî®È¢ÑËÆ≠ÁªÉÁöÑ GPT Ê®°ÂûãÁîüÊàêÂü∫‰∫éÁî®Êà∑ËæìÂÖ•ÁöÑÊñáÊú¨„ÄÇÂÆÉÊèê‰æõ‰∫Ü‰∏ÄÁßçÂØπËØùÂºèÁöÑÊñπÂºèÊù•‰∏éËØ≠Ë®ÄÊ®°Âûã‰∫§‰∫íÔºå‰ª•‰∏ãÊòØËØ¶ÁªÜÁöÑÈÄêÊ≠•Ëß£ÊûêÔºö</p>
<h3 id="1-Â§¥ÈÉ®ÈÉ®ÂàÜ"><strong>1. Â§¥ÈÉ®ÈÉ®ÂàÜ</strong>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>‰ΩúÁî®</strong>: ÊåáÂÆö‰ΩøÁî® <code>python3</code> ‰Ωú‰∏∫ËÑöÊú¨ÁöÑËß£ÈáäÂô®ÔºåÊñπ‰æøÂú®Á±ª UNIX Á≥ªÁªü‰∏≠Áõ¥Êé•ËøêË°åËÑöÊú¨„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">fire</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">model</span><span class="o">,</span> <span class="nn">sample</span><span class="o">,</span> <span class="nn">encoder</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>fire</code></strong>: Â∞Ü Python ÂáΩÊï∞ËΩ¨Âåñ‰∏∫ÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑ÔºåÁî®‰∫éËß£ÊûêÂèÇÊï∞„ÄÇ</li>
<li><strong><code>json</code></strong> Âíå <strong><code>os</code></strong>: Áî®‰∫éËØªÂèñÊ®°ÂûãÈÖçÁΩÆÊñá‰ª∂ÂíåÂ§ÑÁêÜË∑ØÂæÑ„ÄÇ</li>
<li><strong><code>numpy</code></strong>: Áî®‰∫éÈöèÊú∫Êï∞ÁßçÂ≠êËÆæÂÆö„ÄÇ</li>
<li><strong><code>tensorflow</code></strong>: Áî®‰∫éÂä†ËΩΩÂíåËøêË°åÊ®°Âûã„ÄÇ</li>
<li><strong><code>model</code>, <code>sample</code>, <code>encoder</code></strong>: Ëá™ÂÆö‰πâÊ®°ÂùóÔºåÂàÜÂà´ÂåÖÂê´ GPT Ê®°ÂûãÂÆö‰πâ„ÄÅÈááÊ†∑ÈÄªËæëÂíåÁºñÁ†ÅÂô®„ÄÇ</li>
</ul>
<hr>
<h3 id="2-interact_model-ÂáΩÊï∞"><strong>2. <code>interact_model</code> ÂáΩÊï∞</strong>
</h3><p>ËØ•ÂáΩÊï∞ÊòØËÑöÊú¨ÁöÑÊ†∏ÂøÉÔºåÁî®‰∫éÂä†ËΩΩÊ®°Âûã„ÄÅÂ§ÑÁêÜÁî®Êà∑ËæìÂÖ•Âπ∂ÁîüÊàêÊñáÊú¨„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">interact_model</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;124M&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">nsamples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">temperature</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">models_dir</span><span class="o">=</span><span class="s1">&#39;models&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ÂèÇÊï∞ËØ¥Êòé</strong></p>
<ul>
<li><strong><code>model_name</code></strong>: Ê®°ÂûãÁöÑÂêçÁß∞Ôºå‰æãÂ¶Ç <code>'124M'</code>„ÄÇ</li>
<li><strong><code>seed</code></strong>: ÈöèÊú∫Êï∞ÁßçÂ≠êÔºåÂõ∫ÂÆöÂêéÂèØÈáçÂ§çÁîüÊàêÁõ∏ÂêåÁöÑÊñáÊú¨„ÄÇ</li>
<li><strong><code>nsamples</code></strong>: Ë¶ÅÁîüÊàêÁöÑÊ†∑Êú¨ÊÄªÊï∞„ÄÇ</li>
<li><strong><code>batch_size</code></strong>: ÊØèÊ¨°ÊâπÈáèÁîüÊàêÁöÑÊ†∑Êú¨Êï∞Ôºå<code>nsamples</code> ÂøÖÈ°ªÊòØ <code>batch_size</code> ÁöÑÂÄçÊï∞„ÄÇ</li>
<li><strong><code>length</code></strong>: ÊØè‰∏™ÁîüÊàêÊ†∑Êú¨ÁöÑ token Êï∞„ÄÇÂ¶ÇÊûú‰∏çÊåáÂÆöÔºåÈªòËÆ§ÂÄº‰∏∫‰∏ä‰∏ãÊñáÁ™óÂè£ÈïøÂ∫¶ÁöÑ‰∏ÄÂçä„ÄÇ</li>
<li><strong><code>temperature</code></strong>: ÊéßÂà∂ÁîüÊàêÊñáÊú¨ÁöÑÈöèÊú∫ÊÄßÔºåÂÄºË∂äÈ´òÁîüÊàêÁªìÊûúË∂äÂ§öÊ†∑Âåñ„ÄÇ</li>
<li><strong><code>top_k</code></strong>: ÈôêÂà∂ÊØèÊ≠•ÁîüÊàêÊó∂ÂÄôÈÄâ token ÁöÑÊï∞ÈáèÔºå<code>0</code> Ë°®Á§∫‰∏çÈôêÂà∂„ÄÇ</li>
<li><strong><code>top_p</code></strong>: ÊéßÂà∂ nucleus samplingÔºàÊ†∏ÈááÊ†∑ÔºâÁöÑÁ¥ØÁßØÊ¶ÇÁéáÈòàÂÄº„ÄÇ</li>
<li><strong><code>models_dir</code></strong>: Ê®°ÂûãÂ≠òÂÇ®ÁõÆÂΩï„ÄÇ</li>
</ul>
<hr>
<h3 id="3-Ê†∏ÂøÉÈÄªËæë"><strong>3. Ê†∏ÂøÉÈÄªËæë</strong>
</h3><ol>
<li><strong>Ê®°ÂûãÂíåË∂ÖÂèÇÊï∞Âä†ËΩΩ</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">models_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">models_dir</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">nsamples</span> <span class="o">%</span> <span class="n">batch_size</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">enc</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">get_encoder</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">models_dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">hparams</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">default_hparams</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="s1">&#39;hparams.json&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">hparams</span><span class="o">.</span><span class="n">override_from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Ëß£ÊûêÊ®°ÂûãÁõÆÂΩïË∑ØÂæÑÂπ∂Âä†ËΩΩÁºñÁ†ÅÂô®„ÄÇ</li>
<li>Âä†ËΩΩÊ®°ÂûãÁöÑË∂ÖÂèÇÊï∞Ôºà‰æãÂ¶Ç‰∏ä‰∏ãÊñáÁ™óÂè£Â§ßÂ∞è <code>n_ctx</code>Ôºâ„ÄÇ</li>
</ul>
<hr>
<ol>
<li><strong>È™åËØÅÂíåËÆæÁΩÆÁîüÊàêÈïøÂ∫¶</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">length</span> <span class="o">=</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span> <span class="o">//</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Can&#39;t get samples longer than window size: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">hparams</span><span class="o">.</span><span class="n">n_ctx</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Â¶ÇÊûúÊú™ÊåáÂÆöÁîüÊàêÊñáÊú¨ÁöÑÈïøÂ∫¶ÔºåÈªòËÆ§‰ΩøÁî®Ê®°Âûã‰∏ä‰∏ãÊñáÈïøÂ∫¶ÁöÑ‰∏ÄÂçä„ÄÇ</li>
<li>Â¶ÇÊûúÊåáÂÆöÈïøÂ∫¶Ë∂ÖÂá∫‰∏ä‰∏ãÊñáÁ™óÂè£Â§ßÂ∞èÔºåÂàôÊäõÂá∫ÈîôËØØ„ÄÇ</li>
</ul>
<hr>
<ol>
<li><strong>ÂàõÂª∫ TensorFlow ‰ºöËØù</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">())</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tf</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">sample_sequence</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">hparams</span><span class="o">=</span><span class="n">hparams</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="n">top_p</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ TensorFlow ÂõæÂíå‰ºöËØù„ÄÇ</li>
<li>ÂÆö‰πâÂç†‰ΩçÁ¨¶ <code>context</code>ÔºåË°®Á§∫Áî®Êà∑ËæìÂÖ•ÁöÑ token„ÄÇ</li>
<li>Ë∞ÉÁî® <code>sample_sequence</code> ÂáΩÊï∞ÔºåÊ†πÊçÆ‰∏ä‰∏ãÊñáÁîüÊàêÂ∫èÂàó„ÄÇ</li>
</ul>
<hr>
<ol>
<li><strong>Âä†ËΩΩÊ®°ÂûãÊùÉÈáç</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">ckpt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">ckpt</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>‰ΩøÁî® <code>Saver</code> ÂØπË±°Âä†ËΩΩÊ®°ÂûãÊùÉÈáç„ÄÇ</li>
<li>Ëá™Âä®ÊâæÂà∞ÊúÄÊñ∞ÁöÑÊ£ÄÊü•ÁÇπÊñá‰ª∂Ôºà<code>.ckpt</code>Ôºâ„ÄÇ</li>
</ul>
<hr>
<ol>
<li><strong>‰∫§‰∫íÂºèËæìÂÖ•‰∏éÊñáÊú¨ÁîüÊàê</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw_text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Model prompt &gt;&gt;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="ow">not</span> <span class="n">raw_text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prompt should not be empty!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">raw_text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Model prompt &gt;&gt;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">context_tokens</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">raw_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">generated</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsamples</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">:</span> <span class="p">[</span><span class="n">context_tokens</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="p">})[:,</span> <span class="nb">len</span><span class="p">(</span><span class="n">context_tokens</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">generated</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">text</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="s2">&#34; SAMPLE &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;=&#34;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ËæìÂÖ•ÈÉ®ÂàÜ</strong>:
<ul>
<li>Áî®Êà∑ËæìÂÖ• <code>raw_text</code>ÔºàÊ®°ÂûãÁöÑ‰∏ä‰∏ãÊñáÊàñÊèêÁ§∫ËØçÔºâ„ÄÇ</li>
<li>ËæìÂÖ•‰∏çËÉΩ‰∏∫Á©∫„ÄÇ</li>
</ul>
</li>
<li><strong>ÊñáÊú¨ÁîüÊàêÈÉ®ÂàÜ</strong>:
<ul>
<li>Â∞ÜËæìÂÖ•ÁöÑÊñáÊú¨ÁºñÁ†ÅÊàê tokenÔºåÂ≠òÂÇ®Âú® <code>context_tokens</code> ‰∏≠„ÄÇ</li>
<li>‰ΩøÁî® <code>sess.run(output)</code> Ë∞ÉÁî®Ê®°ÂûãÁîüÊàê token Â∫èÂàóÔºåË∑≥ËøáËæìÂÖ•ÁöÑ tokenÔºå‰ªÖËß£Á†ÅÁîüÊàêÁöÑÈÉ®ÂàÜ„ÄÇ</li>
<li>‰ΩøÁî®ÁºñÁ†ÅÂô®Ëß£Á†Å token Â∫èÂàóÔºåËΩ¨Êç¢ÊàêÂèØËØªÊñáÊú¨„ÄÇ</li>
</ul>
</li>
<li><strong>ËæìÂá∫ÈÉ®ÂàÜ</strong>:
<ul>
<li>ÊØèÁîüÊàê‰∏Ä‰∏™Ê†∑Êú¨Ôºå‰ºöÁî®ÂàÜÈöîÁ∫øÊòæÁ§∫Ê†∑Êú¨ÁºñÂè∑ÂíåÂÜÖÂÆπ„ÄÇ</li>
</ul>
</li>
</ul>
<hr>
<h3 id="6-‰∏ªÂáΩÊï∞ÈÉ®ÂàÜ"><strong>6. ‰∏ªÂáΩÊï∞ÈÉ®ÂàÜ</strong>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">fire</span><span class="o">.</span><span class="n">Fire</span><span class="p">(</span><span class="n">interact_model</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>‰ΩøÁî® <code>fire</code> Â∞Ü <code>interact_model</code> ÂáΩÊï∞ËΩ¨Âåñ‰∏∫ÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑„ÄÇ</li>
</ul>
<hr>
<h4 id="ËøêË°åÊñπÂºè-1"><strong>ËøêË°åÊñπÂºè</strong>
</h4><p>ÂÅáËÆæËÑöÊú¨Âêç‰∏∫ <code>interact.py</code>ÔºåÂèØ‰ª•ËøêË°åÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python interact.py --model_name 124M --temperature 0.8 --top_k <span class="m">40</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÁÑ∂ÂêéÔºåËæìÂÖ•ÊèêÁ§∫ËØçÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Model prompt &gt;&gt;&gt; Once upon a time,
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ê®°Âûã‰ºöÊ†πÊçÆÊèêÁ§∫ÁîüÊàêËã•Âπ≤Ê†∑Êú¨„ÄÇ</p>
<hr>
<h3 id="ÊÄªÁªì-3"><strong>ÊÄªÁªì</strong>
</h3><p>ËøôÊÆµ‰ª£Á†ÅÂÆûÁé∞‰∫Ü‰∏Ä‰∏™‰∫§‰∫íÂºèÁöÑÊñáÊú¨ÁîüÊàêÂ∑•ÂÖ∑ÔºåÂü∫‰∫é GPT Ê®°Âûã„ÄÇÁî®Êà∑Êèê‰æõËæìÂÖ•ÊèêÁ§∫ÔºåÊ®°ÂûãÁîüÊàêÂêéÁª≠ÊñáÊú¨„ÄÇÈÄöËøáË∞ÉÊï¥ <code>temperature</code>„ÄÅ<code>top_k</code> Âíå <code>top_p</code> Á≠âÂèÇÊï∞ÔºåÂèØ‰ª•ÊéßÂà∂ÁîüÊàêÁªìÊûúÁöÑÈöèÊú∫ÊÄßÂíåÂ§öÊ†∑ÊÄß„ÄÇ</p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Áõ∏ÂÖ≥ÊñáÁ´†</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E8%B0%83%E7%A0%94%E8%AE%BA%E6%96%87%E9%80%9F%E8%A7%882/">
        
        
            <div class="article-image">
                <img src="/p/%E8%B0%83%E7%A0%94%E8%AE%BA%E6%96%87%E9%80%9F%E8%A7%882/tree-3358468_1280.ae81e858c2a81b65047cc34d6475b0d8_hu12492293271762252736.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Ë∞ÉÁ†îËÆ∫ÊñáÈÄüËßà2"
                        
                        data-hash="md5-roHoWMKoG2UEfMNNZHWw2A==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Ë∞ÉÁ†îËÆ∫ÊñáÈÄüËßà2</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E7%AC%AC4%E5%91%A8%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/">
        
        
            <div class="article-image">
                <img src="/p/%E7%AC%AC4%E5%91%A8%E5%B7%A5%E4%BD%9C%E6%80%BB%E7%BB%93/colorful-2609978_1280.ff7347a9469275bbba133b27dec52763_hu9757057660502133537.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Á¨¨4Âë®Â∑•‰ΩúÊÄªÁªì"
                        
                        data-hash="md5-/3NHqUaSdbu6Ezsn3sUnYw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Á¨¨4Âë®Â∑•‰ΩúÊÄªÁªì</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/transformermodelbase/">
        
        
            <div class="article-image">
                <img src="/p/transformermodelbase/house-7497002_1280.db5d8d10c07a318d1548ccc1c8785778_hu3374130842880547652.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post transformerÊ®°ÂûãÊû∂ÊûÑ"
                        data-key="transformerModelbase" 
                        data-hash="md5-212NEMB6MY0VSMzByHhXeA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">transformerÊ®°ÂûãÊû∂ÊûÑ</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/third-week/">
        
        
            <div class="article-image">
                <img src="/p/third-week/cards-8594729_640.6d4d362b955a08c1ac2883a31f793424_hu4843113531480180974.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Á¨¨3Âë®Â∑•‰ΩúÊÄªÁªì"
                        data-key="third-week" 
                        data-hash="md5-bU02K5VaCMGsKIOjH3k0JA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Á¨¨3Âë®Â∑•‰ΩúÊÄªÁªì</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/second-week/">
        
        
            <div class="article-image">
                <img src="/p/second-week/leaves-6729056_640.d8f540d517d89998772f4150b9222cbc_hu11404399883202129121.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Á¨¨2Âë®Â∑•‰ΩúÊÄªÁªì"
                        data-key="second-week" 
                        data-hash="md5-2PVA1RfYmZh3L0FQuSIsvA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Á¨¨2Âë®Â∑•‰ΩúÊÄªÁªì</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 Zion Blaze
    </section>
    
    <section class="powerby">
        ‰ΩøÁî® <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> ÊûÑÂª∫ <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<div id="particles-js"></div>

<script src=https://JiangZhiyu-1024.github.io/background/particles.min.js></script>
<script>
  particlesJS.load('particles-js', "https://JiangZhiyu-1024.github.io/background/particlesjs-config.json", function () {
    console.log('particles.js loaded - callback');
  });
</script>
<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: -1;
  }
</style>

<style>
  @font-face {
    font-family: 'PL';
    src: url(https://JiangZhiyu-1024.github.io/font/PL.ttf) format('truetype');
  }

  :root {
    --base-font-family: 'PL';
    --code-font-family: 'PL';
  }
</style>
    </body>
</html>
